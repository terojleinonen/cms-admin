
> kin-workspace-cms@0.1.0 test:ci
> jest --ci --coverage --watchAll=false

FAIL unit-components __tests__/unit/admin/SecurityMonitoringDashboard.test.tsx (13.518 s)
  ‚óè Console

    console.error
      An update to SecurityMonitoringDashboard inside a test was not wrapped in act(...).
      
      When testing, code that causes React state updates should be wrapped into act(...):
      
      act(() => {
        /* fire events that update state */
      });
      /* assert on the output */
      
      This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at node_modules/react-dom/cjs/react-dom-client.development.js:18758:19
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at warnIfUpdatesNotWrappedWithActDEV (node_modules/react-dom/cjs/react-dom-client.development.js:18757:9)
      at scheduleUpdateOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:16409:11)
      at dispatchSetStateInternal (node_modules/react-dom/cjs/react-dom-client.development.js:9170:13)
      at dispatchSetState (node_modules/react-dom/cjs/react-dom-client.development.js:9127:7)
      at app/components/admin/SecurityMonitoringDashboard.tsx:117:7

    console.error
      An update to SecurityMonitoringDashboard inside a test was not wrapped in act(...).
      
      When testing, code that causes React state updates should be wrapped into act(...):
      
      act(() => {
        /* fire events that update state */
      });
      /* assert on the output */
      
      This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at node_modules/react-dom/cjs/react-dom-client.development.js:18758:19
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at warnIfUpdatesNotWrappedWithActDEV (node_modules/react-dom/cjs/react-dom-client.development.js:18757:9)
      at scheduleUpdateOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:16409:11)
      at dispatchSetStateInternal (node_modules/react-dom/cjs/react-dom-client.development.js:9170:13)
      at dispatchSetState (node_modules/react-dom/cjs/react-dom-client.development.js:9127:7)
      at app/components/admin/SecurityMonitoringDashboard.tsx:118:7

    console.error
      An update to SecurityMonitoringDashboard inside a test was not wrapped in act(...).
      
      When testing, code that causes React state updates should be wrapped into act(...):
      
      act(() => {
        /* fire events that update state */
      });
      /* assert on the output */
      
      This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at node_modules/react-dom/cjs/react-dom-client.development.js:18758:19
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at warnIfUpdatesNotWrappedWithActDEV (node_modules/react-dom/cjs/react-dom-client.development.js:18757:9)
      at scheduleUpdateOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:16409:11)
      at dispatchSetStateInternal (node_modules/react-dom/cjs/react-dom-client.development.js:9170:13)
      at dispatchSetState (node_modules/react-dom/cjs/react-dom-client.development.js:9127:7)
      at app/components/admin/SecurityMonitoringDashboard.tsx:122:7

    console.error
      TypeError: Cannot read properties of undefined (reading 'systemHealth')
          at SecurityMonitoringDashboard (/Users/teroleinonen/software projects/cms-admin/app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
          at Object.react_stack_bottom_frame (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
          at renderWithHooks (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
          at updateFunctionComponent (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
          at beginWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
          at runWithFiberInDEV (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
          at performUnitOfWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
          at workLoopSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
          at renderRootSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
          at performWorkOnRoot (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
          at performWorkOnRootViaSchedulerTask (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
          at performWorkUntilDeadline (/Users/teroleinonen/software projects/cms-admin/node_modules/scheduler/cjs/scheduler.development.js:45:48)
          at Timeout.task [as _onTimeout] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)
          at listOnTimeout (node:internal/timers:608:17)
          at processTimers (node:internal/timers:543:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at process.env.NODE_ENV.reportGlobalError (node_modules/react-dom/cjs/react-dom-client.development.js:25513:23)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9361:7)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

    console.warn
      An error occurred in the <SecurityMonitoringDashboard> component.
      
      Consider adding an error boundary to your tree to customize error handling behavior.
      Visit https://react.dev/link/error-boundaries to learn more about error boundaries.

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9362:15)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

    console.error
      TypeError: Cannot read properties of undefined (reading 'systemHealth')
          at SecurityMonitoringDashboard (/Users/teroleinonen/software projects/cms-admin/app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
          at Object.react_stack_bottom_frame (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
          at renderWithHooks (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
          at updateFunctionComponent (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
          at beginWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
          at runWithFiberInDEV (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
          at performUnitOfWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
          at workLoopSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
          at renderRootSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
          at performWorkOnRoot (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
          at performWorkOnRootViaSchedulerTask (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
          at performWorkUntilDeadline (/Users/teroleinonen/software projects/cms-admin/node_modules/scheduler/cjs/scheduler.development.js:45:48)
          at Timeout.task [as _onTimeout] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)
          at listOnTimeout (node:internal/timers:608:17)
          at processTimers (node:internal/timers:543:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at process.env.NODE_ENV.reportGlobalError (node_modules/react-dom/cjs/react-dom-client.development.js:25513:23)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9361:7)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

    console.warn
      An error occurred in the <SecurityMonitoringDashboard> component.
      
      Consider adding an error boundary to your tree to customize error handling behavior.
      Visit https://react.dev/link/error-boundaries to learn more about error boundaries.

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9362:15)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

    console.error
      TypeError: Cannot read properties of undefined (reading 'systemHealth')
          at SecurityMonitoringDashboard (/Users/teroleinonen/software projects/cms-admin/app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
          at Object.react_stack_bottom_frame (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
          at renderWithHooks (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
          at updateFunctionComponent (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
          at beginWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
          at runWithFiberInDEV (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
          at performUnitOfWork (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
          at workLoopSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
          at renderRootSync (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
          at performWorkOnRoot (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
          at performWorkOnRootViaSchedulerTask (/Users/teroleinonen/software projects/cms-admin/node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
          at performWorkUntilDeadline (/Users/teroleinonen/software projects/cms-admin/node_modules/scheduler/cjs/scheduler.development.js:45:48)
          at Timeout.task [as _onTimeout] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)
          at listOnTimeout (node:internal/timers:608:17)
          at processTimers (node:internal/timers:543:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at process.env.NODE_ENV.reportGlobalError (node_modules/react-dom/cjs/react-dom-client.development.js:25513:23)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9361:7)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

    console.warn
      An error occurred in the <SecurityMonitoringDashboard> component.
      
      Consider adding an error boundary to your tree to customize error handling behavior.
      Visit https://react.dev/link/error-boundaries to learn more about error boundaries.

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at defaultOnUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9362:15)
      at logUncaughtError (node_modules/react-dom/cjs/react-dom-client.development.js:9431:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at lane.callback (node_modules/react-dom/cjs/react-dom-client.development.js:9461:9)
      at callCallback (node_modules/react-dom/cjs/react-dom-client.development.js:7423:16)
      at commitCallbacks (node_modules/react-dom/cjs/react-dom-client.development.js:7443:11)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitLayoutEffectOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:14047:15)
      at flushLayoutEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18138:15)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17954:9)
      at commitRootWhenReady (node_modules/react-dom/cjs/react-dom-client.development.js:16824:7)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16722:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ renders security monitoring dashboard

    TestingLibraryElementError: Unable to find an element with the text: Security Monitoring. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to make your matcher more flexible.

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<div[39m
          [33mclass[39m=[32m"flex items-center justify-center h-64"[39m
        [36m>[39m
          [36m<div[39m
            [33maria-label[39m=[32m"Loading"[39m
            [33mclass[39m=[32m"animate-spin rounded-full border-2 h-8 w-8 border-gray-300 border-t-blue-600 "[39m
            [33mrole[39m=[32m"status"[39m
          [36m/>[39m
        [36m</div>[39m
      [36m</div>[39m
    [36m</body>[39m

      106 |     render(<SecurityMonitoringDashboard />);
      107 |     
    > 108 |     expect(screen.getByText('Security Monitoring')).toBeInTheDocument();
          |                   ^
      109 |     expect(screen.getByText('Real-time security event monitoring and threat detection')).toBeInTheDocument();
      110 |   });
      111 |

      at Object.getElementError (node_modules/@testing-library/dom/dist/config.js:37:19)
      at node_modules/@testing-library/dom/dist/query-helpers.js:76:38
      at node_modules/@testing-library/dom/dist/query-helpers.js:52:17
      at node_modules/@testing-library/dom/dist/query-helpers.js:95:19
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:108:19)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ displays summary cards with correct data

    Found multiple elements with the text: 5

    Here are the matching elements:

    Ignored nodes: comments, script, style
    [36m<p[39m
      [33mclass[39m=[32m"text-2xl font-semibold text-gray-900"[39m
    [36m>[39m
      [0m5[0m
    [36m</p>[39m

    Ignored nodes: comments, script, style
    [36m<span[39m
      [33mclass[39m=[32m"text-sm font-medium text-gray-900 w-8 text-right"[39m
    [36m>[39m
      [0m5[0m
    [36m</span>[39m

    (If this is intentional, then use the `*AllBy*` variant of the query (like `queryAllByText`, `getAllByText`, or `findAllByText`)).

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<div[39m
          [33mclass[39m=[32m"space-y-6"[39m
        [36m>[39m
          [36m<div[39m
            [33mclass[39m=[32m"flex items-center justify-between"[39m
          [36m>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center space-x-4"[39m
            [36m>[39m
              [36m<div>[39m
                [36m<h1[39m
                  [33mclass[39m=[32m"text-2xl font-bold text-gray-900"[39m
                [36m>[39m
                  [0mSecurity Monitoring[0m
                [36m</h1>[39m
                [36m<p[39m
                  [33mclass[39m=[32m"text-gray-600"[39m
                [36m>[39m
                  [0mReal-time security event monitoring and threat detection[0m
                [36m</p>[39m
              [36m</div>[39m
              [36m<div[39m
                [33mclass[39m=[32m"flex items-center space-x-2"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"w-3 h-3 rounded-full bg-green-500"[39m
                [36m/>[39m
                [36m<span[39m
                  [33mclass[39m=[32m"text-sm font-medium text-green-700"[39m
                [36m>[39m
                  [0mHEALTHY[0m
                [36m</span>[39m
              [36m</div>[39m
            [36m</div>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center space-x-4"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"inline-flex items-center justify-center font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 undefined px-3 py-1.5 text-sm  flex items-center space-x-2"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M15.75 5.25v13.5m-7.5-13.5v13.5"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mPause[0m
                  [0m Live[0m
                [36m</span>[39m
              [36m</button>[39m
              [36m<select[39m
                [33mclass[39m=[32m"rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"[39m
              [36m>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"1"[39m
                [36m>[39m
                  [0mLast 24 hours[0m
                [36m</option>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"7"[39m
                [36m>[39m
                  [0mLast 7 days[0m
                [36m</option>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"30"[39m
                [36m>[39m
                  [0mLast 30 days[0m
                [36m</option>[39m
              [36m</select>[39m
              [36m<button[39m
                [33mclass[39m=[32m"inline-flex items-center justify-center font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-blue-500 disabled:bg-gray-50 disabled:text-gray-400 px-3 py-1.5 text-sm  flex items-center space-x-2"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mRefresh[0m
                [36m</span>[39m
              [36m</button>[39m
            [36m</div>[39m
          [36m</div>[39m
          [36m<div[39m
            [33mclass[39m=[32m"border-b border-gray-200"[39m
          [36m>[39m
            [36m<nav[39m
              [33mclass[39m=[32m"-mb-px flex space-x-8"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mOverview[0m
                [36m</span>[39m
              [36m</button>[39m
              [36m<button[39m
                [33mclass[39m=[32m"flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32...

      113 |     render(<SecurityMonitoringDashboard />);
      114 |     
    > 115 |     await waitFor(() => {
          |                  ^
      116 |       expect(screen.getByText('150')).toBeInTheDocument(); // Total Events
      117 |       expect(screen.getByText('5')).toBeInTheDocument(); // Critical Events
      118 |       expect(screen.getByText('12')).toBeInTheDocument(); // Unresolved

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:115:18)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ displays recent security events

    Found multiple elements with the text: Unauthorized Access

    Here are the matching elements:

    Ignored nodes: comments, script, style
    [36m<span[39m
      [33mclass[39m=[32m"text-sm text-gray-600"[39m
    [36m>[39m
      [0mUnauthorized Access[0m
    [36m</span>[39m

    Ignored nodes: comments, script, style
    [36m<button[39m
      [33mclass[39m=[32m"ml-2 text-sm text-blue-600 hover:text-blue-800"[39m
    [36m>[39m
      [0mUnauthorized Access[0m
    [36m</button>[39m

    (If this is intentional, then use the `*AllBy*` variant of the query (like `queryAllByText`, `getAllByText`, or `findAllByText`)).

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<div[39m
          [33mclass[39m=[32m"space-y-6"[39m
        [36m>[39m
          [36m<div[39m
            [33mclass[39m=[32m"flex items-center justify-between"[39m
          [36m>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center space-x-4"[39m
            [36m>[39m
              [36m<div>[39m
                [36m<h1[39m
                  [33mclass[39m=[32m"text-2xl font-bold text-gray-900"[39m
                [36m>[39m
                  [0mSecurity Monitoring[0m
                [36m</h1>[39m
                [36m<p[39m
                  [33mclass[39m=[32m"text-gray-600"[39m
                [36m>[39m
                  [0mReal-time security event monitoring and threat detection[0m
                [36m</p>[39m
              [36m</div>[39m
              [36m<div[39m
                [33mclass[39m=[32m"flex items-center space-x-2"[39m
              [36m>[39m
                [36m<div[39m
                  [33mclass[39m=[32m"w-3 h-3 rounded-full bg-green-500"[39m
                [36m/>[39m
                [36m<span[39m
                  [33mclass[39m=[32m"text-sm font-medium text-green-700"[39m
                [36m>[39m
                  [0mHEALTHY[0m
                [36m</span>[39m
              [36m</div>[39m
            [36m</div>[39m
            [36m<div[39m
              [33mclass[39m=[32m"flex items-center space-x-4"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"inline-flex items-center justify-center font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 undefined px-3 py-1.5 text-sm  flex items-center space-x-2"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M15.75 5.25v13.5m-7.5-13.5v13.5"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mPause[0m
                  [0m Live[0m
                [36m</span>[39m
              [36m</button>[39m
              [36m<select[39m
                [33mclass[39m=[32m"rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"[39m
              [36m>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"1"[39m
                [36m>[39m
                  [0mLast 24 hours[0m
                [36m</option>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"7"[39m
                [36m>[39m
                  [0mLast 7 days[0m
                [36m</option>[39m
                [36m<option[39m
                  [33mvalue[39m=[32m"30"[39m
                [36m>[39m
                  [0mLast 30 days[0m
                [36m</option>[39m
              [36m</select>[39m
              [36m<button[39m
                [33mclass[39m=[32m"inline-flex items-center justify-center font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-blue-500 disabled:bg-gray-50 disabled:text-gray-400 px-3 py-1.5 text-sm  flex items-center space-x-2"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mRefresh[0m
                [36m</span>[39m
              [36m</button>[39m
            [36m</div>[39m
          [36m</div>[39m
          [36m<div[39m
            [33mclass[39m=[32m"border-b border-gray-200"[39m
          [36m>[39m
            [36m<nav[39m
              [33mclass[39m=[32m"-mb-px flex space-x-8"[39m
            [36m>[39m
              [36m<button[39m
                [33mclass[39m=[32m"flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32m"1.5"[39m
                  [33mviewBox[39m=[32m"0 0 24 24"[39m
                  [33mxmlns[39m=[32m"http://www.w3.org/2000/svg"[39m
                [36m>[39m
                  [36m<path[39m
                    [33md[39m=[32m"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"[39m
                    [33mstroke-linecap[39m=[32m"round"[39m
                    [33mstroke-linejoin[39m=[32m"round"[39m
                  [36m/>[39m
                [36m</svg>[39m
                [36m<span>[39m
                  [0mOverview[0m
                [36m</span>[39m
              [36m</button>[39m
              [36m<button[39m
                [33mclass[39m=[32m"flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"[39m
              [36m>[39m
                [36m<svg[39m
                  [33maria-hidden[39m=[32m"true"[39m
                  [33mclass[39m=[32m"h-4 w-4"[39m
                  [33mdata-slot[39m=[32m"icon"[39m
                  [33mfill[39m=[32m"none"[39m
                  [33mstroke[39m=[32m"currentColor"[39m
                  [33mstroke-width[39m=[32...

      158 |     render(<SecurityMonitoringDashboard />);
      159 |     
    > 160 |     await waitFor(() => {
          |                  ^
      161 |       expect(screen.getByText('Unauthorized Access')).toBeInTheDocument();
      162 |       expect(screen.getByText('Test User')).toBeInTheDocument();
      163 |       expect(screen.getByText('192.168.1.100')).toBeInTheDocument();

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:160:18)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles event acknowledgment

    TypeError: Cannot read properties of undefined (reading 'systemHealth')

      269 |           </div>
      270 |           
    > 271 |           {data?.summary.systemHealth && (
          |                          ^
      272 |             <div className="flex items-center space-x-2">
      273 |               <div className={`w-3 h-3 rounded-full ${
      274 |                 data.summary.systemHealth === 'HEALTHY' ? 'bg-green-500' :

      at SecurityMonitoringDashboard (app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
      at renderWithHooks (node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
      at updateFunctionComponent (node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
      at beginWork (node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at performUnitOfWork (node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
      at workLoopSync (node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
      at renderRootSync (node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles event acknowledgment

    Unable to find an element with the text: Acknowledge. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to make your matcher more flexible.

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div />[39m
    [36m</body>[39m

      173 |     render(<SecurityMonitoringDashboard />);
      174 |     
    > 175 |     await waitFor(() => {
          |                  ^
      176 |       const acknowledgeButton = screen.getByText('Acknowledge');
      177 |       fireEvent.click(acknowledgeButton);
      178 |     });

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:175:18)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles event resolution

    TypeError: Cannot read properties of undefined (reading 'systemHealth')

      269 |           </div>
      270 |           
    > 271 |           {data?.summary.systemHealth && (
          |                          ^
      272 |             <div className="flex items-center space-x-2">
      273 |               <div className={`w-3 h-3 rounded-full ${
      274 |                 data.summary.systemHealth === 'HEALTHY' ? 'bg-green-500' :

      at SecurityMonitoringDashboard (app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
      at renderWithHooks (node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
      at updateFunctionComponent (node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
      at beginWork (node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at performUnitOfWork (node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
      at workLoopSync (node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
      at renderRootSync (node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles event resolution

    Unable to find an element with the text: Resolve. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to make your matcher more flexible.

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div />[39m
    [36m</body>[39m

      194 |     render(<SecurityMonitoringDashboard />);
      195 |     
    > 196 |     await waitFor(() => {
          |                  ^
      197 |       const resolveButton = screen.getByText('Resolve');
      198 |       fireEvent.click(resolveButton);
      199 |     });

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:196:18)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles IP blocking

    TypeError: Cannot read properties of undefined (reading 'systemHealth')

      269 |           </div>
      270 |           
    > 271 |           {data?.summary.systemHealth && (
          |                          ^
      272 |             <div className="flex items-center space-x-2">
      273 |               <div className={`w-3 h-3 rounded-full ${
      274 |                 data.summary.systemHealth === 'HEALTHY' ? 'bg-green-500' :

      at SecurityMonitoringDashboard (app/components/admin/SecurityMonitoringDashboard.tsx:271:26)
      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25904:20)
      at renderWithHooks (node_modules/react-dom/cjs/react-dom-client.development.js:7662:22)
      at updateFunctionComponent (node_modules/react-dom/cjs/react-dom-client.development.js:10166:19)
      at beginWork (node_modules/react-dom/cjs/react-dom-client.development.js:11778:18)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at performUnitOfWork (node_modules/react-dom/cjs/react-dom-client.development.js:17641:22)
      at workLoopSync (node_modules/react-dom/cjs/react-dom-client.development.js:17469:41)
      at renderRootSync (node_modules/react-dom/cjs/react-dom-client.development.js:17450:11)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16583:35)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at performWorkUntilDeadline (node_modules/scheduler/cjs/scheduler.development.js:45:48)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles IP blocking

    Unable to find an element with the text: Block. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to make your matcher more flexible.

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div />[39m
    [36m</body>[39m

      215 |     render(<SecurityMonitoringDashboard />);
      216 |     
    > 217 |     await waitFor(() => {
          |                  ^
      218 |       const blockButton = screen.getByText('Block');
      219 |       fireEvent.click(blockButton);
      220 |     });

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:217:18)

  ‚óè SecurityMonitoringDashboard ‚Ä∫ handles time range selection

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "days=30", Any<Object>
    Received
           1: "/api/admin/security/dashboard?days=7"
           2: "/api/admin/security/dashboard?days=30"

    Number of calls: 2

      263 |
      264 |     // Should make API call with new time range
    > 265 |     expect(fetch).toHaveBeenCalledWith(
          |                   ^
      266 |       expect.stringContaining('days=30'),
      267 |       expect.any(Object)
      268 |     );

      at Object.<anonymous> (__tests__/unit/admin/SecurityMonitoringDashboard.test.tsx:265:19)

FAIL unit __tests__/unit/middleware-security-comprehensive.test.ts
  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to home page: /

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to login page: /auth/login

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to registration page: /auth/register

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to password reset page: /auth/password-reset

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to health check: /api/health

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to CSRF token: /api/csrf-token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to public products: /api/public/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to NextAuth signin: /api/auth/signin

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Public Route Access ‚Ä∫ should allow public access to NextAuth callback: /api/auth/callback/credentials

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      136 |           
      137 |           // Should log public route access
    > 138 |           expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                 ^
      139 |             expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      140 |             expect.stringContaining('public_route')
      141 |           )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:138:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Authentication Required Routes ‚Ä∫ should require authentication for user profile: /profile

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      164 |             expect(body.error.code).toBe('UNAUTHORIZED')
      165 |           } else {
    > 166 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      167 |             expect(response.headers.get('location')).toContain('/auth/login')
      168 |           }
      169 |         })

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:166:37)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Authentication Required Routes ‚Ä∫ should require authentication for user settings: /settings

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      164 |             expect(body.error.code).toBe('UNAUTHORIZED')
      165 |           } else {
    > 166 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      167 |             expect(response.headers.get('location')).toContain('/auth/login')
      168 |           }
      169 |         })

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:166:37)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Authentication Required Routes ‚Ä∫ should require authentication for user preferences API: /api/user/preferences

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      160 |           
      161 |           if (path.startsWith('/api/')) {
    > 162 |             expect(response.status).toBe(401)
          |                                     ^
      163 |             const body = await response.json()
      164 |             expect(body.error.code).toBe('UNAUTHORIZED')
      165 |           } else {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:162:37)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Authentication Required Routes ‚Ä∫ should require authentication for notifications API: /api/notifications

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      160 |           
      161 |           if (path.startsWith('/api/')) {
    > 162 |             expect(response.status).toBe(401)
          |                                     ^
      163 |             const body = await response.json()
      164 |             expect(body.error.code).toBe('UNAUTHORIZED')
      165 |           } else {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:162:37)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow ADMIN access to /admin/users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny EDITOR access to /admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {
    > 251 |               expect(response.status).toBe(307) // Redirect
          |                                       ^
      252 |             }
      253 |             
      254 |             // Should log forbidden access

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:251:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny VIEWER access to /admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {
    > 251 |               expect(response.status).toBe(307) // Redirect
          |                                       ^
      252 |             }
      253 |             
      254 |             // Should log forbidden access

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:251:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow ADMIN access to /admin/security

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny EDITOR access to /admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {
    > 251 |               expect(response.status).toBe(307) // Redirect
          |                                       ^
      252 |             }
      253 |             
      254 |             // Should log forbidden access

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:251:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny VIEWER access to /admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {
    > 251 |               expect(response.status).toBe(307) // Redirect
          |                                       ^
      252 |             }
      253 |             
      254 |             // Should log forbidden access

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:251:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow ADMIN access to /admin/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow EDITOR access to /admin/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny VIEWER access to /admin/products

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {
    > 251 |               expect(response.status).toBe(307) // Redirect
          |                                       ^
      252 |             }
      253 |             
      254 |             // Should log forbidden access

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:251:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow ADMIN access to /api/admin/users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny EDITOR access to /api/admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      245 |             
      246 |             if (path.startsWith('/api/')) {
    > 247 |               expect(response.status).toBe(403)
          |                                       ^
      248 |               const body = await response.json()
      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:247:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should deny VIEWER access to /api/admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      245 |             
      246 |             if (path.startsWith('/api/')) {
    > 247 |               expect(response.status).toBe(403)
          |                                       ^
      248 |               const body = await response.json()
      249 |               expect(body.error.code).toBe('FORBIDDEN')
      250 |             } else {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:247:39)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow ADMIN access to /api/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow EDITOR access to /api/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Route Protection Logic ‚Ä∫ Permission-Based Route Protection ‚Ä∫ should allow VIEWER access to /api/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringContaining "permission_granted"

    Number of calls: 0

      229 |             
      230 |             // Should log successful access
    > 231 |             expect(consoleLogSpy).toHaveBeenCalledWith(
          |                                   ^
      232 |               expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      233 |               expect.stringContaining('permission_granted')
      234 |             )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:231:35)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Authentication Attacks ‚Ä∫ should handle token manipulation attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      294 |         const response = await middleware(request)
      295 |         
    > 296 |         expect(response.status).toBe(307) // Redirect to login
          |                                 ^
      297 |         expect(consoleErrorSpy).toHaveBeenCalledWith(
      298 |           'Failed to get token:',
      299 |           expect.any(Error)

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:296:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Authentication Attacks ‚Ä∫ should handle malformed tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      316 |         const response = await middleware(request)
      317 |         
    > 318 |         expect(response.status).toBe(307) // Should redirect due to invalid token
          |                                 ^
      319 |       })
      320 |
      321 |       it('should handle expired tokens', async () => {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:318:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Authentication Attacks ‚Ä∫ should handle expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      325 |         const response = await middleware(request)
      326 |         
    > 327 |         expect(response.status).toBe(307)
          |                                 ^
      328 |         expect(response.headers.get('location')).toContain('/auth/login')
      329 |       })
      330 |     })

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:327:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Authorization Attacks ‚Ä∫ should detect privilege escalation attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      338 |         const response = await middleware(request)
      339 |         
    > 340 |         expect(response.status).toBe(307)
          |                                 ^
      341 |         
      342 |         // Should log as potential privilege escalation
      343 |         expect(consoleLogSpy).toHaveBeenCalledWith(

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:340:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Authorization Attacks ‚Ä∫ should detect role manipulation attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      354 |         const response = await middleware(request)
      355 |         
    > 356 |         expect(response.status).toBe(307) // Should be denied
          |                                 ^
      357 |       })
      358 |
      359 |       it('should handle concurrent session attacks', async () => {

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:356:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ IP-Based Security ‚Ä∫ should track suspicious IP behavior

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_MEDIUM] UNAUTHORIZED:", StringContaining "10.0.0.1"

    Number of calls: 0

      393 |         
      394 |         // Should log suspicious activity
    > 395 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      396 |           expect.stringContaining('[SECURITY_MEDIUM] UNAUTHORIZED:'),
      397 |           expect.stringContaining(suspiciousIP)
      398 |         )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:395:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ IP-Based Security ‚Ä∫ should handle IP spoofing attempts

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_MEDIUM] UNAUTHORIZED:", StringContaining "127.0.0.1, 192.168.1.1, 10.0.0.1"

    Number of calls: 0

      409 |         
      410 |         // Should log with full IP chain
    > 411 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      412 |           expect.stringContaining('[SECURITY_MEDIUM] UNAUTHORIZED:'),
      413 |           expect.stringContaining('127.0.0.1, 192.168.1.1, 10.0.0.1')
      414 |         )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:411:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Request Manipulation ‚Ä∫ should handle method override attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      447 |         
      448 |         // Should still check based on actual method, not override
    > 449 |         expect(response.status).toBe(403)
          |                                 ^
      450 |       })
      451 |     })
      452 |

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:449:33)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Scenarios ‚Ä∫ Rate Limiting Security ‚Ä∫ should apply different rate limits based on route sensitivity

    Cannot find module '../app/lib/rate-limit' from '__tests__/unit/middleware-security-comprehensive.test.ts'

      453 |     describe('Rate Limiting Security', () => {
      454 |       it('should apply different rate limits based on route sensitivity', async () => {
    > 455 |         const { rateLimit } = require('../app/lib/rate-limit')
          |                               ^
      456 |         
      457 |         // Test auth routes (stricter limits)
      458 |         const authRequest = createMockRequest('/api/auth/login', 'POST')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:455:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Headers and Response Handling ‚Ä∫ should remove sensitive headers

    expect(received).toBeNull()

    Received: undefined

      515 |       const response = await middleware(request)
      516 |       
    > 517 |       expect(response.headers.get('Server')).toBeNull()
          |                                              ^
      518 |       expect(response.headers.get('X-Powered-By')).toBeNull()
      519 |     })
      520 |

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:517:46)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Security Headers and Response Handling ‚Ä∫ should add request tracking headers

    expect(received).toBeTruthy()

    Received: undefined

      523 |       const response = await middleware(request)
      524 |       
    > 525 |       expect(response.headers.get('x-request-id')).toBeTruthy()
          |                                                    ^
      526 |       expect(response.headers.get('X-Security-Monitored')).toBe('true')
      527 |       expect(response.headers.get('X-Timestamp')).toBeTruthy()
      528 |     })

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:525:52)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Error Response Formats ‚Ä∫ should return standardized API error responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      536 |       const response = await middleware(request)
      537 |       
    > 538 |       expect(response.status).toBe(401)
          |                               ^
      539 |       
      540 |       const body = await response.json()
      541 |       expect(body).toEqual({

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:538:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Error Response Formats ‚Ä∫ should return standardized forbidden responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      561 |       const response = await middleware(request)
      562 |       
    > 563 |       expect(response.status).toBe(403)
          |                               ^
      564 |       
      565 |       const body = await response.json()
      566 |       expect(body.error.code).toBe('FORBIDDEN')

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:563:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Error Response Formats ‚Ä∫ should handle web route redirects properly

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      575 |       const response = await middleware(request)
      576 |       
    > 577 |       expect(response.status).toBe(307)
          |                               ^
      578 |       
      579 |       const location = response.headers.get('location')
      580 |       expect(location).toContain('/auth/login')

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:577:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Logging and Monitoring ‚Ä∫ should log all security events with proper severity

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_MEDIUM] UNAUTHORIZED:", Any<String>

    Number of calls: 0

      614 |         await middleware(request)
      615 |         
    > 616 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      617 |           expect.stringContaining(`[SECURITY_${expectedSeverity}] ${expectedResult}:`),
      618 |           expect.any(String)
      619 |         )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:616:31)

  ‚óè Comprehensive Middleware Security Tests ‚Ä∫ Logging and Monitoring ‚Ä∫ should include comprehensive request metadata in logs

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "[SECURITY_LOW] SUCCESS:", StringMatching /"userId":\s*"user-1"/

    Number of calls: 0

      633 |       
      634 |       // Check that log includes all metadata
    > 635 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      636 |         expect.stringContaining('[SECURITY_LOW] SUCCESS:'),
      637 |         expect.stringMatching(/"userId":\s*"user-1"/)
      638 |       )

      at Object.<anonymous> (__tests__/unit/middleware-security-comprehensive.test.ts:635:29)

FAIL unit __tests__/unit/permissions.test.ts
  ‚óè PermissionService ‚Ä∫ hasPermission ‚Ä∫ should return true for editor with product permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      55 |       const editor = createMockUser(UserRole.EDITOR);
      56 |       const permission: Permission = { resource: 'products', action: 'create' };
    > 57 |       expect(service.hasPermission(editor, permission)).toBe(true);
         |                                                         ^
      58 |     });
      59 |
      60 |     it('should return false for viewer with create permissions', () => {

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:57:57)

  ‚óè PermissionService ‚Ä∫ hasPermission ‚Ä∫ should handle scope-based permissions correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      75 |       const allPermission: Permission = { resource: 'profile', action: 'manage', scope: 'all' };
      76 |       
    > 77 |       expect(service.hasPermission(editor, ownPermission)).toBe(true);
         |                                                            ^
      78 |       expect(service.hasPermission(editor, allPermission)).toBe(false);
      79 |     });
      80 |   });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:77:60)

  ‚óè PermissionService ‚Ä∫ hasResourceAccess ‚Ä∫ should correctly validate resource access

    TypeError: service.hasResourceAccess is not a function

      84 |       const editor = createMockUser(UserRole.EDITOR);
      85 |       
    > 86 |       expect(service.hasResourceAccess(editor, 'products', 'create')).toBe(true);
         |                      ^
      87 |       expect(service.hasResourceAccess(editor, 'products', 'read')).toBe(true);
      88 |       expect(service.hasResourceAccess(editor, 'users', 'create')).toBe(false);
      89 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:86:22)

  ‚óè PermissionService ‚Ä∫ canUserAccessRoute ‚Ä∫ should restrict viewer access to admin routes

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      104 |       expect(service.canUserAccessRoute(viewer, '/admin/users')).toBe(false);
      105 |       expect(service.canUserAccessRoute(viewer, '/admin/security')).toBe(false);
    > 106 |       expect(service.canUserAccessRoute(viewer, '/admin/products')).toBe(true); // Can read
          |                                                                     ^
      107 |     });
      108 |
      109 |     it('should handle dynamic routes correctly', () => {

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:106:69)

  ‚óè PermissionService ‚Ä∫ canUserAccessRoute ‚Ä∫ should handle dynamic routes correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      110 |       const editor = createMockUser(UserRole.EDITOR);
      111 |       
    > 112 |       expect(service.canUserAccessRoute(editor, '/admin/products/123/edit')).toBe(true);
          |                                                                              ^
      113 |       expect(service.canUserAccessRoute(editor, '/admin/pages/456/edit')).toBe(true);
      114 |     });
      115 |   });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:112:78)

  ‚óè PermissionService ‚Ä∫ role checking methods ‚Ä∫ should correctly identify editor users

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      130 |       const viewer = createMockUser(UserRole.VIEWER);
      131 |       
    > 132 |       expect(service.isEditor(admin)).toBe(true);
          |                                       ^
      133 |       expect(service.isEditor(editor)).toBe(true);
      134 |       expect(service.isEditor(viewer)).toBe(false);
      135 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:132:39)

  ‚óè PermissionService ‚Ä∫ role checking methods ‚Ä∫ should correctly identify viewer users

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      140 |       const viewer = createMockUser(UserRole.VIEWER);
      141 |       
    > 142 |       expect(service.isViewer(admin)).toBe(true);
          |                                       ^
      143 |       expect(service.isViewer(editor)).toBe(true);
      144 |       expect(service.isViewer(viewer)).toBe(true);
      145 |       expect(service.isViewer(null)).toBe(false);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:142:39)

  ‚óè ResourcePermissionValidator ‚Ä∫ user management permissions ‚Ä∫ should validate user deletion permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      264 |       
      265 |       expect(validator.canDeleteUser(admin, 'other-user-id')).toBe(true);
    > 266 |       expect(validator.canDeleteUser(admin, 'admin-id')).toBe(false); // Can't delete self
          |                                                          ^
      267 |       expect(validator.canDeleteUser(editor, 'other-user-id')).toBe(false);
      268 |     });
      269 |   });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:266:58)

  ‚óè RoleHierarchyValidator ‚Ä∫ hasMinimumRole ‚Ä∫ should validate minimum role requirements

    TypeError: permissions_1.roleHierarchy.hasMinimumRole is not a function

      273 |   describe('hasMinimumRole', () => {
      274 |     it('should validate minimum role requirements', () => {
    > 275 |       expect(roleHierarchy.hasMinimumRole(UserRole.ADMIN, UserRole.VIEWER)).toBe(true);
          |                            ^
      276 |       expect(roleHierarchy.hasMinimumRole(UserRole.EDITOR, UserRole.VIEWER)).toBe(true);
      277 |       expect(roleHierarchy.hasMinimumRole(UserRole.VIEWER, UserRole.EDITOR)).toBe(false);
      278 |       expect(roleHierarchy.hasMinimumRole(null, UserRole.VIEWER)).toBe(false);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:275:28)

  ‚óè RoleHierarchyValidator ‚Ä∫ canManageUser ‚Ä∫ should validate user management hierarchy

    TypeError: permissions_1.roleHierarchy.canManageUser is not a function

      282 |   describe('canManageUser', () => {
      283 |     it('should validate user management hierarchy', () => {
    > 284 |       expect(roleHierarchy.canManageUser(UserRole.ADMIN, UserRole.EDITOR)).toBe(true);
          |                            ^
      285 |       expect(roleHierarchy.canManageUser(UserRole.ADMIN, UserRole.VIEWER)).toBe(true);
      286 |       expect(roleHierarchy.canManageUser(UserRole.EDITOR, UserRole.VIEWER)).toBe(true);
      287 |       expect(roleHierarchy.canManageUser(UserRole.EDITOR, UserRole.ADMIN)).toBe(false);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:284:28)

  ‚óè RoleHierarchyValidator ‚Ä∫ getAssignableRoles ‚Ä∫ should return correct assignable roles

    TypeError: permissions_1.roleHierarchy.getAssignableRoles is not a function

      292 |   describe('getAssignableRoles', () => {
      293 |     it('should return correct assignable roles', () => {
    > 294 |       const adminRoles = roleHierarchy.getAssignableRoles(UserRole.ADMIN);
          |                                        ^
      295 |       const editorRoles = roleHierarchy.getAssignableRoles(UserRole.EDITOR);
      296 |       const viewerRoles = roleHierarchy.getAssignableRoles(UserRole.VIEWER);
      297 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:294:40)

  ‚óè RoleHierarchyValidator ‚Ä∫ role display methods ‚Ä∫ should return correct display names

    TypeError: permissions_1.roleHierarchy.getRoleDisplayName is not a function

      310 |   describe('role display methods', () => {
      311 |     it('should return correct display names', () => {
    > 312 |       expect(roleHierarchy.getRoleDisplayName(UserRole.ADMIN)).toBe('Administrator');
          |                            ^
      313 |       expect(roleHierarchy.getRoleDisplayName(UserRole.EDITOR)).toBe('Editor');
      314 |       expect(roleHierarchy.getRoleDisplayName(UserRole.VIEWER)).toBe('Viewer');
      315 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:312:28)

  ‚óè RoleHierarchyValidator ‚Ä∫ role display methods ‚Ä∫ should return correct descriptions

    TypeError: permissions_1.roleHierarchy.getRoleDescription is not a function

      316 |
      317 |     it('should return correct descriptions', () => {
    > 318 |       const adminDesc = roleHierarchy.getRoleDescription(UserRole.ADMIN);
          |                                       ^
      319 |       const editorDesc = roleHierarchy.getRoleDescription(UserRole.EDITOR);
      320 |       const viewerDesc = roleHierarchy.getRoleDescription(UserRole.VIEWER);
      321 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:318:39)

  ‚óè RoleHierarchyValidator ‚Ä∫ hasMinimumRole ‚Ä∫ should validate minimum role requirements correctly

    TypeError: permissions_1.RoleHierarchyValidator.hasMinimumRole is not a function

      336 |   describe('hasMinimumRole', () => {
      337 |     it('should validate minimum role requirements correctly', () => {
    > 338 |       expect(RoleHierarchyValidator.hasMinimumRole(UserRole.ADMIN, UserRole.VIEWER)).toBe(true);
          |                                     ^
      339 |       expect(RoleHierarchyValidator.hasMinimumRole(UserRole.ADMIN, UserRole.EDITOR)).toBe(true);
      340 |       expect(RoleHierarchyValidator.hasMinimumRole(UserRole.ADMIN, UserRole.ADMIN)).toBe(true);
      341 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:338:37)

  ‚óè RoleHierarchyValidator ‚Ä∫ canManageUser ‚Ä∫ should validate user management hierarchy correctly

    TypeError: permissions_1.RoleHierarchyValidator.canManageUser is not a function

      354 |   describe('canManageUser', () => {
      355 |     it('should validate user management hierarchy correctly', () => {
    > 356 |       expect(RoleHierarchyValidator.canManageUser(UserRole.ADMIN, UserRole.EDITOR)).toBe(true);
          |                                     ^
      357 |       expect(RoleHierarchyValidator.canManageUser(UserRole.ADMIN, UserRole.VIEWER)).toBe(true);
      358 |       expect(RoleHierarchyValidator.canManageUser(UserRole.ADMIN, UserRole.ADMIN)).toBe(false);
      359 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:356:37)

  ‚óè RoleHierarchyValidator ‚Ä∫ getAssignableRoles ‚Ä∫ should return correct assignable roles for each role

    TypeError: permissions_1.RoleHierarchyValidator.getAssignableRoles is not a function

      370 |   describe('getAssignableRoles', () => {
      371 |     it('should return correct assignable roles for each role', () => {
    > 372 |       const adminRoles = RoleHierarchyValidator.getAssignableRoles(UserRole.ADMIN);
          |                                                 ^
      373 |       expect(adminRoles).toContain(UserRole.EDITOR);
      374 |       expect(adminRoles).toContain(UserRole.VIEWER);
      375 |       expect(adminRoles).not.toContain(UserRole.ADMIN);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:372:49)

  ‚óè RoleHierarchyValidator ‚Ä∫ getRoleLevel ‚Ä∫ should return correct role levels

    TypeError: permissions_1.RoleHierarchyValidator.getRoleLevel is not a function

      387 |   describe('getRoleLevel', () => {
      388 |     it('should return correct role levels', () => {
    > 389 |       expect(RoleHierarchyValidator.getRoleLevel(UserRole.ADMIN)).toBe(3);
          |                                     ^
      390 |       expect(RoleHierarchyValidator.getRoleLevel(UserRole.EDITOR)).toBe(2);
      391 |       expect(RoleHierarchyValidator.getRoleLevel(UserRole.VIEWER)).toBe(1);
      392 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:389:37)

  ‚óè RoleHierarchyValidator ‚Ä∫ getRoleDisplayName ‚Ä∫ should return correct display names

    TypeError: permissions_1.RoleHierarchyValidator.getRoleDisplayName is not a function

      395 |   describe('getRoleDisplayName', () => {
      396 |     it('should return correct display names', () => {
    > 397 |       expect(RoleHierarchyValidator.getRoleDisplayName(UserRole.ADMIN)).toBe('Administrator');
          |                                     ^
      398 |       expect(RoleHierarchyValidator.getRoleDisplayName(UserRole.EDITOR)).toBe('Editor');
      399 |       expect(RoleHierarchyValidator.getRoleDisplayName(UserRole.VIEWER)).toBe('Viewer');
      400 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:397:37)

  ‚óè RoleHierarchyValidator ‚Ä∫ getRoleDescription ‚Ä∫ should return correct role descriptions

    TypeError: permissions_1.RoleHierarchyValidator.getRoleDescription is not a function

      403 |   describe('getRoleDescription', () => {
      404 |     it('should return correct role descriptions', () => {
    > 405 |       const adminDesc = RoleHierarchyValidator.getRoleDescription(UserRole.ADMIN);
          |                                                ^
      406 |       const editorDesc = RoleHierarchyValidator.getRoleDescription(UserRole.EDITOR);
      407 |       const viewerDesc = RoleHierarchyValidator.getRoleDescription(UserRole.VIEWER);
      408 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:405:48)

  ‚óè RoleHierarchyValidator ‚Ä∫ isValidRoleTransition ‚Ä∫ should validate role transitions correctly

    TypeError: permissions_1.RoleHierarchyValidator.isValidRoleTransition is not a function

      416 |     it('should validate role transitions correctly', () => {
      417 |       // Admin can assign any role except admin
    > 418 |       expect(RoleHierarchyValidator.isValidRoleTransition(UserRole.ADMIN, UserRole.VIEWER, UserRole.EDITOR)).toBe(true);
          |                                     ^
      419 |       expect(RoleHierarchyValidator.isValidRoleTransition(UserRole.ADMIN, UserRole.EDITOR, UserRole.VIEWER)).toBe(true);
      420 |       expect(RoleHierarchyValidator.isValidRoleTransition(UserRole.ADMIN, UserRole.VIEWER, UserRole.ADMIN)).toBe(false);
      421 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:418:37)

  ‚óè Advanced Permission Scenarios ‚Ä∫ scope-based permissions ‚Ä∫ should handle own scope permissions correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      457 |       
      458 |       // Editor should be able to manage own profile
    > 459 |       expect(validator.canUpdateUser(editor, 'editor-123')).toBe(true);
          |                                                             ^
      460 |       expect(validator.canUpdateUser(editor, 'other-user-456')).toBe(false);
      461 |     });
      462 |

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:459:61)

  ‚óè Advanced Permission Scenarios ‚Ä∫ resource ownership validation ‚Ä∫ should validate resource ownership correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      477 |       const user = createMockUser(UserRole.EDITOR, 'user-123');
      478 |       
    > 479 |       expect(service.ownsResource(user, 'user-123')).toBe(true);
          |                                                      ^
      480 |       expect(service.ownsResource(user, 'user-456')).toBe(false);
      481 |       expect(service.ownsResource(null, 'user-123')).toBe(false);
      482 |     });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:479:54)

  ‚óè Advanced Permission Scenarios ‚Ä∫ route pattern matching ‚Ä∫ should match dynamic routes correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      488 |       
      489 |       // Test various dynamic route patterns
    > 490 |       expect(service.canUserAccessRoute(editor, '/admin/products/123/edit')).toBe(true);
          |                                                                              ^
      491 |       expect(service.canUserAccessRoute(editor, '/admin/products/abc-def/edit')).toBe(true);
      492 |       expect(service.canUserAccessRoute(editor, '/admin/pages/456/edit')).toBe(true);
      493 |       

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:490:78)

  ‚óè Cache Functionality Tests ‚Ä∫ cache operations ‚Ä∫ should handle scope in cache keys

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 1

      592 |       
      593 |       const stats = service.getCacheStats();
    > 594 |       expect(stats.size).toBe(3);
          |                          ^
      595 |     });
      596 |
      597 |     it('should invalidate user cache correctly', () => {

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:594:26)

  ‚óè Cache Functionality Tests ‚Ä∫ cache operations ‚Ä∫ should provide accurate cache statistics

    expect(received).toHaveProperty(path)

    Expected path: "ttl"
    Received path: []

    Received value: {"hits": 0, "misses": 0, "size": 0}

      634 |       
      635 |       expect(stats).toHaveProperty('size');
    > 636 |       expect(stats).toHaveProperty('ttl');
          |                     ^
      637 |       expect(typeof stats.size).toBe('number');
      638 |       expect(typeof stats.ttl).toBe('number');
      639 |       expect(stats.ttl).toBe(5 * 60 * 1000); // 5 minutes default

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:636:21)

  ‚óè Error Handling and Edge Cases ‚Ä∫ null and undefined handling ‚Ä∫ should handle null user gracefully

    TypeError: service.hasResourceAccess is not a function

      697 |     it('should handle null user gracefully', () => {
      698 |       expect(service.hasPermission(null, { resource: 'products', action: 'read' })).toBe(false);
    > 699 |       expect(service.hasResourceAccess(null, 'products', 'read')).toBe(false);
          |                      ^
      700 |       expect(service.canUserAccessRoute(null, '/admin/products')).toBe(false);
      701 |       expect(service.isAdmin(null)).toBe(false);
      702 |       expect(service.isEditor(null)).toBe(false);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:699:22)

  ‚óè Error Handling and Edge Cases ‚Ä∫ null and undefined handling ‚Ä∫ should handle empty permission objects

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      716 |       // These should not throw errors
      717 |       expect(service.hasPermission(user, { resource: '', action: '' })).toBe(false);
    > 718 |       expect(service.hasPermission(user, { resource: 'products', action: '' })).toBe(true); // Editor has manage permission for products
          |                                                                                 ^
      719 |       expect(service.hasPermission(user, { resource: '', action: 'read' })).toBe(false);
      720 |     });
      721 |   });

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:718:81)

  ‚óè Error Handling and Edge Cases ‚Ä∫ unknown resources and actions ‚Ä∫ should handle unknown actions gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      738 |       
      739 |       // Editor should have access to unknown actions on products due to manage permission
    > 740 |       expect(service.hasPermission(editor, { resource: 'products', action: 'unknown-action' })).toBe(true);
          |                                                                                                 ^
      741 |       
      742 |       // Admin should have access due to wildcard permissions
      743 |       expect(service.hasPermission(admin, { resource: 'products', action: 'unknown-action' })).toBe(true);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:740:97)

  ‚óè Integration Tests ‚Ä∫ should work with singleton instances

    TypeError: permissions_1.permissionService.hasResourceAccess is not a function

      773 |     
      774 |     expect(permissionService.isAdmin(admin)).toBe(true);
    > 775 |     expect(permissionService.hasResourceAccess(admin, 'products', 'create')).toBe(true);
          |                              ^
      776 |   });
      777 |
      778 |   it('should handle complex permission scenarios', () => {

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:775:30)

  ‚óè Integration Tests ‚Ä∫ should handle complex permission scenarios

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      785 |     
      786 |     // Editor can manage own profile but not others' profiles
    > 787 |     expect(validator.canUpdateUser(editor, 'editor-id')).toBe(true);
          |                                                          ^
      788 |     expect(validator.canUpdateUser(editor, 'other-user-id')).toBe(false);
      789 |     
      790 |     // Editor can access product routes but not user management routes

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:787:58)

  ‚óè Integration Tests ‚Ä∫ should maintain consistency across different validation methods

    TypeError: permissions_1.permissionService.hasResourceAccess is not a function

      798 |     
      799 |     // Direct permission check vs validator method should be consistent
    > 800 |     const directCheck = permissionService.hasResourceAccess(user, 'products', 'create');
          |                                           ^
      801 |     const validatorCheck = validator.canCreateProduct(user);
      802 |     
      803 |     expect(directCheck).toBe(validatorCheck);

      at Object.<anonymous> (__tests__/unit/permissions.test.ts:800:43)

FAIL integration __tests__/integration/security-scenarios-comprehensive.test.ts
  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle JWT signature tampering

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      108 |         const response = await middleware(request)
      109 |         
    > 110 |         expect(response.status).toBe(307) // Redirect to login
          |                                 ^
      111 |         expect(consoleErrorSpy).toHaveBeenCalledWith(
      112 |           'Failed to get token:',
      113 |           expect.any(Error)

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:110:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      121 |         const response = await middleware(request)
      122 |         
    > 123 |         expect(response.status).toBe(401)
          |                                 ^
      124 |         const body = await response.json()
      125 |         expect(body.error.code).toBe('UNAUTHORIZED')
      126 |       })

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:123:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle malformed JWT tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      132 |         const response = await middleware(request)
      133 |         
    > 134 |         expect(response.status).toBe(307)
          |                                 ^
      135 |       })
      136 |
      137 |       it('should handle token with missing claims', async () => {

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:134:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle token with missing claims

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      144 |         const response = await middleware(request)
      145 |         
    > 146 |         expect(response.status).toBe(307) // Should redirect due to invalid token
          |                                 ^
      147 |       })
      148 |
      149 |       it('should handle token with invalid role', async () => {

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:146:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle token with invalid role

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      157 |         const response = await middleware(request)
      158 |         
    > 159 |         expect(response.status).toBe(307) // Should redirect due to invalid role
          |                                 ^
      160 |       })
      161 |     })
      162 |

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:159:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Brute Force Attack Scenarios ‚Ä∫ should handle rapid authentication attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      221 |         // All should be unauthorized
      222 |         responses.forEach(response => {
    > 223 |           expect(response.status).toBe(401)
          |                                   ^
      224 |         })
      225 |         
      226 |         // Should log multiple unauthorized attempts

      at __tests__/integration/security-scenarios-comprehensive.test.ts:223:35
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:222:19)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Brute Force Attack Scenarios ‚Ä∫ should handle distributed brute force attacks

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      246 |           
      247 |           responses.forEach(response => {
    > 248 |             expect(response.status).toBe(307) // Redirect to login
          |                                     ^
      249 |           })
      250 |         }
      251 |       })

      at __tests__/integration/security-scenarios-comprehensive.test.ts:248:37
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:247:21)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Privilege Escalation Attacks ‚Ä∫ should detect vertical privilege escalation

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      286 |             expect(response.status).toBe(403)
      287 |           } else {
    > 288 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      289 |           }
      290 |         }
      291 |       })

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:288:37)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Privilege Escalation Attacks ‚Ä∫ should detect role manipulation attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      300 |         
      301 |         // Should be denied due to invalid role
    > 302 |         expect(response.status).toBe(307)
          |                                 ^
      303 |       })
      304 |     })
      305 |

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:302:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Permission Bypass Attempts ‚Ä∫ should handle method override attacks

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      318 |         
      319 |         // Should still check based on actual method
    > 320 |         expect(response.status).toBe(403)
          |                                 ^
      321 |       })
      322 |
      323 |       it('should handle parameter pollution attacks', async () => {

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:320:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Advanced Security Scenarios ‚Ä∫ Timing Attacks ‚Ä∫ should have consistent response times for invalid users

    expect(received).toBeLessThan(expected)

    Expected: < 5.6
    Received:   6.2

      589 |         
      590 |         // Allow some variance but not too much
    > 591 |         expect(maxDeviation).toBeLessThan(avgTime * 2)
          |                              ^
      592 |       })
      593 |     })
      594 |

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:591:30)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Advanced Security Scenarios ‚Ä∫ Information Disclosure ‚Ä∫ should not leak sensitive information in error responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      600 |         const response = await middleware(request)
      601 |         
    > 602 |         expect(response.status).toBe(401)
          |                                 ^
      603 |         
      604 |         const body = await response.json()
      605 |         // Should not expose internal error details

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:602:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Advanced Security Scenarios ‚Ä∫ Information Disclosure ‚Ä∫ should not expose stack traces

    TypeError: Cannot read properties of undefined (reading 'message')

      615 |         
      616 |         const body = await response.json()
    > 617 |         expect(body.error.message).not.toContain('stack')
          |                           ^
      618 |         expect(body.error.message).not.toContain('at ')
      619 |       })
      620 |     })

      at Object.<anonymous> (__tests__/integration/security-scenarios-comprehensive.test.ts:617:27)

FAIL unit __tests__/unit/middleware-security-logging.test.ts
  ‚óè Security Logging Middleware ‚Ä∫ Access Logging ‚Ä∫ should log successful access to public routes

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      120 |   describe('Access Logging', () => {
      121 |     it('should log successful access to public routes', async () => {
    > 122 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      123 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      124 |
      125 |       const request = createMockRequest('/public-page')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:122:43)

  ‚óè Security Logging Middleware ‚Ä∫ Access Logging ‚Ä∫ should log unauthorized access attempts

    ReferenceError: middleware is not defined

      136 |
      137 |       const request = createMockRequest('/protected-page')
    > 138 |       await middleware(request)
          |       ^
      139 |
      140 |       expect(consoleSpy).toHaveBeenCalledWith(
      141 |         expect.stringContaining('[SECURITY_MEDIUM] UNAUTHORIZED:'),

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:138:7)

  ‚óè Security Logging Middleware ‚Ä∫ Access Logging ‚Ä∫ should log forbidden access attempts with high severity

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      145 |
      146 |     it('should log forbidden access attempts with high severity', async () => {
    > 147 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      148 |       routePermissionResolver.getRoutePermissions.mockReturnValue([
      149 |         { resource: 'admin', action: 'manage', scope: 'all' }
      150 |       ])

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:147:43)

  ‚óè Security Logging Middleware ‚Ä∫ Access Logging ‚Ä∫ should include comprehensive metadata in logs

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      162 |
      163 |     it('should include comprehensive metadata in logs', async () => {
    > 164 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      165 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      166 |
      167 |       const request = createMockRequest('/test', {

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:164:43)

  ‚óè Security Logging Middleware ‚Ä∫ Rate Limiting ‚Ä∫ should apply rate limiting and log violations

    Cannot find module '../app/lib/rate-limit' from '__tests__/unit/middleware-security-logging.test.ts'

      182 |   describe('Rate Limiting', () => {
      183 |     it('should apply rate limiting and log violations', async () => {
    > 184 |       const { rateLimit } = require('../app/lib/rate-limit')
          |                             ^
      185 |       rateLimit.mockResolvedValue({
      186 |         success: false,
      187 |         limit: 100,

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:184:29)

  ‚óè Security Logging Middleware ‚Ä∫ Rate Limiting ‚Ä∫ should use sensitive rate limits for admin routes

    Cannot find module '../app/lib/rate-limit' from '__tests__/unit/middleware-security-logging.test.ts'

      202 |
      203 |     it('should use sensitive rate limits for admin routes', async () => {
    > 204 |       const { rateLimit, rateLimitConfigs } = require('../app/lib/rate-limit')
          |                                               ^
      205 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
      206 |       
      207 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:204:47)

  ‚óè Security Logging Middleware ‚Ä∫ Rate Limiting ‚Ä∫ should add rate limit headers to successful responses

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      215 |
      216 |     it('should add rate limit headers to successful responses', async () => {
    > 217 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      218 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      219 |
      220 |       const request = createMockRequest('/test')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:217:43)

  ‚óè Security Logging Middleware ‚Ä∫ IP Blocking ‚Ä∫ should block requests from blocked IPs

    ReferenceError: middleware is not defined

      236 |       // Make multiple requests to trigger blocking
      237 |       for (let i = 0; i < 11; i++) {
    > 238 |         await middleware(request)
          |         ^
      239 |       }
      240 |
      241 |       // Now the IP should be blocked

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:238:9)

  ‚óè Security Logging Middleware ‚Ä∫ Threat Detection ‚Ä∫ should detect brute force attacks

    ReferenceError: middleware is not defined

      257 |       // Simulate multiple failed login attempts
      258 |       for (let i = 0; i < 6; i++) {
    > 259 |         await middleware(request)
          |         ^
      260 |       }
      261 |
      262 |       expect(consoleErrorSpy).toHaveBeenCalledWith(

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:259:9)

  ‚óè Security Logging Middleware ‚Ä∫ Threat Detection ‚Ä∫ should detect privilege escalation attempts

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      267 |
      268 |     it('should detect privilege escalation attempts', async () => {
    > 269 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      270 |       routePermissionResolver.getRoutePermissions.mockReturnValue([
      271 |         { resource: 'admin', action: 'manage', scope: 'all' }
      272 |       ])

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:269:43)

  ‚óè Security Logging Middleware ‚Ä∫ Threat Detection ‚Ä∫ should detect suspicious IP activity

    ReferenceError: middleware is not defined

      289 |       // Generate multiple violations
      290 |       for (let i = 0; i < 6; i++) {
    > 291 |         await middleware(request)
          |         ^
      292 |       }
      293 |
      294 |       expect(consoleErrorSpy).toHaveBeenCalledWith(

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:291:9)

  ‚óè Security Logging Middleware ‚Ä∫ Threat Detection ‚Ä∫ should detect access to sensitive endpoints

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      300 |     it('should detect access to sensitive endpoints', async () => {
      301 |       mockGetToken.mockResolvedValue(createMockToken({ role: 'EDITOR' }))
    > 302 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      303 |       routePermissionResolver.requiresAuthOnly.mockReturnValue(true)
      304 |
      305 |       const request = createMockRequest('/api/admin/users')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:302:43)

  ‚óè Security Logging Middleware ‚Ä∫ Security Headers ‚Ä∫ should add comprehensive security headers

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      315 |   describe('Security Headers', () => {
      316 |     it('should add comprehensive security headers', async () => {
    > 317 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      318 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      319 |
      320 |       const request = createMockRequest('/test')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:317:43)

  ‚óè Security Logging Middleware ‚Ä∫ Security Headers ‚Ä∫ should include request ID in response headers

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      331 |
      332 |     it('should include request ID in response headers', async () => {
    > 333 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      334 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      335 |
      336 |       const request = createMockRequest('/test')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:333:43)

  ‚óè Security Logging Middleware ‚Ä∫ Security Headers ‚Ä∫ should remove sensitive server headers

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      341 |
      342 |     it('should remove sensitive server headers', async () => {
    > 343 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      344 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      345 |
      346 |       const request = createMockRequest('/test')

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:343:43)

  ‚óè Security Logging Middleware ‚Ä∫ Error Responses ‚Ä∫ should include security information in API error responses

    ReferenceError: middleware is not defined

      357 |
      358 |       const request = createMockRequest('/api/protected')
    > 359 |       const response = await middleware(request)
          |                        ^
      360 |
      361 |       expect(response.status).toBe(401)
      362 |       

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:359:24)

  ‚óè Security Logging Middleware ‚Ä∫ Error Responses ‚Ä∫ should redirect web routes with security context

    ReferenceError: middleware is not defined

      371 |
      372 |       const request = createMockRequest('/protected-page')
    > 373 |       const response = await middleware(request)
          |                        ^
      374 |
      375 |       expect(response.status).toBe(307) // Redirect
      376 |       

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:373:24)

  ‚óè Security Logging Middleware ‚Ä∫ Performance and Cleanup ‚Ä∫ should handle token errors gracefully

    ReferenceError: middleware is not defined

      387 |
      388 |       const request = createMockRequest('/protected')
    > 389 |       const response = await middleware(request)
          |                        ^
      390 |
      391 |       expect(response.status).toBe(401)
      392 |       expect(consoleErrorSpy).toHaveBeenCalledWith(

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:389:24)

  ‚óè Security Logging Middleware ‚Ä∫ Performance and Cleanup ‚Ä∫ should skip middleware for static files

    ReferenceError: middleware is not defined

      398 |     it('should skip middleware for static files', async () => {
      399 |       const request = createMockRequest('/_next/static/test.js')
    > 400 |       const response = await middleware(request)
          |                        ^
      401 |
      402 |       expect(response.status).toBe(200)
      403 |       expect(consoleSpy).not.toHaveBeenCalled()

      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:400:24)

  ‚óè Security Logging Middleware ‚Ä∫ Performance and Cleanup ‚Ä∫ should handle missing IP addresses gracefully

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      409 |       })
      410 |       
    > 411 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      412 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)
      413 |
      414 |       await middleware(request)

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:411:43)

  ‚óè Security Logging Middleware ‚Ä∫ Integration with Existing Systems ‚Ä∫ should work with route permission resolver

    Cannot find module '../app/lib/route-permissions' from '__tests__/unit/middleware-security-logging.test.ts'

      423 |   describe('Integration with Existing Systems', () => {
      424 |     it('should work with route permission resolver', async () => {
    > 425 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
          |                                           ^
      426 |       routePermissionResolver.getRoutePermissions.mockReturnValue([
      427 |         { resource: 'products', action: 'read', scope: 'all' }
      428 |       ])

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:425:43)

  ‚óè Security Logging Middleware ‚Ä∫ Integration with Existing Systems ‚Ä∫ should apply user preferences for non-API routes

    Cannot find module '../app/lib/preferences-middleware' from '__tests__/unit/middleware-security-logging.test.ts'

      438 |
      439 |     it('should apply user preferences for non-API routes', async () => {
    > 440 |       const { applyUserPreferences } = require('../app/lib/preferences-middleware')
          |                                        ^
      441 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
      442 |       
      443 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:440:40)

  ‚óè Security Logging Middleware ‚Ä∫ Integration with Existing Systems ‚Ä∫ should not apply user preferences for API routes

    Cannot find module '../app/lib/preferences-middleware' from '__tests__/unit/middleware-security-logging.test.ts'

      450 |
      451 |     it('should not apply user preferences for API routes', async () => {
    > 452 |       const { applyUserPreferences } = require('../app/lib/preferences-middleware')
          |                                        ^
      453 |       const { routePermissionResolver } = require('../app/lib/route-permissions')
      454 |       
      455 |       routePermissionResolver.isPublicRoute.mockReturnValue(true)

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/middleware-security-logging.test.ts:452:40)

FAIL unit __tests__/unit/security-scenarios-comprehensive.test.ts
  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle JWT signature tampering

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      108 |         const response = await middleware(request)
      109 |         
    > 110 |         expect(response.status).toBe(307) // Redirect to login
          |                                 ^
      111 |         expect(consoleErrorSpy).toHaveBeenCalledWith(
      112 |           'Failed to get token:',
      113 |           expect.any(Error)

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:110:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      121 |         const response = await middleware(request)
      122 |         
    > 123 |         expect(response.status).toBe(401)
          |                                 ^
      124 |         const body = await response.json()
      125 |         expect(body.error.code).toBe('UNAUTHORIZED')
      126 |       })

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:123:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle malformed JWT tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      132 |         const response = await middleware(request)
      133 |         
    > 134 |         expect(response.status).toBe(307)
          |                                 ^
      135 |       })
      136 |
      137 |       it('should handle token with missing claims', async () => {

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:134:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle token with missing claims

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      144 |         const response = await middleware(request)
      145 |         
    > 146 |         expect(response.status).toBe(307) // Should redirect due to invalid token
          |                                 ^
      147 |       })
      148 |
      149 |       it('should handle token with invalid role', async () => {

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:146:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Token Manipulation Attacks ‚Ä∫ should handle token with invalid role

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      157 |         const response = await middleware(request)
      158 |         
    > 159 |         expect(response.status).toBe(307) // Should redirect due to invalid role
          |                                 ^
      160 |       })
      161 |     })
      162 |

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:159:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Brute Force Attack Scenarios ‚Ä∫ should handle rapid authentication attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      221 |         // All should be unauthorized
      222 |         responses.forEach(response => {
    > 223 |           expect(response.status).toBe(401)
          |                                   ^
      224 |         })
      225 |         
      226 |         // Should log multiple unauthorized attempts

      at __tests__/unit/security-scenarios-comprehensive.test.ts:223:35
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:222:19)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authentication Attack Scenarios ‚Ä∫ Brute Force Attack Scenarios ‚Ä∫ should handle distributed brute force attacks

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      246 |           
      247 |           responses.forEach(response => {
    > 248 |             expect(response.status).toBe(307) // Redirect to login
          |                                     ^
      249 |           })
      250 |         }
      251 |       })

      at __tests__/unit/security-scenarios-comprehensive.test.ts:248:37
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:247:21)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Privilege Escalation Attacks ‚Ä∫ should detect vertical privilege escalation

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      286 |             expect(response.status).toBe(403)
      287 |           } else {
    > 288 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      289 |           }
      290 |         }
      291 |       })

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:288:37)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Privilege Escalation Attacks ‚Ä∫ should detect role manipulation attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      300 |         
      301 |         // Should be denied due to invalid role
    > 302 |         expect(response.status).toBe(307)
          |                                 ^
      303 |       })
      304 |     })
      305 |

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:302:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Authorization Attack Scenarios ‚Ä∫ Permission Bypass Attempts ‚Ä∫ should handle method override attacks

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      318 |         
      319 |         // Should still check based on actual method
    > 320 |         expect(response.status).toBe(403)
          |                                 ^
      321 |       })
      322 |
      323 |       it('should handle parameter pollution attacks', async () => {

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:320:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Advanced Security Scenarios ‚Ä∫ Information Disclosure ‚Ä∫ should not leak sensitive information in error responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      600 |         const response = await middleware(request)
      601 |         
    > 602 |         expect(response.status).toBe(401)
          |                                 ^
      603 |         
      604 |         const body = await response.json()
      605 |         // Should not expose internal error details

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:602:33)

  ‚óè Comprehensive Security Scenarios Tests ‚Ä∫ Advanced Security Scenarios ‚Ä∫ Information Disclosure ‚Ä∫ should not expose stack traces

    TypeError: Cannot read properties of undefined (reading 'message')

      615 |         
      616 |         const body = await response.json()
    > 617 |         expect(body.error.message).not.toContain('stack')
          |                           ^
      618 |         expect(body.error.message).not.toContain('at ')
      619 |       })
      620 |     })

      at Object.<anonymous> (__tests__/unit/security-scenarios-comprehensive.test.ts:617:27)

FAIL unit __tests__/unit/admin/users-bulk-operations.test.ts
  ‚óè Console

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:99:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:99:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:125:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:125:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:152:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:152:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:178:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:178:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:199:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:199:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:216:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:216:24)

    console.error
      Error performing bulk operation: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:25:29)
          at POST (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/bulk/route.ts:47:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:235:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at POST (app/api/admin/users/bulk/route.ts:333:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:235:24)

    console.error
      Error fetching user security details: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:13:29)
          at GET (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:70:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:297:33)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at GET (app/api/admin/users/[id]/security/route.ts:210:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:297:24)

    console.error
      Error fetching user security details: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:13:29)
          at GET (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:70:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:313:33)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at GET (app/api/admin/users/[id]/security/route.ts:210:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:313:24)

    console.error
      Error fetching user security details: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:13:29)
          at GET (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:70:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:322:33)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at GET (app/api/admin/users/[id]/security/route.ts:210:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:322:24)

    console.error
      Error fetching user security details: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:13:29)
          at GET (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:70:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:333:33)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at GET (app/api/admin/users/[id]/security/route.ts:210:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:333:24)

    console.error
      Error fetching user security details: TypeError: (0 , auth_1.auth) is not a function
          at requireAdminAccess (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:13:29)
          at GET (/Users/teroleinonen/software projects/cms-admin/app/api/admin/users/[id]/security/route.ts:70:29)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/admin/users-bulk-operations.test.ts:354:33)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at GET (app/api/admin/users/[id]/security/route.ts:210:13)
      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:354:24)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should activate inactive users

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      100 |       const data = await response.json()
      101 |
    > 102 |       expect(response.status).toBe(200)
          |                               ^
      103 |       expect(data.success).toBe(true)
      104 |       expect(data.operation).toBe('activate')
      105 |       expect(data.updated).toBe(1) // Only user-1 was inactive

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:102:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should deactivate active users (except self)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      126 |       const data = await response.json()
      127 |
    > 128 |       expect(response.status).toBe(200)
          |                               ^
      129 |       expect(data.success).toBe(true)
      130 |       expect(data.updated).toBe(1) // Only user-2 was active
      131 |       expect(mockPrisma.user.updateMany).toHaveBeenCalledWith({

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:128:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should change user roles

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      153 |       const data = await response.json()
      154 |
    > 155 |       expect(response.status).toBe(200)
          |                               ^
      156 |       expect(data.success).toBe(true)
      157 |       expect(data.updated).toBe(2)
      158 |       expect(mockPrisma.user.updateMany).toHaveBeenCalledWith({

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:155:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should create password reset tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      179 |       const data = await response.json()
      180 |
    > 181 |       expect(response.status).toBe(200)
          |                               ^
      182 |       expect(data.success).toBe(true)
      183 |       expect(data.updated).toBe(2)
      184 |       expect(mockPrisma.passwordResetToken.create).toHaveBeenCalledTimes(2)

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:181:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should require admin access

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 500

      200 |       const data = await response.json()
      201 |
    > 202 |       expect(response.status).toBe(403)
          |                               ^
      203 |       expect(data.error.code).toBe('FORBIDDEN')
      204 |     })
      205 |

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:202:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should validate request data

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

      217 |       const data = await response.json()
      218 |
    > 219 |       expect(response.status).toBe(400)
          |                               ^
      220 |       expect(data.error.code).toBe('VALIDATION_ERROR')
      221 |     })
      222 |

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:219:31)

  ‚óè /api/admin/users/bulk ‚Ä∫ POST /api/admin/users/bulk ‚Ä∫ should handle missing users

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

      236 |       const data = await response.json()
      237 |
    > 238 |       expect(response.status).toBe(404)
          |                               ^
      239 |       expect(data.error.code).toBe('NOT_FOUND')
      240 |     })
      241 |   })

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:238:31)

  ‚óè /api/admin/users/[id]/security ‚Ä∫ GET /api/admin/users/[id]/security ‚Ä∫ should return user security information

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      298 |       const data = await response.json()
      299 |
    > 300 |       expect(response.status).toBe(200)
          |                               ^
      301 |       expect(data.success).toBe(true)
      302 |       expect(data.security).toBeDefined()
      303 |       expect(data.security.twoFactorEnabled).toBe(true)

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:300:31)

  ‚óè /api/admin/users/[id]/security ‚Ä∫ GET /api/admin/users/[id]/security ‚Ä∫ should require admin access

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 500

      314 |       const data = await response.json()
      315 |
    > 316 |       expect(response.status).toBe(403)
          |                               ^
      317 |       expect(data.error.code).toBe('FORBIDDEN')
      318 |     })
      319 |

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:316:31)

  ‚óè /api/admin/users/[id]/security ‚Ä∫ GET /api/admin/users/[id]/security ‚Ä∫ should validate user ID format

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

      323 |       const data = await response.json()
      324 |
    > 325 |       expect(response.status).toBe(400)
          |                               ^
      326 |       expect(data.error.code).toBe('INVALID_ID')
      327 |     })
      328 |

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:325:31)

  ‚óè /api/admin/users/[id]/security ‚Ä∫ GET /api/admin/users/[id]/security ‚Ä∫ should handle user not found

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

      334 |       const data = await response.json()
      335 |
    > 336 |       expect(response.status).toBe(404)
          |                               ^
      337 |       expect(data.error.code).toBe('NOT_FOUND')
      338 |     })
      339 |

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:336:31)

  ‚óè /api/admin/users/[id]/security ‚Ä∫ GET /api/admin/users/[id]/security ‚Ä∫ should calculate security score correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      355 |       const data = await response.json()
      356 |
    > 357 |       expect(response.status).toBe(200)
          |                               ^
      358 |       expect(data.security.securityScore).toBeGreaterThanOrEqual(80) // High security score
      359 |     })
      360 |   })

      at Object.<anonymous> (__tests__/unit/admin/users-bulk-operations.test.ts:357:31)

FAIL unit __tests__/unit/api-routes-permission-validation.test.ts
  ‚óè API Routes Permission Validation Tests ‚Ä∫ Authentication Validation ‚Ä∫ should reject unauthenticated requests when auth is required

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Authentication Validation ‚Ä∫ should allow unauthenticated requests when auth is not required

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Authentication Validation ‚Ä∫ should handle token retrieval errors

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Authentication Validation ‚Ä∫ should validate token structure

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ HTTP Method Validation ‚Ä∫ should allow specified HTTP methods

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ HTTP Method Validation ‚Ä∫ should reject disallowed HTTP methods

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Permission-Based Validation ‚Ä∫ should validate specific permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Permission-Based Validation ‚Ä∫ should reject insufficient permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Permission-Based Validation ‚Ä∫ should use route-based permissions when none specified

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Permission-Based Validation ‚Ä∫ should handle public routes

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ ADMIN role permissions ‚Ä∫ should allow users:manage:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ ADMIN role permissions ‚Ä∫ should allow products:create:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ ADMIN role permissions ‚Ä∫ should allow security:read:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ EDITOR role permissions ‚Ä∫ should allow products:create:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ EDITOR role permissions ‚Ä∫ should allow products:read:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ EDITOR role permissions ‚Ä∫ should deny users:manage:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ EDITOR role permissions ‚Ä∫ should allow profile:update:own

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ VIEWER role permissions ‚Ä∫ should allow products:read:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ VIEWER role permissions ‚Ä∫ should deny products:create:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ VIEWER role permissions ‚Ä∫ should deny users:read:all

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Role-Based Access Control ‚Ä∫ VIEWER role permissions ‚Ä∫ should allow profile:read:own

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Custom Validation ‚Ä∫ should run custom validator when provided

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Custom Validation ‚Ä∫ should reject when custom validator fails

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Custom Validation ‚Ä∫ should handle custom validator errors

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Owner Access Validation ‚Ä∫ should allow owner access when enabled

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Owner Access Validation ‚Ä∫ should deny non-owner access

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/products endpoint ‚Ä∫ should validate GET method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/products endpoint ‚Ä∫ should reject GET method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/products endpoint ‚Ä∫ should validate POST method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/products endpoint ‚Ä∫ should reject POST method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/admin/users endpoint ‚Ä∫ should validate GET method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/admin/users endpoint ‚Ä∫ should reject GET method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/admin/users endpoint ‚Ä∫ should validate POST method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/admin/users endpoint ‚Ä∫ should reject POST method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should validate GET method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should reject GET method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should validate POST method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should reject POST method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should validate PUT method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should reject PUT method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should validate DELETE method permissions

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ API Endpoint Specific Tests ‚Ä∫ /api/categories endpoint ‚Ä∫ should reject DELETE method for unauthorized roles

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ withApiPermissions Higher-Order Function ‚Ä∫ should wrap handler and apply permission validation

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ withApiPermissions Higher-Order Function ‚Ä∫ should return error when validation fails

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ withApiPermissions Higher-Order Function ‚Ä∫ should handle handler errors gracefully

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Response Format Validation ‚Ä∫ should create standardized success responses

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Response Format Validation ‚Ä∫ should create standardized error responses

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Audit Logging ‚Ä∫ should log successful access attempts

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

  ‚óè API Routes Permission Validation Tests ‚Ä∫ Audit Logging ‚Ä∫ should log security events for violations

    Cannot find module '../app/lib/permissions' from '__tests__/unit/api-routes-permission-validation.test.ts'

      50 |     
      51 |     // Get mocked services
    > 52 |     const { PermissionService } = require('../app/lib/permissions')
         |                                   ^
      53 |     const { RoutePermissionResolver } = require('../app/lib/route-permissions')
      54 |     
      55 |     mockPermissionService = new PermissionService()

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/unit/api-routes-permission-validation.test.ts:52:35)

FAIL unit __tests__/unit/middleware.test.ts
  ‚óè Console

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/security",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.365Z",
        "requestId": "req_1763407834365_bk1yest73",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:209:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/security",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.432Z",
        "requestId": "req_1763407834432_1fa7ftsd7",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:225:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.462Z",
        "requestId": "req_1763407834462_cdtnuegrc",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:197:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.464Z",
        "requestId": "req_1763407834464_yu2by7ykm",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:209:28)

    console.warn
      IP 127.0.0.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at middleware (middleware.ts:149:42)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:225:44)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.498Z",
        "requestId": "req_1763407834468_321kss9ef",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:225:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/security",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.501Z",
        "requestId": "req_1763407834501_rjlev9uv2",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:197:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/security",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.512Z",
        "requestId": "req_1763407834512_ew1dowxiy",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:209:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/security",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.515Z",
        "requestId": "req_1763407834515_gr2c38f31",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:225:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.518Z",
        "requestId": "req_1763407834518_zo0n29j19",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.527Z",
        "requestId": "req_1763407834527_0tnv2k4ba",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products/new",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.530Z",
        "requestId": "req_1763407834530_tozpt5rhe",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products/new",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.533Z",
        "requestId": "req_1763407834533_6ongrg7k4",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/categories",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.534Z",
        "requestId": "req_1763407834534_b93mvrpre",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/categories",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.536Z",
        "requestId": "req_1763407834535_xqdp099to",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/pages",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.546Z",
        "requestId": "req_1763407834546_q5i30x0ba",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/pages",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.551Z",
        "requestId": "req_1763407834551_n2h9ivzzr",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.560Z",
        "requestId": "req_1763407834559_2lrxvxzc0",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.563Z",
        "requestId": "req_1763407834563_m77e1z63q",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.565Z",
        "requestId": "req_1763407834565_t6q44j1rv",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:276:30)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/categories",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.567Z",
        "requestId": "req_1763407834567_gxg7omax7",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:252:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/categories",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.568Z",
        "requestId": "req_1763407834568_uuk7tobwi",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:263:28)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/categories",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.578Z",
        "requestId": "req_1763407834578_zffdzxbx4",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:276:30)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products/123/edit",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.580Z",
        "requestId": "req_1763407834580_rtzhlyy7q",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:291:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users/456",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.583Z",
        "requestId": "req_1763407834583_czoni6i5u",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:302:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products/123/edit",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.592Z",
        "requestId": "req_1763407834592_b7qoxeear",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:313:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.595Z",
        "requestId": "req_1763407834595_xnpwloyfz",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:323:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.599Z",
        "requestId": "req_1763407834598_j5dk42pjv",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:336:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/health",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.600Z",
        "requestId": "req_1763407834600_mdmf71qip",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:346:7)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "192.168.1.1",
        "userAgent": "test-browser",
        "timestamp": "2025-11-17T19:30:34.616Z",
        "requestId": "req_1763407834616_7b23etucm",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:408:7)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/products",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.626Z",
        "requestId": "req_1763407834626_llgmxcwf3",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:426:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.629Z",
        "requestId": "req_1763407834629_tpcvt01qp",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:437:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.632Z",
        "requestId": "req_1763407834632_0jto8gg7a",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:447:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.634Z",
        "requestId": "req_1763407834634_boatgurw5",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:459:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users/123",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.643Z",
        "requestId": "req_1763407834643_fmpb62v58",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:469:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/some/unknown/route",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.646Z",
        "requestId": "req_1763407834645_xj14wzxxu",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:481:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_900s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:30:34.660Z",
        "requestId": "req_1763407834660_aa3rxc3ci",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/unit/middleware.test.ts:519:7)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /auth/login

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /auth/register

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /auth/password-reset

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /api/auth/signin

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /api/health

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /api/csrf-token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /api/public/products

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Public Routes ‚Ä∫ should allow access to public route: /

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "public_route"

    Number of calls: 0

      105 |         expect(response.status).not.toBe(403)
      106 |         expect(mockGetToken).not.toHaveBeenCalled()
    > 107 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      108 |           '[ACCESS_LOG] SUCCESS:',
      109 |           expect.stringContaining('public_route')
      110 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:107:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authentication Required Routes ‚Ä∫ should redirect unauthenticated users to login for web routes

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      120 |       const response = await middleware(request)
      121 |       
    > 122 |       expect(response.status).toBe(307) // Redirect
          |                               ^
      123 |       expect(response.headers.get('location')).toContain('/auth/login')
      124 |       expect(response.headers.get('location')).toContain('callbackUrl=%2Fadmin%2Fproducts')
      125 |     })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:122:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authentication Required Routes ‚Ä∫ should return 401 JSON for unauthenticated API requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      131 |       const response = await middleware(request)
      132 |       
    > 133 |       expect(response.status).toBe(401)
          |                               ^
      134 |       
      135 |       const body = await response.json()
      136 |       expect(body).toEqual({

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:133:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authentication Required Routes ‚Ä∫ should handle token retrieval errors

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      151 |       const response = await middleware(request)
      152 |       
    > 153 |       expect(response.status).toBe(307) // Redirect to login
          |                               ^
      154 |       expect(consoleErrorSpy).toHaveBeenCalledWith('Failed to get token:', expect.any(Error))
      155 |     })
      156 |   })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:153:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authenticated Routes (No Specific Permissions) ‚Ä∫ should allow authenticated users to access: /profile

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "authenticated_route"

    Number of calls: 0

      170 |         expect(response.status).not.toBe(401)
      171 |         expect(response.status).not.toBe(403)
    > 172 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      173 |           '[ACCESS_LOG] SUCCESS:',
      174 |           expect.stringContaining('authenticated_route')
      175 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:172:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authenticated Routes (No Specific Permissions) ‚Ä∫ should allow authenticated users to access: /settings

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "authenticated_route"

    Number of calls: 0

      170 |         expect(response.status).not.toBe(401)
      171 |         expect(response.status).not.toBe(403)
    > 172 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      173 |           '[ACCESS_LOG] SUCCESS:',
      174 |           expect.stringContaining('authenticated_route')
      175 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:172:31)

  ‚óè Route Protection Middleware ‚Ä∫ Authenticated Routes (No Specific Permissions) ‚Ä∫ should allow authenticated users to access: /api/user/preferences

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringContaining "authenticated_route"

    Number of calls: 0

      170 |         expect(response.status).not.toBe(401)
      171 |         expect(response.status).not.toBe(403)
    > 172 |         expect(consoleLogSpy).toHaveBeenCalledWith(
          |                               ^
      173 |           '[ACCESS_LOG] SUCCESS:',
      174 |           expect.stringContaining('authenticated_route')
      175 |         )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:172:31)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {
    > 216 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      217 |           }
      218 |         })
      219 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:216:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      228 |             expect(response.status).toBe(403)
      229 |           } else {
    > 230 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      231 |           }
      232 |         })
      233 |       })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:230:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {
    > 216 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      217 |           }
      218 |         })
      219 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:216:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      228 |             expect(response.status).toBe(403)
      229 |           } else {
    > 230 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      231 |           }
      232 |         })
      233 |       })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:230:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /admin/analytics

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {
    > 216 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      217 |           }
      218 |         })
      219 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:216:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /admin/analytics

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      228 |             expect(response.status).toBe(403)
      229 |           } else {
    > 230 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      231 |           }
      232 |         })
      233 |       })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:230:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /admin/monitoring

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {
    > 216 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      217 |           }
      218 |         })
      219 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:216:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /admin/monitoring

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      228 |             expect(response.status).toBe(403)
      229 |           } else {
    > 230 |             expect(response.status).toBe(307) // Redirect
          |                                     ^
      231 |           }
      232 |         })
      233 |       })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:230:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /api/admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      210 |           
      211 |           if (route.startsWith('/api/')) {
    > 212 |             expect(response.status).toBe(403)
          |                                     ^
      213 |             const body = await response.json()
      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:212:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /api/admin/users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      226 |           
      227 |           if (route.startsWith('/api/')) {
    > 228 |             expect(response.status).toBe(403)
          |                                     ^
      229 |           } else {
      230 |             expect(response.status).toBe(307) // Redirect
      231 |           }

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:228:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny EDITOR access to: /api/admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      210 |           
      211 |           if (route.startsWith('/api/')) {
    > 212 |             expect(response.status).toBe(403)
          |                                     ^
      213 |             const body = await response.json()
      214 |             expect(body.error.code).toBe('FORBIDDEN')
      215 |           } else {

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:212:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Admin Routes ‚Ä∫ should deny VIEWER access to: /api/admin/security

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      226 |           
      227 |           if (route.startsWith('/api/')) {
    > 228 |             expect(response.status).toBe(403)
          |                                     ^
      229 |           } else {
      230 |             expect(response.status).toBe(307) // Redirect
      231 |           }

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:228:37)

  ‚óè Route Protection Middleware ‚Ä∫ Permission-Based Routes ‚Ä∫ Dynamic Routes ‚Ä∫ should deny access to dynamic routes without permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      313 |         const response = await middleware(request)
      314 |         
    > 315 |         expect(response.status).toBe(307) // Redirect for web route
          |                                 ^
      316 |       })
      317 |     })
      318 |   })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:315:33)

  ‚óè Route Protection Middleware ‚Ä∫ Security Headers ‚Ä∫ should add security headers to responses

    expect(received).toBe(expected) // Object.is equality

    Expected: "nosniff"
    Received: undefined

      323 |       const response = await middleware(request)
      324 |       
    > 325 |       expect(response.headers.get('X-Content-Type-Options')).toBe('nosniff')
          |                                                              ^
      326 |       expect(response.headers.get('X-Frame-Options')).toBe('DENY')
      327 |       expect(response.headers.get('X-XSS-Protection')).toBe('1; mode=block')
      328 |       expect(response.headers.get('Referrer-Policy')).toBe('strict-origin-when-cross-origin')

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:325:62)

  ‚óè Route Protection Middleware ‚Ä∫ Security Headers ‚Ä∫ should add HSTS header in production

    expect(received).toBe(expected) // Object.is equality

    Expected: "max-age=31536000; includeSubDomains"
    Received: undefined

      336 |       const response = await middleware(request)
      337 |       
    > 338 |       expect(response.headers.get('Strict-Transport-Security')).toBe('max-age=31536000; includeSubDomains')
          |                                                                 ^
      339 |       
      340 |       process.env.NODE_ENV = originalEnv
      341 |     })

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:338:65)

  ‚óè Route Protection Middleware ‚Ä∫ Security Headers ‚Ä∫ should generate request ID for tracing

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"timestamp":\s*"\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z"/

    Number of calls: 0

      348 |       // The middleware generates request IDs for tracing (visible in logs)
      349 |       // This is tested indirectly through the logging functionality
    > 350 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      351 |         '[ACCESS_LOG] SUCCESS:',
      352 |         expect.stringMatching(/"timestamp":\s*"\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z"/)
      353 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:350:29)

  ‚óè Route Protection Middleware ‚Ä∫ Access Logging ‚Ä∫ should log successful access attempts

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"userId":\s*"user-1"/

    Number of calls: 0

      367 |       await middleware(request)
      368 |       
    > 369 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      370 |         '[ACCESS_LOG] SUCCESS:',
      371 |         expect.stringMatching(/"userId":\s*"user-1"/)
      372 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:369:29)

  ‚óè Route Protection Middleware ‚Ä∫ Access Logging ‚Ä∫ should log unauthorized access attempts

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] UNAUTHORIZED:", StringMatching /"userId":\s*"anonymous"/

    Number of calls: 0

      391 |       await middleware(request)
      392 |       
    > 393 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      394 |         '[ACCESS_LOG] UNAUTHORIZED:',
      395 |         expect.stringMatching(/"userId":\s*"anonymous"/)
      396 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:393:29)

  ‚óè Route Protection Middleware ‚Ä∫ Access Logging ‚Ä∫ should log forbidden access attempts

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] FORBIDDEN:", StringMatching /"userId":\s*"user-1"/

    Number of calls: 0

      408 |       await middleware(request)
      409 |       
    > 410 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      411 |         '[ACCESS_LOG] FORBIDDEN:',
      412 |         expect.stringMatching(/"userId":\s*"user-1"/)
      413 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:410:29)

  ‚óè Route Protection Middleware ‚Ä∫ Error Handling ‚Ä∫ should handle missing token gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      426 |       const response = await middleware(request)
      427 |       
    > 428 |       expect(response.status).toBe(307) // Redirect
          |                               ^
      429 |       expect(response.headers.get('location')).toContain('/auth/login')
      430 |     })
      431 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:428:31)

  ‚óè Route Protection Middleware ‚Ä∫ Error Handling ‚Ä∫ should handle token with missing role

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      437 |       const response = await middleware(request)
      438 |       
    > 439 |       expect(response.status).toBe(307) // Should redirect due to insufficient permissions
          |                               ^
      440 |     })
      441 |
      442 |     it('should handle token with invalid role', async () => {

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:439:31)

  ‚óè Route Protection Middleware ‚Ä∫ Error Handling ‚Ä∫ should handle token with invalid role

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      447 |       const response = await middleware(request)
      448 |       
    > 449 |       expect(response.status).toBe(307) // Should redirect due to insufficient permissions
          |                               ^
      450 |     })
      451 |   })
      452 |

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:449:31)

  ‚óè Route Protection Middleware ‚Ä∫ IP Address and User Agent Tracking ‚Ä∫ should extract IP from x-forwarded-for header

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"ipAddress":\s*"203\.0\.113\.1, 192\.168\.1\.1"/

    Number of calls: 0

      494 |       await middleware(request)
      495 |       
    > 496 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      497 |         '[ACCESS_LOG] SUCCESS:',
      498 |         expect.stringMatching(/"ipAddress":\s*"203\.0\.113\.1, 192\.168\.1\.1"/)
      499 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:496:29)

  ‚óè Route Protection Middleware ‚Ä∫ IP Address and User Agent Tracking ‚Ä∫ should extract IP from x-real-ip header when x-forwarded-for is not present

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"ipAddress":\s*"203\.0\.113\.1"/

    Number of calls: 0

      508 |       await middleware(request)
      509 |       
    > 510 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      511 |         '[ACCESS_LOG] SUCCESS:',
      512 |         expect.stringMatching(/"ipAddress":\s*"203\.0\.113\.1"/)
      513 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:510:29)

  ‚óè Route Protection Middleware ‚Ä∫ IP Address and User Agent Tracking ‚Ä∫ should use "unknown" when no IP headers are present

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"ipAddress":\s*"unknown"/

    Number of calls: 0

      519 |       await middleware(request)
      520 |       
    > 521 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      522 |         '[ACCESS_LOG] SUCCESS:',
      523 |         expect.stringMatching(/"ipAddress":\s*"unknown"/)
      524 |       )

      at Object.<anonymous> (__tests__/unit/middleware.test.ts:521:29)

FAIL unit __tests__/unit/security-monitoring.test.ts
  ‚óè Console

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:72:23)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:72:23)

    console.error
      Failed to check alert conditions: TypeError: Cannot read properties of undefined (reading 'count')
          at SecurityMonitoringService.checkAlertConditions (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:341:55)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:288:18)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:98:23)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.checkAlertConditions (app/lib/security-monitoring.ts:355:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:288:18)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:98:23)

    console.error
      Failed to perform real-time analysis: TypeError: Cannot read properties of undefined (reading 'findMany')
          at SecurityMonitoringService.analyzeIPBehavior (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:599:52)
          at SecurityMonitoringService.performRealTimeAnalysis (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:526:20)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:292:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:98:23)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.performRealTimeAnalysis (app/lib/security-monitoring.ts:533:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:292:9)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:98:23)

    console.log
      Security event logged: BRUTE_FORCE_ATTACK (CRITICAL) - ID: event-123

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:295:15)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:117:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:117:7)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:134:9)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:134:9)

    console.error
      Failed to check alert conditions: TypeError: Cannot read properties of undefined (reading 'count')
          at SecurityMonitoringService.checkAlertConditions (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:341:55)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:288:18)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:180:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.checkAlertConditions (app/lib/security-monitoring.ts:355:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:288:18)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:180:7)

    console.error
      Failed to perform real-time analysis: TypeError: Cannot read properties of undefined (reading 'findMany')
          at SecurityMonitoringService.analyzeIPBehavior (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:599:52)
          at SecurityMonitoringService.performRealTimeAnalysis (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:526:20)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:292:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:180:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.performRealTimeAnalysis (app/lib/security-monitoring.ts:533:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:292:9)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:180:7)

    console.log
      Security event logged: BRUTE_FORCE_ATTACK (CRITICAL) - ID: event-123

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:295:15)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:233:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:233:7)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:256:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:256:7)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:280:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:280:7)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:313:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:313:7)

    console.error
      Failed to log security event: TypeError: Cannot read properties of undefined (reading 'create')
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:270:36)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:343:7)

    console.error
      Failed to check alert conditions: TypeError: Cannot read properties of undefined (reading 'count')
          at SecurityMonitoringService.checkAlertConditions (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:341:55)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:288:18)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:374:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.checkAlertConditions (app/lib/security-monitoring.ts:355:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:288:18)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:374:7)

    console.error
      Failed to perform real-time analysis: TypeError: Cannot read properties of undefined (reading 'findMany')
          at SecurityMonitoringService.analyzeIPBehavior (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:599:52)
          at SecurityMonitoringService.performRealTimeAnalysis (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:526:20)
          at SecurityMonitoringService.logSecurityEvent (/Users/teroleinonen/software projects/cms-admin/app/lib/security-monitoring.ts:292:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:374:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.performRealTimeAnalysis (app/lib/security-monitoring.ts:533:15)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:292:9)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:374:7)

    console.error
      Failed to log security event: Error: Database error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:428:60)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:436:7)

    console.error
      Failed to log security event: Error: Database error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/security-monitoring.test.ts:428:60)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:299:15)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:450:23)

  ‚óè SecurityMonitoringService ‚Ä∫ logSecurityEvent ‚Ä∫ should log a security event successfully

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:72:23)

  ‚óè SecurityMonitoringService ‚Ä∫ logSecurityEvent ‚Ä∫ should skip analysis when skipAnalysis is true

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:117:7)

  ‚óè SecurityMonitoringService ‚Ä∫ logSecurityEvent ‚Ä∫ should enforce rate limiting

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:134:9)

  ‚óè SecurityMonitoringService ‚Ä∫ isIPBlocked ‚Ä∫ should return true for blocked IP after blocking

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      181 |
      182 |       // The IP should be blocked after the alert triggers
    > 183 |       expect(service.isIPBlocked('192.168.1.1')).toBe(true);
          |                                                  ^
      184 |     });
      185 |   });
      186 |

      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:183:50)

  ‚óè SecurityMonitoringService ‚Ä∫ alert conditions ‚Ä∫ should trigger alert when threshold is exceeded

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:233:7)

  ‚óè SecurityMonitoringService ‚Ä∫ alert conditions ‚Ä∫ should not trigger alert when threshold is not exceeded

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:256:7)

  ‚óè SecurityMonitoringService ‚Ä∫ alert conditions ‚Ä∫ should respect cooldown periods

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:280:7)

  ‚óè SecurityMonitoringService ‚Ä∫ real-time analysis ‚Ä∫ should detect brute force attacks

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:313:7)

  ‚óè SecurityMonitoringService ‚Ä∫ real-time analysis ‚Ä∫ should detect multiple IP access

    TypeError: Cannot read properties of undefined (reading 'create')

      268 |       // Log to audit trail using AuditLog directly
      269 |       if (eventData.userId) {
    > 270 |         await this.prisma.auditLog.create({
          |                                    ^
      271 |           data: {
      272 |             userId: eventData.userId,
      273 |             action: 'SECURITY_LOG',

      at SecurityMonitoringService.logSecurityEvent (app/lib/security-monitoring.ts:270:36)
      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:343:7)

  ‚óè SecurityMonitoringService ‚Ä∫ real-time analysis ‚Ä∫ should detect coordinated attacks

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"details": ObjectContaining {"reason": "Coordinated attack detected"}, "severity": "HIGH", "type": "SUSPICIOUS_ACTIVITY"}
    Received: {"action": undefined, "details": {"metadata": undefined, "reason": "Access denied"}, "ipAddress": "192.168.1.6", "resource": undefined, "severity": "HIGH", "type": "UNAUTHORIZED_ACCESS", "userAgent": undefined, "userId": undefined}

    Number of calls: 1

      375 |
      376 |       // Should create a coordinated attack event
    > 377 |       expect(SecurityEventDB.create).toHaveBeenCalledWith(
          |                                      ^
      378 |         expect.objectContaining({
      379 |           type: SECURITY_EVENT_TYPES.SUSPICIOUS_ACTIVITY,
      380 |           severity: SECURITY_SEVERITY.HIGH,

      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:377:38)

  ‚óè SecurityMonitoringService ‚Ä∫ error handling ‚Ä∫ should handle audit service errors gracefully

    Database error

      426 |     it('should handle database errors gracefully', async () => {
      427 |       const { SecurityEventDB } = require('../../app/lib/permission-db');
    > 428 |       SecurityEventDB.create = jest.fn().mockRejectedValue(new Error('Database error'));
          |                                                            ^
      429 |
      430 |       const eventData = {
      431 |         type: SECURITY_EVENT_TYPES.UNAUTHORIZED_ACCESS,

      at Object.<anonymous> (__tests__/unit/security-monitoring.test.ts:428:60)

FAIL unit __tests__/unit/client-security.test.ts
  ‚óè ClientInputSanitizer ‚Ä∫ sanitizeText ‚Ä∫ should sanitize basic text input

    expect(received).toBe(expected) // Object.is equality

    Expected: "Hello  World"
    Received: "Hello World"

      41 |       const input = 'Hello <script>alert("xss")</script> World'
      42 |       const result = ClientInputSanitizer.sanitizeText(input)
    > 43 |       expect(result).toBe('Hello  World')
         |                      ^
      44 |     })
      45 |
      46 |     it('should remove dangerous protocols', () => {

      at Object.<anonymous> (__tests__/unit/client-security.test.ts:43:22)

  ‚óè ClientInputSanitizer ‚Ä∫ sanitizeText ‚Ä∫ should remove dangerous protocols

    ClientValidationError: Input contains potentially dangerous content

      123 |     for (const pattern of CLIENT_SECURITY_CONFIG.dangerousPatterns) {
      124 |       if (pattern.test(sanitized)) {
    > 125 |         throw new ClientValidationError('Input contains potentially dangerous content', 'DANGEROUS_CONTENT')
          |               ^
      126 |       }
      127 |     }
      128 |

      at ClientInputSanitizer.sanitizeText (app/lib/client-security.ts:125:15)
      at Object.<anonymous> (__tests__/unit/client-security.test.ts:48:43)

  ‚óè ClientInputSanitizer ‚Ä∫ sanitizeText ‚Ä∫ should throw error for suspicious content

    expect(received).toThrow(expected)

    Expected constructor: ClientValidationError

    Received function did not throw

      58 |     it('should throw error for suspicious content', () => {
      59 |       const input = 'SELECT * FROM users WHERE password = "admin"'
    > 60 |       expect(() => ClientInputSanitizer.sanitizeText(input)).toThrow(ClientValidationError)
         |                                                              ^
      61 |     })
      62 |
      63 |     it('should handle non-string input', () => {

      at Object.<anonymous> (__tests__/unit/client-security.test.ts:60:62)

  ‚óè ClientInputSanitizer ‚Ä∫ sanitizeObject ‚Ä∫ should skip dangerous keys

    expect(received).toBeUndefined()

    Received: {}

      168 |       const result = ClientInputSanitizer.sanitizeObject(obj)
      169 |       expect(result.name).toBe('John')
    > 170 |       expect(result.__proto__).toBeUndefined()
          |                                ^
      171 |       expect(result.constructor).toBeUndefined()
      172 |       expect(result.prototype).toBeUndefined()
      173 |     })

      at Object.<anonymous> (__tests__/unit/client-security.test.ts:170:32)

  ‚óè ClientXSSPrevention ‚Ä∫ sanitizeForXSS ‚Ä∫ should sanitize safe content

    expect(received).toBe(expected) // Object.is equality

    Expected: "Safe text content"
    Received: ""

      248 |       const input = 'Safe text content'
      249 |       const result = ClientXSSPrevention.sanitizeForXSS(input)
    > 250 |       expect(result).toBe('Safe text content')
          |                      ^
      251 |     })
      252 |   })
      253 | })

      at Object.<anonymous> (__tests__/unit/client-security.test.ts:250:22)

FAIL unit __tests__/unit/input-validation.test.ts
  ‚óè AdvancedInputSanitizer ‚Ä∫ sanitizeText ‚Ä∫ should remove dangerous protocols

    expect(received).toBe(expected) // Object.is equality

    Expected: "Click here: normal text"
    Received: "Click here normal text"

      27 |       const input = 'Click here: normal text'
      28 |       const result = AdvancedInputSanitizer.sanitizeText(input)
    > 29 |       expect(result).toBe('Click here: normal text')
         |                      ^
      30 |     })
      31 |
      32 |     it('should throw error for suspicious content', () => {

      at Object.<anonymous> (__tests__/unit/input-validation.test.ts:29:22)

FAIL unit __tests__/unit/api-permission-middleware.test.ts
  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should allow access for authenticated user with correct permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      59 |       });
      60 |
    > 61 |       expect(result.isAuthorized).toBe(true);
         |                                   ^
      62 |       expect(result.user).toEqual(mockUser);
      63 |       expect(result.error).toBeUndefined();
      64 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:61:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should deny access for unauthenticated user when auth is required

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      72 |       });
      73 |
    > 74 |       expect(result.isAuthorized).toBe(false);
         |                                   ^
      75 |       expect(result.user).toBeNull();
      76 |       expect(result.error).toBeDefined();
      77 |       expect(result.error?.status).toBe(401);

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:74:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should deny access for user without required permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      94 |       });
      95 |
    > 96 |       expect(result.isAuthorized).toBe(false);
         |                                   ^
      97 |       expect(result.user).toEqual(mockUser);
      98 |       expect(result.error).toBeDefined();
      99 |       expect(result.error?.status).toBe(403);

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:96:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should deny access for disallowed HTTP methods

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      114 |       });
      115 |
    > 116 |       expect(result.isAuthorized).toBe(false);
          |                                   ^
      117 |       expect(result.error).toBeDefined();
      118 |       expect(result.error?.status).toBe(405);
      119 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:116:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should skip permission check when specified

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      133 |       });
      134 |
    > 135 |       expect(result.isAuthorized).toBe(true);
          |                                   ^
      136 |       expect(result.user).toEqual(mockUser);
      137 |       expect(mockPermissionService.hasPermission).not.toHaveBeenCalled();
      138 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:135:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should run custom validator when provided

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      155 |       });
      156 |
    > 157 |       expect(result.isAuthorized).toBe(false);
          |                                   ^
      158 |       expect(customValidator).toHaveBeenCalledWith(mockUser, request);
      159 |       expect(result.error?.status).toBe(403);
      160 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:157:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ validatePermissions ‚Ä∫ should handle token errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      166 |       const result = await middleware.validatePermissions(request);
      167 |
    > 168 |       expect(result.isAuthorized).toBe(false);
          |                                   ^
      169 |       expect(result.error).toBeDefined();
      170 |       expect(result.error?.status).toBe(401);
      171 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:168:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ withApiPermissions HOF ‚Ä∫ should wrap handler and apply permission validation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"cookies": {"get": [Function mockConstructor], "set": [Function mockConstructor]}, "geo": {}, "headers": Map {}, "ip": "127.0.0.1", "method": "GET", "nextUrl": {"href": "http://localhost:3000/api/products", "origin": "http://localhost:3000", "pathname": "/api/products", "search": "", "searchParams": {}}, "url": "http://localhost:3000/api/products"},
    - {"params": undefined, "user": {"email": "test@example.com", "id": "user-1", "name": "Test User", "role": "ADMIN"}},

    Number of calls: 1

      195 |       const response = await wrappedHandler(request);
      196 |
    > 197 |       expect(mockHandler).toHaveBeenCalledWith(request, { 
          |                           ^
      198 |         user: mockUser, 
      199 |         params: undefined 
      200 |       });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:197:27)

  ‚óè ApiPermissionMiddleware ‚Ä∫ withApiPermissions HOF ‚Ä∫ should return error response when permission validation fails

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: {"cookies": {"get": [Function mockConstructor], "set": [Function mockConstructor]}, "geo": {}, "headers": Map {}, "ip": "127.0.0.1", "method": "GET", "nextUrl": {"href": "http://localhost:3000/api/products", "origin": "http://localhost:3000", "pathname": "/api/products", "search": "", "searchParams": {}}, "url": "http://localhost:3000/api/products"}

      213 |       const response = await wrappedHandler(request);
      214 |
    > 215 |       expect(mockHandler).not.toHaveBeenCalled();
          |                               ^
      216 |       expect(response.status).toBe(401);
      217 |     });
      218 |

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:215:31)

  ‚óè ApiPermissionMiddleware ‚Ä∫ withApiPermissions HOF ‚Ä∫ should handle handler errors gracefully

    Handler error

      226 |       });
      227 |
    > 228 |       const mockHandler = jest.fn().mockRejectedValue(new Error('Handler error'));
          |                                                       ^
      229 |       const wrappedHandler = withApiPermissions(mockHandler, {
      230 |         skipPermissionCheck: true
      231 |       });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:228:55)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Error Response Format ‚Ä∫ should create standardized error responses

    TypeError: Cannot read properties of null (reading 'json')

      252 |       expect(result.error).toBeDefined();
      253 |       const response = result.error!;
    > 254 |       const responseData = await response.json();
          |                                           ^
      255 |
      256 |       expect(responseData).toHaveProperty('error');
      257 |       expect(responseData).toHaveProperty('success', false);

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:254:43)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Success Response Format ‚Ä∫ should create standardized success responses

    TypeError: middleware.createSuccessResponse is not a function

      265 |     it('should create standardized success responses', () => {
      266 |       const testData = { id: 1, name: 'Test' };
    > 267 |       const response = middleware.createSuccessResponse(testData);
          |                                   ^
      268 |
      269 |       expect(response.status).toBe(200);
      270 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:267:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Success Response Format ‚Ä∫ should create success responses with custom status

    TypeError: middleware.createSuccessResponse is not a function

      272 |     it('should create success responses with custom status', () => {
      273 |       const testData = { id: 1, name: 'Test' };
    > 274 |       const response = middleware.createSuccessResponse(testData, 201);
          |                                   ^
      275 |
      276 |       expect(response.status).toBe(201);
      277 |     });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:274:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Role-based Access Control ‚Ä∫ should allow admin access to all resources

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      295 |       });
      296 |
    > 297 |       expect(result.isAuthorized).toBe(true);
          |                                   ^
      298 |     });
      299 |
      300 |     it('should restrict viewer access to read-only operations', async () => {

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:297:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Role-based Access Control ‚Ä∫ should restrict viewer access to read-only operations

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      314 |       });
      315 |
    > 316 |       expect(result.isAuthorized).toBe(false);
          |                                   ^
      317 |       expect(result.error?.status).toBe(403);
      318 |     });
      319 |

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:316:35)

  ‚óè ApiPermissionMiddleware ‚Ä∫ Role-based Access Control ‚Ä∫ should allow editor access to content management

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      334 |       });
      335 |
    > 336 |       expect(result.isAuthorized).toBe(true);
          |                                   ^
      337 |     });
      338 |   });
      339 | });

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:336:35)

  ‚óè Permission Decorators ‚Ä∫ should apply requirePermissions decorator correctly

    ReferenceError: createMockUser is not defined

      345 |
      346 |   it('should apply requirePermissions decorator correctly', async () => {
    > 347 |     const mockUser = createMockUser(UserRole.ADMIN);
          |                      ^
      348 |     mockGetToken.mockResolvedValue({
      349 |       id: mockUser.id,
      350 |       email: mockUser.email,

      at Object.<anonymous> (__tests__/unit/api-permission-middleware.test.ts:347:22)

FAIL unit __tests__/unit/production-monitoring.test.ts
  ‚óè Console

    console.log
      Starting RBAC-only backup: rbac_1763407850632_a6hichghj

      at BackupRecoverySystem.createRBACOnlyBackup (app/lib/backup-recovery-system.ts:183:13)

    console.log
      Starting maintenance task: permission_cache_cleanup

      at MaintenanceProcedures.runMaintenanceTask (app/lib/maintenance-procedures.ts:222:15)

    console.log
      Starting permission cache cleanup...

      at app/lib/maintenance-procedures.ts:46:15

    console.log
      Permission cache cleanup completed (in-memory cache)

      at app/lib/maintenance-procedures.ts:49:15

    console.log
      Maintenance task completed: permission_cache_cleanup (35ms)

      at MaintenanceProcedures.runMaintenanceTask (app/lib/maintenance-procedures.ts:230:15)

    console.log
      Starting maintenance task: permission_cache_cleanup

      at MaintenanceProcedures.runMaintenanceTask (app/lib/maintenance-procedures.ts:222:15)

    console.log
      Starting permission cache cleanup...

      at app/lib/maintenance-procedures.ts:46:15

    console.log
      Permission cache cleanup completed (in-memory cache)

      at app/lib/maintenance-procedures.ts:49:15

    console.log
      Maintenance task completed: permission_cache_cleanup (1ms)

      at MaintenanceProcedures.runMaintenanceTask (app/lib/maintenance-procedures.ts:230:15)

    console.log
      Enabling maintenance mode: System update

      at MaintenanceProcedures.enableMaintenanceMode (app/lib/maintenance-procedures.ts:322:13)

  ‚óè ProductionHealthMonitor ‚Ä∫ getSystemHealth ‚Ä∫ should return healthy status when all metrics are good

    expect(received).toBe(expected) // Object.is equality

    Expected: "healthy"
    Received: "critical"

      64 |       const health = await healthMonitor.getSystemHealth()
      65 |
    > 66 |       expect(health.overall).toBe('healthy')
         |                              ^
      67 |       expect(health.metrics).toHaveLength(5) // database, permission_cache, memory, active_sessions, security_events
      68 |       expect(health.uptime).toBeGreaterThan(0)
      69 |     })

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:66:30)

  ‚óè ProductionHealthMonitor ‚Ä∫ logHealthMetrics ‚Ä∫ should log health metrics to audit system

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "data": ObjectContaining {
    +   "data": Object {
          "action": "HEALTH_CHECK",
    +     "details": Object {
    +       "metrics": Array [
    +         Object {
    +           "name": "database",
    +           "status": "healthy",
    +           "threshold": 100,
    +           "timestamp": 2025-11-17T19:30:50.597Z,
    +           "unit": "ms",
    +           "value": 0.2951099999991129,
    +         },
    +         Object {
    +           "details": Object {
    +             "cache_type": "in_memory",
    +           },
    +           "name": "permission_cache",
    +           "status": "healthy",
    +           "threshold": 50,
    +           "timestamp": 2025-11-17T19:30:50.597Z,
    +           "unit": "ms",
    +           "value": 0.0004270000063115731,
    +         },
    +         Object {
    +           "details": Object {
    +             "heap_total_mb": 336,
    +             "heap_used_mb": 253,
    +             "rss_mb": 432,
    +           },
    +           "name": "memory",
    +           "status": "warning",
    +           "threshold": 70,
    +           "timestamp": 2025-11-17T19:30:50.597Z,
    +           "unit": "%",
    +           "value": 75.25402668586625,
    +         },
    +         Object {
    +           "name": "active_sessions",
    +           "status": "healthy",
    +           "threshold": 1000,
    +           "timestamp": 2025-11-17T19:30:50.597Z,
    +           "unit": "users",
    +           "value": 50,
    +         },
    +         Object {
    +           "details": Object {
    +             "error": "this.prisma.auditLog.count is not a function",
    +           },
    +           "name": "security_events",
    +           "status": "critical",
    +           "threshold": 0,
    +           "timestamp": 2025-11-17T19:30:50.597Z,
    +           "unit": "events",
    +           "value": -1,
    +         },
    +       ],
    +       "overall_status": "critical",
    +       "uptime": 0,
    +     },
    +     "ipAddress": "127.0.0.1",
          "resource": "system",
    -     "success": true,
    +     "userAgent": "ProductionHealthMonitor",
          "userId": "system",
        },
      },

    Number of calls: 1

      109 |       await healthMonitor.logHealthMetrics()
      110 |
    > 111 |       expect(mockPrisma.auditLog.create).toHaveBeenCalledWith({
          |                                          ^
      112 |         data: expect.objectContaining({
      113 |           userId: 'system',
      114 |           action: 'HEALTH_CHECK',

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:111:42)

  ‚óè BackupRecoverySystem ‚Ä∫ createRBACOnlyBackup ‚Ä∫ should create RBAC-only backup successfully

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      141 |       mockPrisma.permissionCache.findMany.mockResolvedValue([])
      142 |       mockPrisma.auditLog.findMany.mockResolvedValue([])
    > 143 |       mockPrisma.securityEvent.findMany.mockResolvedValue([])
          |                                         ^
      144 |
      145 |       // Mock file system operations
      146 |       const fs = require('fs/promises')

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:143:41)

  ‚óè MaintenanceProcedures ‚Ä∫ runMaintenanceTask ‚Ä∫ should run permission cache cleanup task

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      218 |       expect(result.status).toBe('completed')
      219 |       expect(result.duration).toBeGreaterThan(0)
    > 220 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalled()
          |                                                     ^
      221 |     })
      222 |
      223 |     it('should handle task failure', async () => {

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:220:53)

  ‚óè MaintenanceProcedures ‚Ä∫ runMaintenanceTask ‚Ä∫ should handle task failure

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"description": "Automated maintenance task: permission_cache_cleanup", "duration": 1, "frequency": "on_demand", "id": "permission_cache_cleanup", "lastRun": 2025-11-17T19:30:50.766Z, "name": "PERMISSION CACHE CLEANUP", "status": "completed"}

      225 |       mockPrisma.auditLog.create.mockResolvedValue({})
      226 |
    > 227 |       await expect(
          |                   ^
      228 |         maintenanceProcedures.runMaintenanceTask('permission_cache_cleanup')
      229 |       ).rejects.toThrow('Database error')
      230 |     })

      at expect (node_modules/expect/build/index.js:2116:15)
      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:227:19)

  ‚óè MaintenanceProcedures ‚Ä∫ enableMaintenanceMode ‚Ä∫ should enable maintenance mode and log event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"data": ObjectContaining {"details": ObjectContaining {"reason": "System update", "type": "MAINTENANCE_MODE_ENABLED"}, "severity": "MEDIUM", "type": "SUSPICIOUS_ACTIVITY"}}

    Number of calls: 0

      243 |       await maintenanceProcedures.enableMaintenanceMode('System update')
      244 |
    > 245 |       expect(mockPrisma.securityEvent.create).toHaveBeenCalledWith({
          |                                               ^
      246 |         data: expect.objectContaining({
      247 |           type: 'SUSPICIOUS_ACTIVITY',
      248 |           severity: 'MEDIUM',

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:245:47)

  ‚óè MaintenanceProcedures ‚Ä∫ runDailyMaintenance ‚Ä∫ should run all daily maintenance tasks

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      263 |       // Mock all required database operations
      264 |       mockPrisma.permissionCache.deleteMany.mockResolvedValue({ count: 5 })
    > 265 |       mockPrisma.securityEvent.deleteMany.mockResolvedValue({ count: 3 })
          |                                           ^
      266 |       mockPrisma.$queryRaw.mockResolvedValue([{ result: 1 }])
      267 |       mockPrisma.permissionCache.count.mockResolvedValue(100)
      268 |       mockPrisma.user.count.mockResolvedValue(50)

      at Object.<anonymous> (__tests__/unit/production-monitoring.test.ts:265:43)

FAIL unit __tests__/unit/permission-db.test.ts
  ‚óè PermissionCacheDB ‚Ä∫ get ‚Ä∫ should return cached permission result

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      76 |       const result = await PermissionCacheDB.get('user1', 'products', 'read', 'all');
      77 |
    > 78 |       expect(result).toBe(true);
         |                      ^
      79 |       expect(mockPrisma.permissionCache.findUnique).toHaveBeenCalledWith({
      80 |         where: {
      81 |           userId_resource_action_scope: {

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:78:22)

  ‚óè PermissionCacheDB ‚Ä∫ get ‚Ä∫ should return null and delete expired cache entry

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      114 |
      115 |       expect(result).toBeNull();
    > 116 |       expect(mockPrisma.permissionCache.delete).toHaveBeenCalled();
          |                                                 ^
      117 |     });
      118 |
      119 |     it('should handle database errors gracefully', async () => {

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:116:49)

  ‚óè PermissionCacheDB ‚Ä∫ set ‚Ä∫ should upsert cache entry

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"create": ObjectContaining {"action": "read", "expiresAt": Any<Date>, "resource": "products", "result": true, "scope": "all", "userId": "user1"}, "update": ObjectContaining {"createdAt": Any<Date>, "expiresAt": Any<Date>, "result": true}, "where": {"userId_resource_action_scope": {"action": "read", "resource": "products", "scope": "all", "userId": "user1"}}}

    Number of calls: 0

      132 |       await PermissionCacheDB.set('user1', 'products', 'read', true, 300000, 'all');
      133 |
    > 134 |       expect(mockPrisma.permissionCache.upsert).toHaveBeenCalledWith({
          |                                                 ^
      135 |         where: {
      136 |           userId_resource_action_scope: {
      137 |             userId: 'user1',

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:134:49)

  ‚óè PermissionCacheDB ‚Ä∫ set ‚Ä∫ should handle null scope

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"userId_resource_action_scope": {"action": "read", "resource": "products", "scope": null, "userId": "user1"}}}

    Number of calls: 0

      162 |       await PermissionCacheDB.set('user1', 'products', 'read', true);
      163 |
    > 164 |       expect(mockPrisma.permissionCache.upsert).toHaveBeenCalledWith(
          |                                                 ^
      165 |         expect.objectContaining({
      166 |           where: {
      167 |             userId_resource_action_scope: {

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:164:49)

  ‚óè PermissionCacheDB ‚Ä∫ invalidateUser ‚Ä∫ should delete all cache entries for user

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"where": {"userId": "user1"}}

    Number of calls: 0

      183 |       await PermissionCacheDB.invalidateUser('user1');
      184 |
    > 185 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
          |                                                     ^
      186 |         where: { userId: 'user1' }
      187 |       });
      188 |     });

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:185:53)

  ‚óè PermissionCacheDB ‚Ä∫ invalidateResource ‚Ä∫ should delete all cache entries for resource

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"where": {"resource": "products"}}

    Number of calls: 0

      195 |       await PermissionCacheDB.invalidateResource('products');
      196 |
    > 197 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
          |                                                     ^
      198 |         where: { resource: 'products' }
      199 |       });
      200 |     });

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:197:53)

  ‚óè PermissionCacheDB ‚Ä∫ clearExpired ‚Ä∫ should delete expired cache entries

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 0

      207 |       const result = await PermissionCacheDB.clearExpired();
      208 |
    > 209 |       expect(result).toBe(10);
          |                      ^
      210 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
      211 |         where: {
      212 |           expiresAt: {

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:209:22)

  ‚óè PermissionCacheDB ‚Ä∫ getStats ‚Ä∫ should return cache statistics

    expect(received).toEqual(expected) // deep equality

    - Expected  - 12
    + Received  +  3

      Object {
    -   "expiredEntries": 10,
    -   "totalEntries": 100,
    -   "userCounts": Array [
    -     Object {
    -       "count": 25,
    -       "userId": "user1",
    -     },
    -     Object {
    -       "count": 15,
    -       "userId": "user2",
    -     },
    -   ],
    +   "expiredEntries": 0,
    +   "totalEntries": 0,
    +   "userCounts": Array [],
      }

      231 |       const stats = await PermissionCacheDB.getStats();
      232 |
    > 233 |       expect(stats).toEqual({
          |                     ^
      234 |         totalEntries: 100,
      235 |         expiredEntries: 10,
      236 |         userCounts: [

      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:233:21)

  ‚óè SecurityEventDB ‚Ä∫ create ‚Ä∫ should create security event

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      200 |   }): Promise<string> {
      201 |     try {
    > 202 |       const auditLog = await db.auditLog.create({
          |                                 ^
      203 |         data: {
      204 |           userId: event.userId || 'system',
      205 |           action: `SECURITY_EVENT_${event.type}`,

      at SecurityEventDB.create (app/lib/permission-db.ts:202:33)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:266:45)

  ‚óè SecurityEventDB ‚Ä∫ create ‚Ä∫ should use default severity

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      200 |   }): Promise<string> {
      201 |     try {
    > 202 |       const auditLog = await db.auditLog.create({
          |                                 ^
      203 |         data: {
      204 |           userId: event.userId || 'system',
      205 |           action: `SECURITY_EVENT_${event.type}`,

      at SecurityEventDB.create (app/lib/permission-db.ts:202:33)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:296:29)

  ‚óè SecurityEventDB ‚Ä∫ getEvents ‚Ä∫ should return paginated security events

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      259 |
      260 |       const [events, total] = await Promise.all([
    > 261 |         db.auditLog.findMany({
          |            ^
      262 |           where,
      263 |           include: {
      264 |             user: {

      at SecurityEventDB.getEvents (app/lib/permission-db.ts:261:12)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:318:44)

  ‚óè SecurityEventDB ‚Ä∫ resolve ‚Ä∫ should resolve security event

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      300 |   static async resolve(eventId: string, resolvedBy: string): Promise<void> {
      301 |     try {
    > 302 |       const event = await db.auditLog.findUnique({
          |                              ^
      303 |         where: { id: eventId }
      304 |       });
      305 |

      at SecurityEventDB.resolve (app/lib/permission-db.ts:302:30)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:348:29)

  ‚óè RoleChangeHistoryDB ‚Ä∫ recordChange ‚Ä∫ should record role change

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      390 |   ): Promise<string> {
      391 |     try {
    > 392 |       const auditLog = await db.auditLog.create({
          |                                 ^
      393 |         data: {
      394 |           userId: changedBy || 'system',
      395 |           action: 'ROLE_CHANGE',

      at RoleChangeHistoryDB.recordChange (app/lib/permission-db.ts:392:33)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:372:50)

  ‚óè RoleChangeHistoryDB ‚Ä∫ getUserHistory ‚Ä∫ should return user role change history

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      416 |   static async getUserHistory(userId: string, limit: number = 50) {
      417 |     try {
    > 418 |       const history = await db.auditLog.findMany({
          |                                ^
      419 |         where: {
      420 |           action: 'ROLE_CHANGE',
      421 |           details: {

      at RoleChangeHistoryDB.getUserHistory (app/lib/permission-db.ts:418:32)
      at Object.<anonymous> (__tests__/unit/permission-db.test.ts:407:48)

FAIL unit __tests__/unit/permission-performance-tools.test.ts
  ‚óè Console

    console.log
      Permission Performance Service shutdown

      at PermissionPerformanceService.shutdown (app/lib/permission-performance-service.ts:246:13)

    console.log
      Permission Performance Service shutdown

      at PermissionPerformanceService.shutdown (app/lib/permission-performance-service.ts:246:13)

    console.log
      Permission Performance Service shutdown

      at PermissionPerformanceService.shutdown (app/lib/permission-performance-service.ts:246:13)

  ‚óè Permission Cache Warmer ‚Ä∫ warmUserCache ‚Ä∫ should warm cache for user with correct permissions

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      52 |     }
      53 |     
    > 54 |     cacheWarmer = new PermissionCacheWarmer(mockPermissionService, {
         |                   ^
      55 |       batchSize: 2,
      56 |       maxConcurrency: 1
      57 |     })

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:54:19)

  ‚óè Permission Cache Warmer ‚Ä∫ warmUserCache ‚Ä∫ should handle different roles appropriately

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      52 |     }
      53 |     
    > 54 |     cacheWarmer = new PermissionCacheWarmer(mockPermissionService, {
         |                   ^
      55 |       batchSize: 2,
      56 |       maxConcurrency: 1
      57 |     })

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:54:19)

  ‚óè Permission Cache Warmer ‚Ä∫ warmUserCache ‚Ä∫ should handle permission check failures gracefully

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      52 |     }
      53 |     
    > 54 |     cacheWarmer = new PermissionCacheWarmer(mockPermissionService, {
         |                   ^
      55 |       batchSize: 2,
      56 |       maxConcurrency: 1
      57 |     })

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:54:19)

  ‚óè Permission Cache Warmer ‚Ä∫ warmAfterRoleChange ‚Ä∫ should invalidate cache and warm with new role

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      52 |     }
      53 |     
    > 54 |     cacheWarmer = new PermissionCacheWarmer(mockPermissionService, {
         |                   ^
      55 |       batchSize: 2,
      56 |       maxConcurrency: 1
      57 |     })

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:54:19)

  ‚óè Permission Query Optimizer ‚Ä∫ cleanupExpiredCache ‚Ä∫ should remove expired cache entries

    expect(received).toBe(expected) // Object.is equality

    Expected: 5
    Received: 0

      168 |       const deletedCount = await queryOptimizer.cleanupExpiredCache()
      169 |
    > 170 |       expect(deletedCount).toBe(5)
          |                            ^
      171 |       expect(mockDb.permissionCache.deleteMany).toHaveBeenCalledWith({
      172 |         where: {
      173 |           expiresAt: {

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:170:28)

  ‚óè Integration Tests ‚Ä∫ should integrate cache warmer with query optimizer

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      342 |     }
      343 |
    > 344 |     const cacheWarmer = new PermissionCacheWarmer(mockPermissionService)
          |                         ^
      345 |     const queryOptimizer = new PermissionQueryOptimizer()
      346 |
      347 |     // Warm cache for a user

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:344:25)

  ‚óè Integration Tests ‚Ä∫ should profile cache warming operations

    TypeError: permission_cache_warmer_1.PermissionCacheWarmer is not a constructor

      368 |     }
      369 |
    > 370 |     const cacheWarmer = new PermissionCacheWarmer(mockPermissionService)
          |                         ^
      371 |
      372 |     // Profile a cache warming operation
      373 |     const operationId = profiler.startOperation('cache_warming')

      at Object.<anonymous> (__tests__/unit/permission-performance-tools.test.ts:370:25)

FAIL unit __tests__/unit/route-mapping.test.ts
  ‚óè Route Mapping System ‚Ä∫ RoutePermissionResolver ‚Ä∫ should resolve permissions for dynamic routes

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at RoutePermissionResolver.findRouteMatch (app/lib/route-permissions.ts:839:25)
      at RoutePermissionResolver.getRoutePermissions (app/lib/route-permissions.ts:777:24)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:35:36)

  ‚óè Route Mapping System ‚Ä∫ RoutePermissionResolver ‚Ä∫ should extract route parameters correctly

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at RoutePermissionResolver.findRouteMatch (app/lib/route-permissions.ts:839:25)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:66:30)

  ‚óè Route Mapping System ‚Ä∫ RoutePermissionResolver ‚Ä∫ should handle complex dynamic routes

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at RoutePermissionResolver.findRouteMatch (app/lib/route-permissions.ts:839:25)
      at RoutePermissionResolver.getRoutePermissions (app/lib/route-permissions.ts:777:24)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:72:36)

  ‚óè Route Mapping System ‚Ä∫ Route Pattern Matching ‚Ä∫ should match dynamic routes with parameters

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:157:31)

  ‚óè Route Mapping System ‚Ä∫ Route Pattern Matching ‚Ä∫ should match nested dynamic routes

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:163:31)

  ‚óè Route Mapping System ‚Ä∫ Route Pattern Matching ‚Ä∫ should not match non-existent routes

    SyntaxError: Invalid regular expression: /^\/admin\/users\/\([^\/]+)$/: Unmatched ')'
        at new RegExp (<anonymous>)

      860 |       .replace(/\//g, '\\/'); // Escape forward slashes
      861 |     
    > 862 |     const regex = new RegExp(`^${regexPattern}$`);
          |                   ^
      863 |     return regex.test(route);
      864 |   }
      865 |

      at RoutePermissionResolver.matchRoutePattern (app/lib/route-permissions.ts:862:19)
      at RoutePermissionResolver.findRouteConfig (app/lib/route-permissions.ts:826:16)
      at Object.<anonymous> (__tests__/unit/route-mapping.test.ts:169:31)

FAIL unit __tests__/unit/permission-performance-monitor.test.ts
  ‚óè PermissionPerformanceMonitor ‚Ä∫ trackPermissionCheck ‚Ä∫ should track failed permission check

    Test error

      50 |           mockPermission,
      51 |           () => {
    > 52 |             throw new Error('Test error');
         |                   ^
      53 |           }
      54 |         )
      55 |       ).rejects.toThrow('Test error');

      at __tests__/unit/permission-performance-monitor.test.ts:52:19
      at PermissionPerformanceMonitor.trackPermissionCheck (app/lib/permission-performance-monitor.ts:45:22)
      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:47:17)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ trackCacheOperation ‚Ä∫ should track cache get operation

    expect(received).toBeGreaterThan(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      94 |
      95 |       const cacheMetrics = monitor.getCachePerformanceMetrics();
    > 96 |       expect(cacheMetrics.avgGetLatency).toBeGreaterThan(0);
         |                                          ^
      97 |     });
      98 |
      99 |     it('should track cache set operation', async () => {

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:96:42)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ trackCacheOperation ‚Ä∫ should track cache set operation

    expect(received).toBeGreaterThan(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      105 |
      106 |       const cacheMetrics = monitor.getCachePerformanceMetrics();
    > 107 |       expect(cacheMetrics.avgSetLatency).toBeGreaterThan(0);
          |                                          ^
      108 |     });
      109 |   });
      110 |

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:107:42)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance statistics ‚Ä∫ should calculate correct performance statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      150 |       expect(stats.avgLatency).toBeGreaterThan(0);
      151 |       expect(stats.errorRate).toBeCloseTo(1/12, 2);
    > 152 |       expect(stats.slowChecks).toBe(1);
          |                                ^
      153 |       expect(stats.recentMetrics).toHaveLength(12);
      154 |     });
      155 |

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:152:32)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance statistics ‚Ä∫ should calculate percentile latencies

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      157 |       const stats = monitor.getPerformanceStats();
      158 |
    > 159 |       expect(stats.p95Latency).toBeGreaterThanOrEqual(stats.avgLatency);
          |                                ^
      160 |       expect(stats.p99Latency).toBeGreaterThanOrEqual(stats.p95Latency);
      161 |     });
      162 |

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:159:32)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ cache performance metrics ‚Ä∫ should calculate cache performance metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: undefined

      180 |       const metrics = monitor.getCachePerformanceMetrics();
      181 |
    > 182 |       expect(metrics.totalOperations).toBe(0); // No permission checks with cache tracking yet
          |                                       ^
      183 |       expect(metrics.avgGetLatency).toBeGreaterThan(0);
      184 |       expect(metrics.avgSetLatency).toBeGreaterThan(0);
      185 |     });

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:182:39)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance alerts ‚Ä∫ should generate high latency alerts

    TypeError: customMonitor.getAlerts is not a function

      198 |       );
      199 |
    > 200 |       const alerts = customMonitor.getAlerts();
          |                                    ^
      201 |       expect(alerts.length).toBeGreaterThan(0);
      202 |       expect(alerts[0].type).toBe('HIGH_LATENCY');
      203 |     });

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:200:36)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance alerts ‚Ä∫ should resolve alerts

    TypeError: customMonitor.addAlert is not a function

      219 |
      220 |       // Access private method for testing
    > 221 |       (customMonitor as any).addAlert(alert);
          |                              ^
      222 |
      223 |       expect(customMonitor.getAlerts().length).toBe(1);
      224 |       expect(customMonitor.resolveAlert('test-alert')).toBe(true);

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:221:30)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance alerts ‚Ä∫ should filter alerts by severity and resolution status

    TypeError: customMonitor.addAlert is not a function

      253 |       ];
      254 |
    > 255 |       alerts.forEach(alert => (customMonitor as any).addAlert(alert));
          |                                                      ^
      256 |
      257 |       expect(customMonitor.getAlerts('CRITICAL').length).toBe(1);
      258 |       expect(customMonitor.getAlerts(undefined, false).length).toBe(1);

      at __tests__/unit/permission-performance-monitor.test.ts:255:54
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:255:14)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance report ‚Ä∫ should generate comprehensive performance report

    expect(received).toBeDefined()

    Received: undefined

      278 |
      279 |       expect(report.summary).toBeDefined();
    > 280 |       expect(report.cacheMetrics).toBeDefined();
          |                                   ^
      281 |       expect(report.alerts).toBeDefined();
      282 |       expect(report.recommendations).toBeDefined();
      283 |

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:280:35)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ performance report ‚Ä∫ should include performance recommendations

    TypeError: Cannot read properties of undefined (reading 'length')

      295 |       
      296 |       // Should have recommendations due to low thresholds
    > 297 |       expect(report.recommendations.length).toBeGreaterThan(0);
          |                                     ^
      298 |     });
      299 |   });
      300 |

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:297:37)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ metrics export ‚Ä∫ should export metrics as JSON

    SyntaxError: "[object Object]" is not valid JSON
        at JSON.parse (<anonymous>)

      311 |     it('should export metrics as JSON', () => {
      312 |       const jsonMetrics = monitor.exportMetrics('json');
    > 313 |       const parsed = JSON.parse(jsonMetrics);
          |                           ^
      314 |
      315 |       expect(parsed.metrics).toBeDefined();
      316 |       expect(parsed.cacheMetrics).toBeDefined();

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:313:27)

  ‚óè PermissionPerformanceMonitor ‚Ä∫ metrics export ‚Ä∫ should export metrics as CSV

    expect(received).toContain(expected) // indexOf

    Expected value: "timestamp,operation,duration"
    Received array: [{"cacheHit": true, "duration": 0.0026590000052237883, "operation": "permission_check", "success": true, "timestamp": 1763407863079}]

      322 |       const csvMetrics = monitor.exportMetrics('csv');
      323 |       
    > 324 |       expect(csvMetrics).toContain('timestamp,operation,duration');
          |                          ^
      325 |       expect(csvMetrics.split('\n').length).toBeGreaterThan(1);
      326 |     });
      327 |   });

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:324:26)

  ‚óè PermissionPerformanceAlerting ‚Ä∫ should register and call alert handlers

    TypeError: alerting.onAlert is not a function

      344 |
      345 |   it('should register and call alert handlers', () => {
    > 346 |     alerting.onAlert('HIGH_LATENCY', alertHandler);
          |              ^
      347 |
      348 |     // Manually trigger an alert
      349 |     const alert: PerformanceAlert = {

      at Object.<anonymous> (__tests__/unit/permission-performance-monitor.test.ts:346:14)

FAIL unit __tests__/unit/permission-hook-utilities.test.ts
  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockUser ‚Ä∫ should create a mock user with default values

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-user-id"
    Received: "user-viewer-1763407866018"

      19 |       const user = createMockUser()
      20 |       
    > 21 |       expect(user.id).toBe('test-user-id')
         |                       ^
      22 |       expect(user.email).toBe('test@example.com')
      23 |       expect(user.name).toBe('Test User')
      24 |       expect(user.role).toBe(UserRole.VIEWER)

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:21:23)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockUser ‚Ä∫ should create a mock user with custom values

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:30:34)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockSession ‚Ä∫ should create a mock session with default user

    expect(received).toBeDefined()

    Received: undefined

      46 |       const session = createMockSession()
      47 |       
    > 48 |       expect(session.user).toBeDefined()
         |                            ^
      49 |       expect(session.expires).toBeDefined()
      50 |       expect(new Date(session.expires).getTime()).toBeGreaterThan(Date.now())
      51 |     })

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:48:28)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockSession ‚Ä∫ should create a mock session with custom user

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:54:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockPermissionHook ‚Ä∫ should create a mock permission hook for admin user

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:63:39)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockPermissionHook ‚Ä∫ should create a mock permission hook for editor user

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:75:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockPermissionHook ‚Ä∫ should create a mock permission hook for viewer user

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:86:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockPermissionHook ‚Ä∫ should create a mock permission hook for unauthenticated user

    TypeError: (0 , permission_test_utils_1.createMockPermissionHook) is not a function

       95 |
       96 |     it('should create a mock permission hook for unauthenticated user', () => {
    >  97 |       const permissions = createMockPermissionHook(null)
          |                                                   ^
       98 |       
       99 |       expect(permissions.user).toBeNull()
      100 |       expect(permissions.isAuthenticated).toBe(false)

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:97:51)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ createMockPermissionHook ‚Ä∫ should handle custom permissions

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:107:34)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PermissionAssertions ‚Ä∫ should provide assertion helpers

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:125:39)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PermissionAssertions ‚Ä∫ should fail assertions correctly

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:137:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ TestDataGenerators ‚Ä∫ should generate test products

    TypeError: Cannot read properties of undefined (reading 'generateProducts')

      147 |   describe('TestDataGenerators', () => {
      148 |     it('should generate test products', () => {
    > 149 |       const products = TestDataGenerators.generateProducts(3, 'owner-123')
          |                                           ^
      150 |       
      151 |       expect(products).toHaveLength(3)
      152 |       products.forEach((product, index) => {

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:149:43)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ TestDataGenerators ‚Ä∫ should generate test categories

    TypeError: Cannot read properties of undefined (reading 'generateCategories')

      158 |
      159 |     it('should generate test categories', () => {
    > 160 |       const categories = TestDataGenerators.generateCategories(2)
          |                                             ^
      161 |       
      162 |       expect(categories).toHaveLength(2)
      163 |       categories.forEach((category, index) => {

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:160:45)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ TestDataGenerators ‚Ä∫ should generate test users

    TypeError: Cannot read properties of undefined (reading 'generateUsers')

      168 |
      169 |     it('should generate test users', () => {
    > 170 |       const users = TestDataGenerators.generateUsers(3, UserRole.EDITOR)
          |                                        ^
      171 |       
      172 |       expect(users).toHaveLength(3)
      173 |       users.forEach((user, index) => {

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:170:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PERMISSION_TEST_SCENARIOS ‚Ä∫ should define admin scenario correctly

    TypeError: Cannot read properties of undefined (reading 'ADMIN')

      181 |   describe('PERMISSION_TEST_SCENARIOS', () => {
      182 |     it('should define admin scenario correctly', () => {
    > 183 |       const scenario = PERMISSION_TEST_SCENARIOS.ADMIN
          |                                                  ^
      184 |       
      185 |       expect(scenario.role).toBe(UserRole.ADMIN)
      186 |       expect(scenario.description).toContain('Admin')

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:183:50)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PERMISSION_TEST_SCENARIOS ‚Ä∫ should define editor scenario correctly

    TypeError: Cannot read properties of undefined (reading 'EDITOR')

      191 |
      192 |     it('should define editor scenario correctly', () => {
    > 193 |       const scenario = PERMISSION_TEST_SCENARIOS.EDITOR
          |                                                  ^
      194 |       
      195 |       expect(scenario.role).toBe(UserRole.EDITOR)
      196 |       expect(scenario.description).toContain('Editor')

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:193:50)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PERMISSION_TEST_SCENARIOS ‚Ä∫ should define viewer scenario correctly

    TypeError: Cannot read properties of undefined (reading 'VIEWER')

      201 |
      202 |     it('should define viewer scenario correctly', () => {
    > 203 |       const scenario = PERMISSION_TEST_SCENARIOS.VIEWER
          |                                                  ^
      204 |       
      205 |       expect(scenario.role).toBe(UserRole.VIEWER)
      206 |       expect(scenario.description).toContain('Viewer')

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:203:50)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ PERMISSION_TEST_SCENARIOS ‚Ä∫ should define unauthenticated scenario correctly

    TypeError: Cannot read properties of undefined (reading 'UNAUTHENTICATED')

      211 |
      212 |     it('should define unauthenticated scenario correctly', () => {
    > 213 |       const scenario = PERMISSION_TEST_SCENARIOS.UNAUTHENTICATED
          |                                                  ^
      214 |       
      215 |       expect(scenario.role).toBeNull()
      216 |       expect(scenario.description).toContain('Unauthenticated')

      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:213:50)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test admin permissions comprehensively

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:227:39)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test editor permissions comprehensively

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:253:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test viewer permissions comprehensively

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:280:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test ownership-based permissions

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:306:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test filtering functionality

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:328:40)

  ‚óè Permission Hook Testing Utilities ‚Ä∫ Permission Logic Testing ‚Ä∫ should test route access permissions

    TypeError: role.toLowerCase is not a function

      17 | export function createMockUser(role: UserRole = UserRole.VIEWER, overrides: Partial<MockUser> = {}): MockUser {
      18 |   return {
    > 19 |     id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                      ^
      20 |     email: `${role.toLowerCase()}@test.com`,
      21 |     name: `Test ${role}`,
      22 |     role,

      at createMockUser (__tests__/unit/helpers/permission-test-utils.ts:19:22)
      at Object.<anonymous> (__tests__/unit/permission-hook-utilities.test.ts:345:39)

FAIL unit __tests__/unit/enhanced-rate-limit.test.ts
  ‚óè Console

    console.warn
      IP 192.168.1.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:109:38)

    console.warn
      IP 192.168.1.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:123:22)

    console.warn
      IP 192.168.1.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:411:22)

    console.warn
      IP 192.168.1.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:457:37)

  ‚óè Enhanced Rate Limiting ‚Ä∫ rateLimit ‚Ä∫ should track violations

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 4

      109 |       const result2 = await rateLimit(request, config)
      110 |       
    > 111 |       expect(result1.violations).toBe(1)
          |                                  ^
      112 |       expect(result2.violations).toBe(2)
      113 |     })
      114 |

      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:111:34)

  ‚óè Enhanced Rate Limiting ‚Ä∫ rateLimitConfigs ‚Ä∫ should have appropriate limits for different endpoint types

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

      180 |
      181 |     it('should have appropriate limits for different endpoint types', () => {
    > 182 |       expect(rateLimitConfigs.auth.limit).toBeLessThan(rateLimitConfigs.public.limit)
          |                                           ^
      183 |       expect(rateLimitConfigs.sensitive.limit).toBeLessThan(rateLimitConfigs.public.limit)
      184 |       expect(rateLimitConfigs.bulk.limit).toBeLessThan(rateLimitConfigs.public.limit)
      185 |     })

      at Object.<anonymous> (__tests__/unit/enhanced-rate-limit.test.ts:182:43)

FAIL unit __tests__/unit/middleware-api-unit-tests-simple.test.ts
  ‚óè Middleware and API Route Unit Tests ‚Ä∫ Security Scenario Tests ‚Ä∫ should test input validation scenarios

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "isValid": false,
    -   "sanitized": "alert(1)",
    +   "isValid": true,
    +   "sanitized": "javascript:alert(1)",
      }

      402 |       })
      403 |
    > 404 |       expect(validateInput('javascript:alert(1)')).toEqual({
          |                                                    ^
      405 |         isValid: false,
      406 |         sanitized: 'alert(1)'
      407 |       })

      at Object.<anonymous> (__tests__/unit/middleware-api-unit-tests-simple.test.ts:404:52)

FAIL unit __tests__/unit/enhanced-permissions.test.ts
  ‚óè EnhancedPermissionCache ‚Ä∫ memory caching ‚Ä∫ should cache and retrieve permission results

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      50 |       // Should return cached value
      51 |       const cached = await cache.get(userId, resource, action);
    > 52 |       expect(cached).toBe(true);
         |                      ^
      53 |     });
      54 |
      55 |     it('should handle cache expiration', async () => {

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:52:22)

  ‚óè EnhancedPermissionCache ‚Ä∫ memory caching ‚Ä∫ should handle cache expiration

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      63 |       // Should return cached value immediately
      64 |       const cached = await cache.get(userId, resource, action);
    > 65 |       expect(cached).toBe(true);
         |                      ^
      66 |       
      67 |       // Wait for expiration
      68 |       await new Promise(resolve => setTimeout(resolve, 1100));

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:65:22)

  ‚óè EnhancedPermissionCache ‚Ä∫ memory caching ‚Ä∫ should invalidate user cache

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      82 |       
      83 |       // Verify cached
    > 84 |       expect(await cache.get(userId, 'products', 'read')).toBe(true);
         |                                                           ^
      85 |       expect(await cache.get(userId, 'products', 'create')).toBe(false);
      86 |       expect(await cache.get(userId, 'users', 'read')).toBe(true);
      87 |       

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:84:59)

  ‚óè EnhancedPermissionCache ‚Ä∫ memory caching ‚Ä∫ should invalidate resource cache

    TypeError: cache.invalidateResource is not a function

      106 |       
      107 |       // Invalidate products resource
    > 108 |       await cache.invalidateResource('products');
          |                   ^
      109 |       
      110 |       // Products cache should be cleared
      111 |       expect(await cache.get(userId1, 'products', 'read')).toBeNull();

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:108:19)

  ‚óè EnhancedPermissionCache ‚Ä∫ memory caching ‚Ä∫ should provide cache statistics

    TypeError: cache.getStats is not a function

      131 |
      132 |     it('should provide cache statistics', () => {
    > 133 |       const stats = cache.getStats();
          |                           ^
      134 |       
      135 |       expect(stats).toHaveProperty('memorySize');
      136 |       expect(stats).toHaveProperty('ttl');

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:133:27)

  ‚óè EnhancedPermissionCache ‚Ä∫ scope handling ‚Ä∫ should handle different scopes correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      153 |       
      154 |       // Should return different values for different scopes
    > 155 |       expect(await cache.get(userId, resource, action, 'all')).toBe(true);
          |                                                                ^
      156 |       expect(await cache.get(userId, resource, action, 'own')).toBe(false);
      157 |       expect(await cache.get(userId, resource, action)).toBeNull(); // default scope
      158 |     });

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:155:64)

  ‚óè EnhancedPermissionService ‚Ä∫ async permission checking ‚Ä∫ should provide cache statistics

    TypeError: service.getCacheStats is not a function

      209 |
      210 |     it('should provide cache statistics', () => {
    > 211 |       const stats = service.getCacheStats();
          |                             ^
      212 |       
      213 |       expect(stats).toHaveProperty('memorySize');
      214 |       expect(stats).toHaveProperty('ttl');

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:211:29)

  ‚óè EnhancedPermissionService ‚Ä∫ cache warming ‚Ä∫ should warm cache with common permissions

    TypeError: service.warmCache is not a function

      232 |       
      233 |       // This should not throw
    > 234 |       await service.warmCache(users, commonPermissions);
          |                     ^
      235 |       
      236 |       // Cache should have entries
      237 |       const stats = service.getCacheStats();

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:234:21)

  ‚óè CacheInvalidationService ‚Ä∫ should invalidate cache on user role change

    TypeError: invalidationService.onUserRoleChange is not a function

      259 |     const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      260 |     
    > 261 |     await invalidationService.onUserRoleChange(userId, UserRole.VIEWER, UserRole.EDITOR);
          |                               ^
      262 |     
      263 |     expect(consoleSpy).toHaveBeenCalledWith(
      264 |       expect.stringContaining(`User ${userId} role changed from VIEWER to EDITOR`)

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:261:31)

  ‚óè CacheInvalidationService ‚Ä∫ should invalidate cache on permission update

    TypeError: invalidationService.onPermissionUpdate is not a function

      273 |     const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      274 |     
    > 275 |     await invalidationService.onPermissionUpdate(resource);
          |                               ^
      276 |     
      277 |     expect(consoleSpy).toHaveBeenCalledWith(
      278 |       expect.stringContaining(`Permissions updated for resource ${resource}`)

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:275:31)

  ‚óè CacheInvalidationService ‚Ä∫ should invalidate cache on user deactivation

    TypeError: invalidationService.onUserDeactivation is not a function

      287 |     const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      288 |     
    > 289 |     await invalidationService.onUserDeactivation(userId);
          |                               ^
      290 |     
      291 |     expect(consoleSpy).toHaveBeenCalledWith(
      292 |       expect.stringContaining(`User ${userId} deactivated`)

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:289:31)

  ‚óè CacheInvalidationService ‚Ä∫ should handle scheduled cleanup

    TypeError: invalidationService.cleanupExpiredEntries is not a function

      299 |     const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      300 |     
    > 301 |     await invalidationService.cleanupExpiredEntries();
          |                               ^
      302 |     
      303 |     expect(consoleSpy).toHaveBeenCalledWith(
      304 |       expect.stringContaining('Cleaning up expired cache entries')

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:301:31)

  ‚óè Cache Configuration ‚Ä∫ should use default configuration

    TypeError: cache.getStats is not a function

      312 |   it('should use default configuration', () => {
      313 |     const cache = new EnhancedPermissionCache();
    > 314 |     const stats = cache.getStats();
          |                         ^
      315 |     
      316 |     expect(stats.ttl).toBe(5 * 60 * 1000); // 5 minutes default
      317 |     expect(stats.distributed).toBe(false);

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:314:25)

  ‚óè Cache Configuration ‚Ä∫ should use custom configuration

    TypeError: cache.getStats is not a function

      325 |     
      326 |     const cache = new EnhancedPermissionCache(config);
    > 327 |     const stats = cache.getStats();
          |                         ^
      328 |     
      329 |     expect(stats.ttl).toBe(10 * 60 * 1000);
      330 |     expect(stats.distributed).toBe(false);

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:327:25)

  ‚óè Performance Tests ‚Ä∫ should handle concurrent permission checks

    TypeError: service.getCacheStats is not a function

      371 |     
      372 |     // Cache should have the entry
    > 373 |     const stats = service.getCacheStats();
          |                           ^
      374 |     expect(stats.memorySize).toBeGreaterThan(0);
      375 |   });
      376 |

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:373:27)

  ‚óè Performance Tests ‚Ä∫ should maintain performance under load

    TypeError: service.getCacheStats is not a function

      403 |     
      404 |     // Cache should have entries
    > 405 |     const stats = service.getCacheStats();
          |                           ^
      406 |     expect(stats.memorySize).toBeGreaterThan(0);
      407 |   });
      408 | });

      at Object.<anonymous> (__tests__/unit/enhanced-permissions.test.ts:405:27)

FAIL unit __tests__/unit/api-permission-comprehensive.test.ts
  ‚óè Comprehensive API Permission Testing ‚Ä∫ Individual Permission Tests ‚Ä∫ should test CREATE endpoint with proper authentication and authorization

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:126:46)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Individual Permission Tests ‚Ä∫ should test READ endpoint with different user roles

    TypeError: role.toLowerCase is not a function

      12 |   static createUser(role: UserRole = UserRole.VIEWER, overrides: any = {}) {
      13 |     return {
    > 14 |       id: `user-${role.toLowerCase()}-${Date.now()}`,
         |                        ^
      15 |       email: `${role.toLowerCase()}@test.com`,
      16 |       name: `Test ${role}`,
      17 |       role,

      at TestUserFactory.createUser (__tests__/helpers/api-permission-test-utils.ts:14:24)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:165:38)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Individual Permission Tests ‚Ä∫ should test UPDATE endpoint with ownership checks

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      63 |   },
      64 |
    > 65 |   update: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      66 |     const body = await request.json();
      67 |     return NextResponse.json({
      68 |       data: { id: '123', ...body, updatedBy: user?.id },

      at Object.update (__tests__/unit/api-permission-comprehensive.test.ts:65:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:200:46)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Individual Permission Tests ‚Ä∫ should test DELETE endpoint with strict permissions

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      71 |   },
      72 |
    > 73 |   delete: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      74 |     return NextResponse.json({
      75 |       data: { message: 'Product deleted', deletedBy: user?.id },
      76 |       success: true

      at Object.delete (__tests__/unit/api-permission-comprehensive.test.ts:73:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:229:52)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Security Test Scenarios ‚Ä∫ should run comprehensive security scenarios for all endpoints

    TypeError: scenarios.slice is not a function or its return value is not iterable

      263 |
      264 |         // Run a subset of scenarios for each endpoint
    > 265 |         for (const scenario of scenarios.slice(0, 3)) {
          |                                          ^
      266 |           const request = ApiRequestBuilder
      267 |             .get('http://localhost:3000/api/products')
      268 |             .setMethod(endpoint.method)

      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:265:42)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Security Test Scenarios ‚Ä∫ should test HTTP method restrictions

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:295:32)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Security Test Scenarios ‚Ä∫ should test input validation and sanitization

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:334:48)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Performance and Load Testing ‚Ä∫ should handle concurrent requests

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at __tests__/unit/api-permission-comprehensive.test.ts:391:51
          at Array.map (<anonymous>)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:391:18)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Performance and Load Testing ‚Ä∫ should handle permission cache efficiently

    TypeError: api_permission_test_utils_1.MockPermissionService.mockRolePermissions is not a function

      408 |       for (const user of users) {
      409 |         MockAuthService.mockAuthenticatedUser(user);
    > 410 |         MockPermissionService.mockRolePermissions(user.role, user.role !== UserRole.VIEWER);
          |                               ^
      411 |
      412 |         const requests = Array.from({ length: 5 }, () =>
      413 |           ApiRequestBuilder.get('http://localhost:3000/api/products').build()

      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:410:31)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Edge Cases and Error Scenarios ‚Ä∫ should handle malformed requests

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:445:48)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Edge Cases and Error Scenarios ‚Ä∫ should handle database errors gracefully

    Database connection failed

      452 |       const errorHandler = createProtectedApiHandler(
      453 |         async (request: NextRequest) => {
    > 454 |           throw new Error('Database connection failed');
          |                 ^
      455 |         },
      456 |         [{ resource: 'products', action: 'read' }]
      457 |       );

      at createProtectedApiHandler.resource (__tests__/unit/api-permission-comprehensive.test.ts:454:17)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:467:30)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Edge Cases and Error Scenarios ‚Ä∫ should handle permission service failures

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      46 |   },
      47 |
    > 48 |   read: async (request: NextRequest, { user }: { user: any }) => {
         |                                        ^
      49 |     const url = new URL(request.url);
      50 |     const page = url.searchParams.get('page') || '1';
      51 |     const limit = url.searchParams.get('limit') || '10';

      at Object.read (__tests__/unit/api-permission-comprehensive.test.ts:48:40)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:489:48)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Audit and Logging ‚Ä∫ should log all access attempts

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:506:31)

  ‚óè Comprehensive API Permission Testing ‚Ä∫ Audit and Logging ‚Ä∫ should log security violations

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      38 | // Sample business logic handlers
      39 | const productsBusinessLogic = {
    > 40 |   create: async (request: NextRequest, { user }: { user: any }) => {
         |                                          ^
      41 |     const body = await request.json();
      42 |     return NextResponse.json({
      43 |       data: { id: '123', ...body, createdBy: user?.id },

      at Object.create (__tests__/unit/api-permission-comprehensive.test.ts:40:42)
      at Object.<anonymous> (__tests__/unit/api-permission-comprehensive.test.ts:525:31)

FAIL unit __tests__/unit/csrf-protection.test.ts
  ‚óè CSRFProtection ‚Ä∫ validateToken ‚Ä∫ should reject token with invalid signature

    expect(received).toBe(expected) // Object.is equality

    Expected: "Invalid signature"
    Received: "Validation error"

      150 |       const result = await CSRFProtection.validateToken(tamperedToken, sessionId)
      151 |       expect(result.valid).toBe(false)
    > 152 |       expect(result.reason).toBe('Invalid signature')
          |                             ^
      153 |     })
      154 |
      155 |     it('should reject token for wrong session', async () => {

      at Object.<anonymous> (__tests__/unit/csrf-protection.test.ts:152:29)

  ‚óè CSRFProtection ‚Ä∫ getTokenFromRequest ‚Ä∫ should return null if no token found

    expect(received).toBeNull()

    Received: undefined

      270 |       
      271 |       const result = CSRFProtection.getTokenFromRequest(request)
    > 272 |       expect(result).toBeNull()
          |                      ^
      273 |     })
      274 |   })
      275 |

      at Object.<anonymous> (__tests__/unit/csrf-protection.test.ts:272:22)

  ‚óè CSRFProtection ‚Ä∫ createTokenResponse ‚Ä∫ should set secure cookie

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      410 |       
      411 |       const setCookieHeader = response.headers.get('set-cookie')
    > 412 |       expect(setCookieHeader).toContain('csrf-token=')
          |                               ^
      413 |       expect(setCookieHeader).toContain('SameSite=Strict')
      414 |     })
      415 |   })

      at Object.<anonymous> (__tests__/unit/csrf-protection.test.ts:412:31)

FAIL unit __tests__/unit/api-permission-testing-demo.test.ts
  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Basic Permission Testing ‚Ä∫ should test user authentication

    TypeError: api_permission_test_utils_1.ApiResponseValidator.validateUnauthorizedResponse is not a function

      177 |       
      178 |       const response = await mockProductsHandler(request);
    > 179 |       await ApiResponseValidator.validateUnauthorizedResponse(response);
          |                                  ^
      180 |     });
      181 |
      182 |     it('should test user authorization', async () => {

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:179:34)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Basic Permission Testing ‚Ä∫ should test user authorization

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

      228 |
      229 |   static async validateSuccessResponse(response: any, expectedStatus: number = 200) {
    > 230 |     expect(response.status).toBe(expectedStatus)
          |                             ^
      231 |     const data = await response.json()
      232 |     return data
      233 |   }

      at ApiResponseValidator.validateSuccessResponse (__tests__/helpers/api-permission-test-utils.ts:230:29)
      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:197:34)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Basic Permission Testing ‚Ä∫ should test permission-based access

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

      228 |
      229 |   static async validateSuccessResponse(response: any, expectedStatus: number = 200) {
    > 230 |     expect(response.status).toBe(expectedStatus)
          |                             ^
      231 |     const data = await response.json()
      232 |     return data
      233 |   }

      at ApiResponseValidator.validateSuccessResponse (__tests__/helpers/api-permission-test-utils.ts:230:29)
      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:240:34)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Security Test Scenarios ‚Ä∫ should run comprehensive security scenarios

    expect(received).toBeGreaterThan(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      260 |       });
      261 |
    > 262 |       expect(scenarios.length).toBeGreaterThan(0);
          |                                ^
      263 |       
      264 |       // Run a few scenarios
      265 |       for (const scenario of scenarios.slice(0, 3)) {

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:262:32)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Security Test Scenarios ‚Ä∫ should test HTTP method restrictions

    TypeError: api_permission_test_utils_1.ApiResponseValidator.validateMethodNotAllowedResponse is not a function

      292 |       
      293 |       response = await mockProductsHandler(request);
    > 294 |       await ApiResponseValidator.validateMethodNotAllowedResponse(response);
          |                                  ^
      295 |     });
      296 |   });
      297 |

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:294:34)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Custom Test Scenarios ‚Ä∫ should test resource ownership

    expect(received).toBeLessThan(expected)

    Expected: < 400
    Received:   401

      375 |       
      376 |       let response = await mockProductsHandler(request);
    > 377 |       expect(response.status).toBeLessThan(400);
          |                               ^
      378 |
      379 |       // Test other user cannot access owner's resource
      380 |       MockAuthService.mockAuthenticatedUser(otherUser);

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:377:31)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Error Handling Tests ‚Ä∫ should handle authentication errors gracefully

    TypeError: api_permission_test_utils_1.MockAuthService.mockInvalidToken is not a function

      449 |   describe('Error Handling Tests', () => {
      450 |     it('should handle authentication errors gracefully', async () => {
    > 451 |       MockAuthService.mockInvalidToken();
          |                       ^
      452 |
      453 |       const request = ApiRequestBuilder
      454 |         .post('http://localhost:3000/api/products', { name: 'Test' })

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:451:23)

  ‚óè API Permission Testing Utilities Demo ‚Ä∫ Error Handling Tests ‚Ä∫ should handle permission errors gracefully

    TypeError: api_permission_test_utils_1.MockPermissionService.mockNoPermissions is not a function

      462 |       const user = TestUserFactory.createViewer();
      463 |       MockAuthService.mockAuthenticatedUser(user);
    > 464 |       MockPermissionService.mockNoPermissions();
          |                             ^
      465 |
      466 |       const request = ApiRequestBuilder
      467 |         .post('http://localhost:3000/api/products', { name: 'Test' })

      at Object.<anonymous> (__tests__/unit/api-permission-testing-demo.test.ts:464:29)

FAIL integration __tests__/integration/api-permission-integration.test.ts
  ‚óè API Permission Integration ‚Ä∫ should protect a simple GET endpoint

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      65 |     // Create a protected endpoint
      66 |     const protectedHandler = withApiPermissions(
    > 67 |       async (request: NextRequest, { user }) => {
         |                                      ^
      68 |         return createApiSuccessResponse({ 
      69 |           message: 'Success',
      70 |           userId: user?.id 

      at protectedHandler.permissions.resource (__tests__/integration/api-permission-integration.test.ts:67:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:79:28)

  ‚óè API Permission Integration ‚Ä∫ should deny access to unauthorized users

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      89 |
      90 |     const protectedHandler = withApiPermissions(
    > 91 |       async (request: NextRequest, { user }) => {
         |                                      ^
      92 |         return createApiSuccessResponse({ message: 'Success' });
      93 |       },
      94 |       {

      at protectedHandler.permissions.resource (__tests__/integration/api-permission-integration.test.ts:91:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:100:28)

  ‚óè API Permission Integration ‚Ä∫ should handle POST requests with permission validation

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      120 |
      121 |     const protectedHandler = withApiPermissions(
    > 122 |       async (request: NextRequest, { user }) => {
          |                                      ^
      123 |         const body = await request.json();
      124 |         return createApiSuccessResponse({ 
      125 |           message: 'Created',

      at protectedHandler.permissions.resource (__tests__/integration/api-permission-integration.test.ts:122:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:142:28)

  ‚óè API Permission Integration ‚Ä∫ should deny access for insufficient permissions

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      162 |
      163 |     const protectedHandler = withApiPermissions(
    > 164 |       async (request: NextRequest, { user }) => {
          |                                      ^
      165 |         return createApiSuccessResponse({ message: 'Success' });
      166 |       },
      167 |       {

      at protectedHandler.permissions.resource (__tests__/integration/api-permission-integration.test.ts:164:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:176:28)

  ‚óè API Permission Integration ‚Ä∫ should handle method restrictions

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      192 |
      193 |     const protectedHandler = withApiPermissions(
    > 194 |       async (request: NextRequest, { user }) => {
          |                                      ^
      195 |         return createApiSuccessResponse({ message: 'Success' });
      196 |       },
      197 |       {

      at protectedHandler.allowedMethods (__tests__/integration/api-permission-integration.test.ts:194:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:206:28)

  ‚óè API Permission Integration ‚Ä∫ should create consistent error responses

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      216 |
      217 |     const protectedHandler = withApiPermissions(
    > 218 |       async (request: NextRequest, { user }) => {
          |                                      ^
      219 |         return createApiSuccessResponse({ message: 'Success' });
      220 |       },
      221 |       {

      at protectedHandler.requireAuth (__tests__/integration/api-permission-integration.test.ts:218:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:227:28)

  ‚óè API Permission Integration ‚Ä∫ should create consistent success responses

    TypeError: Cannot destructure property 'user' of 'undefined' as it is undefined.

      249 |
      250 |     const protectedHandler = withApiPermissions(
    > 251 |       async (request: NextRequest, { user }) => {
          |                                      ^
      252 |         return createApiSuccessResponse({ 
      253 |           id: 1, 
      254 |           name: 'Test Product',

      at protectedHandler.skipPermissionCheck (__tests__/integration/api-permission-integration.test.ts:251:38)
      at Object.<anonymous> (__tests__/integration/api-permission-integration.test.ts:264:28)

PASS unit __tests__/unit/api-security.test.ts (6.661 s)
  ‚óè Console

    console.warn
      DOMPurify not available, trying sanitize-html fallback

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at Object.<anonymous> (app/lib/api-security.ts:20:13)
      at Object.<anonymous> (__tests__/unit/api-security.test.ts:7:1)

    console.log
      Security monitoring started

      at SecurityService.startSecurityMonitoring (app/lib/security.ts:110:13)

PASS e2e __tests__/e2e/security-scenario-e2e.test.tsx (5.482 s)
PASS integration __tests__/integration/security-logging-core.test.ts
PASS unit __tests__/unit/scalability-monitor.test.ts (5.076 s)
  ‚óè Console

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      üîç Starting scalability monitoring...

      at ScalabilityMonitor.startMonitoring (app/lib/scalability-monitor.ts:160:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      üîç Starting scalability monitoring...

      at ScalabilityMonitor.startMonitoring (app/lib/scalability-monitor.ts:160:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      üîç Starting scalability monitoring...

      at ScalabilityMonitor.startMonitoring (app/lib/scalability-monitor.ts:160:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      üîç Starting scalability monitoring...

      at ScalabilityMonitor.startMonitoring (app/lib/scalability-monitor.ts:160:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

    console.log
      ‚èπÔ∏è Scalability monitoring stopped

      at ScalabilityMonitor.stopMonitoring (app/lib/scalability-monitor.ts:182:13)

PASS unit __tests__/unit/permission-events.test.ts
  ‚óè Console

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:136:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:136:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:151:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1549:26)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:151:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:167:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:167:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:187:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:187:19)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:187:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:187:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:201:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:201:19)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:201:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:201:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:92:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:214:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserDeactivation (app/lib/permission-events.ts:92:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:214:19)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:92:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:214:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserDeactivation (app/lib/permission-events.ts:92:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:214:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastCacheInvalidation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:103:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:227:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastCacheInvalidation (app/lib/permission-events.ts:103:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:227:19)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastCacheInvalidation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:103:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:227:19)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastCacheInvalidation (app/lib/permission-events.ts:103:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:227:19)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at ServerPermissionEvents.notifyUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:125:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:248:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:125:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:248:36)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at ServerPermissionEvents.notifyUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:125:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:248:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:125:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:248:36)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at ServerPermissionEvents.notifyPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:140:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:260:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at ServerPermissionEvents.notifyPermissionUpdate (app/lib/permission-events.ts:140:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:260:36)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at ServerPermissionEvents.notifyPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:140:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:260:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at ServerPermissionEvents.notifyPermissionUpdate (app/lib/permission-events.ts:140:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:260:36)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at ServerPermissionEvents.notifyPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:140:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:272:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at ServerPermissionEvents.notifyPermissionUpdate (app/lib/permission-events.ts:140:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:272:36)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at ServerPermissionEvents.notifyPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:140:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:272:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at ServerPermissionEvents.notifyPermissionUpdate (app/lib/permission-events.ts:140:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:272:36)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:92:10)
          at ServerPermissionEvents.notifyUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:159:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:284:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserDeactivation (app/lib/permission-events.ts:92:10)
      at ServerPermissionEvents.notifyUserDeactivation (app/lib/permission-events.ts:159:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:284:36)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:92:10)
          at ServerPermissionEvents.notifyUserDeactivation (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:159:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:284:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserDeactivation (app/lib/permission-events.ts:92:10)
      at ServerPermissionEvents.notifyUserDeactivation (app/lib/permission-events.ts:159:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:284:36)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at ServerPermissionEvents.notifyUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:125:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:299:36)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:125:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:299:36)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at ServerPermissionEvents.notifyUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:125:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:319:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:125:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:319:34)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at ServerPermissionEvents.notifyUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:125:22)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:319:34)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:125:22)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:319:34)

    console.error
      Failed to invalidate server-side permission cache: Error: Cache error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:295:71)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at ServerPermissionEvents.notifyUserRoleChange (app/lib/permission-events.ts:132:15)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:319:5)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:351:17)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:351:17)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastUserRoleChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:69:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:351:17)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastUserRoleChange (app/lib/permission-events.ts:69:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:351:17)

    console.error
      Error in permission update listener: Error: Callback error
          at /Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:105:15
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13
          at mockConstructor (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at /Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:47:9
          at Set.forEach (<anonymous>)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:45:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:361:17)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at app/lib/permission-events.ts:49:17
          at Set.forEach (<anonymous>)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:45:20)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:361:17)

    console.warn
      Failed to broadcast permission update via localStorage: Error: localStorage error
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:162:15)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as setItem] (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-mock/build/index.js:102:19)
          at PermissionEventBroadcaster.broadcast (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:55:20)
          at PermissionEventBroadcaster.broadcastPermissionUpdate (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-events.ts:81:10)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/permission-events.test.ts:361:17)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at PermissionEventBroadcaster.broadcast (app/lib/permission-events.ts:61:15)
      at PermissionEventBroadcaster.broadcastPermissionUpdate (app/lib/permission-events.ts:81:10)
      at Object.<anonymous> (__tests__/unit/permission-events.test.ts:361:17)

PASS unit __tests__/unit/migration-utils.test.ts
  ‚óè Console

    console.warn
      Native DOMException not available, using fallback: TypeError: DOMException is not a constructor
          at createDOMException (/Users/teroleinonen/software projects/cms-admin/app/lib/migration-utils.ts:84:12)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/unit/migration-utils.test.ts:156:43)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at createDOMException (app/lib/migration-utils.ts:87:13)
      at Object.<anonymous> (__tests__/unit/migration-utils.test.ts:156:43)

    console.warn
      Migration validation failed, results differ: { old: 5, new: 5.4, args: [ 2.7 ] }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at app/lib/migration-utils.ts:166:21
      at Object.<anonymous> (__tests__/unit/migration-utils.test.ts:199:14)

PASS unit __tests__/unit/enhanced-audit-service.test.ts (5.303 s)
  ‚óè Console

    console.log
      Cleaned up 50 audit logs older than 365 days

      at AuditService.cleanup (app/lib/audit-service.ts:814:15)

PASS unit __tests__/unit/auth-flow-debug.test.ts
  ‚óè Console

    console.log
      === ENVIRONMENT VARIABLES ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:27:15)

    console.log
      AUTH_SECRET: SET

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:28:15)

    console.log
      NEXTAUTH_SECRET: SET

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:29:15)

    console.log
      NEXTAUTH_URL: http://localhost:3001

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:30:15)

    console.log
      DATABASE_URL: SET

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:31:15)

    console.log
      === NEXTAUTH CONFIGURATION ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:41:15)

    console.log
      Skipping auth function test due to import issues

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:42:15)

    console.log
      === LOGIN API ROUTE TEST ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:49:15)

    console.log
      Skipping direct API test due to import issues

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:50:15)

    console.log
      === CALLBACK URL CONSTRUCTION ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:57:15)

    console.log
      Base URL: http://localhost:3001

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:60:15)

    console.log
      Callback URL: http://localhost:3001/api/auth/callback/credentials

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:64:17)

    console.log
      === REDIRECT URL HANDLING ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:76:15)

    console.log
      Redirect URL: http://localhost:3001/dashboard

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:83:17)

    console.log
      === MIDDLEWARE URL HANDLING ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:95:15)

    console.log
      Testing URL: http://localhost:3001/

      at __tests__/unit/auth-flow-debug.test.ts:105:17
          at Array.forEach (<anonymous>)

    console.log
      Pathname: /

      at __tests__/unit/auth-flow-debug.test.ts:110:17
          at Array.forEach (<anonymous>)

    console.log
      Testing URL: http://localhost:3001/auth/login

      at __tests__/unit/auth-flow-debug.test.ts:105:17
          at Array.forEach (<anonymous>)

    console.log
      Pathname: /auth/login

      at __tests__/unit/auth-flow-debug.test.ts:110:17
          at Array.forEach (<anonymous>)

    console.log
      Testing URL: http://localhost:3001/dashboard

      at __tests__/unit/auth-flow-debug.test.ts:105:17
          at Array.forEach (<anonymous>)

    console.log
      Pathname: /dashboard

      at __tests__/unit/auth-flow-debug.test.ts:110:17
          at Array.forEach (<anonymous>)

    console.log
      Testing URL: http://localhost:3001/api/auth/signin

      at __tests__/unit/auth-flow-debug.test.ts:105:17
          at Array.forEach (<anonymous>)

    console.log
      Pathname: /api/auth/signin

      at __tests__/unit/auth-flow-debug.test.ts:110:17
          at Array.forEach (<anonymous>)

    console.log
      === LOGIN REDIRECT URL CONSTRUCTION ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:118:15)

    console.log
      Constructed login URL: http://localhost:3001/auth/login?callbackUrl=%2Fdashboard

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:127:17)

    console.log
      Callback URL param: /dashboard

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:128:17)

    console.log
      === CLIENT-SIDE SIGNIN TEST ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:142:15)

    console.log
      SignIn result: {
        ok: true,
        status: 200,
        error: null,
        url: 'http://localhost:3001/dashboard'
      }

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:159:15)

    console.log
      === ERROR SCENARIO: MISSING ENV VARS ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:169:15)

    console.log
      NEXTAUTH_URL when deleted: undefined

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:177:17)

    console.log
      === UNDEFINED URL DETECTION ===

      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:192:15)

    console.log
      Testing: Direct URL construction

      at __tests__/unit/auth-flow-debug.test.ts:211:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úì Direct URL construction: http://localhost:3001/test

      at __tests__/unit/auth-flow-debug.test.ts:214:19
          at Array.forEach (<anonymous>)

    console.log
      Testing: URL with undefined base

      at __tests__/unit/auth-flow-debug.test.ts:211:17
          at Array.forEach (<anonymous>)

    console.error
      ‚úó URL with undefined base: TypeError: Invalid URL

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at __tests__/unit/auth-flow-debug.test.ts:216:19
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:210:17)

    console.log
      Testing: URL with string "undefined"

      at __tests__/unit/auth-flow-debug.test.ts:211:17
          at Array.forEach (<anonymous>)

    console.error
      ‚úó URL with string "undefined": TypeError: Invalid URL

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at __tests__/unit/auth-flow-debug.test.ts:216:19
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/unit/auth-flow-debug.test.ts:210:17)

PASS unit __tests__/unit/permission-config.test.ts
PASS unit __tests__/unit/security-logging-core.test.ts
PASS unit __tests__/unit/permission-utils.test.ts
PASS unit __tests__/unit/postgresql-search.test.ts
PASS unit __tests__/unit/system-health-monitor.test.ts
PASS unit __tests__/unit/system-alert-service.test.ts
  ‚óè Console

    console.log
      Email notification sent for alert: Test alert message

      at SystemAlertService.sendEmailNotification (app/lib/system-alert-service.ts:235:15)

    console.log
      Email would be sent: {
        to: [ 'test@example.com' ],
        subject: 'System Alert: performance - MEDIUM',
        body: '\n' +
          '          Alert Details:\n' +
          '          - Type: performance\n' +
          '          - Severity: medium\n' +
          '          - Message: Test alert message\n' +
          '          - Timestamp: Mon Nov 17 2025 21:32:37 GMT+0200 (Eastern European Standard Time)\n' +
          '          - Details: {\n' +
          '  "test": true\n' +
          '}\n' +
          '        '
      }

      at SystemAlertService.sendEmailNotification (app/lib/system-alert-service.ts:252:15)

    console.log
      In-app notification created for alert: Test alert message

      at SystemAlertService.sendInAppNotification (app/lib/system-alert-service.ts:297:15)

    console.log
      Processed alert: performance - medium - Test alert message

      at SystemAlertService.processAlert (app/lib/system-alert-service.ts:147:15)

    console.log
      Email notification sent for alert: High severity test alert

      at SystemAlertService.sendEmailNotification (app/lib/system-alert-service.ts:235:15)

    console.log
      Email would be sent: {
        to: [ 'test@example.com' ],
        subject: 'System Alert: performance - HIGH',
        body: '\n' +
          '          Alert Details:\n' +
          '          - Type: performance\n' +
          '          - Severity: high\n' +
          '          - Message: High severity test alert\n' +
          '          - Timestamp: Mon Nov 17 2025 21:32:37 GMT+0200 (Eastern European Standard Time)\n' +
          '          - Details: undefined\n' +
          '        '
      }

      at SystemAlertService.sendEmailNotification (app/lib/system-alert-service.ts:252:15)

    console.log
      In-app notification created for alert: High severity test alert

      at SystemAlertService.sendInAppNotification (app/lib/system-alert-service.ts:297:15)

    console.log
      Webhook notification sent for alert: High severity test alert

      at SystemAlertService.sendWebhookNotification (app/lib/system-alert-service.ts:287:15)
          at async Promise.allSettled (index 1)

    console.log
      Processed alert: performance - high - High severity test alert

      at SystemAlertService.processAlert (app/lib/system-alert-service.ts:147:15)

PASS unit __tests__/unit/dom-exception-integration.test.ts
PASS unit __tests__/unit/admin/monitoring/scalability.test.ts
PASS unit __tests__/unit/admin/compliance.test.ts
PASS unit __tests__/unit/compliance-service.test.ts (5.071 s)
PASS e2e __tests__/e2e/run-e2e-workflows.test.ts (5.143 s)
  ‚óè Console

    console.log
      Setting up E2E workflow test environment...

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:14:13)

    console.log
      Test environment setup complete

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:19:15)

    console.log
      Running test suite: permission-workflows.test.tsx

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:52:19)

    console.log
      ‚úÖ permission-workflows.test.tsx: 25/25 tests passed

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:78:19)

    console.log
         Coverage: 95.2% statements, 92.8% branches

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:79:19)

    console.log
      Running test suite: api-permission-workflows.test.ts

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:52:19)

    console.log
      ‚úÖ api-permission-workflows.test.ts: 25/25 tests passed

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:78:19)

    console.log
         Coverage: 95.2% statements, 92.8% branches

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:79:19)

    console.log
      Running test suite: navigation-permission-workflows.test.tsx

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:52:19)

    console.log
      ‚úÖ navigation-permission-workflows.test.tsx: 25/25 tests passed

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:78:19)

    console.log
         Coverage: 95.2% statements, 92.8% branches

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:79:19)

    console.log
      Running test suite: form-interaction-workflows.test.tsx

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:52:19)

    console.log
      ‚úÖ form-interaction-workflows.test.tsx: 25/25 tests passed

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:78:19)

    console.log
         Coverage: 95.2% statements, 92.8% branches

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:79:19)

    console.log
      Running test suite: cross-browser-mobile-workflows.test.tsx

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:52:19)

    console.log
      ‚úÖ cross-browser-mobile-workflows.test.tsx: 35/35 tests passed

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:78:19)

    console.log
         Coverage: 95.2% statements, 92.8% branches

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:79:19)

    console.log
      
      === E2E Workflow Test Summary ===

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:96:15)

    console.log
      Total test suites: 5

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:97:15)

    console.log
      Passed: 5

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:98:15)

    console.log
      Failed: 0

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:99:15)

    console.log
      ‚úÖ All coverage requirements met

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:135:15)

    console.log
         Statements: 95.2% (required: 90%)

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:136:15)

    console.log
         Branches: 92.8% (required: 85%)

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:137:15)

    console.log
         Functions: 96.1% (required: 90%)

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:138:15)

    console.log
         Lines: 94.7% (required: 90%)

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:139:15)

    console.log
      ‚úÖ All user roles tested in workflows

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:178:15)

    console.log
         ADMIN: 65 scenarios across 7 workflows

      at __tests__/e2e/run-e2e-workflows.test.ts:180:17
          at Array.forEach (<anonymous>)

    console.log
           Browsers: chrome, firefox, safari, edge

      at __tests__/e2e/run-e2e-workflows.test.ts:181:17
          at Array.forEach (<anonymous>)

    console.log
           Devices: desktop, tablet, mobile

      at __tests__/e2e/run-e2e-workflows.test.ts:182:17
          at Array.forEach (<anonymous>)

    console.log
         EDITOR: 48 scenarios across 6 workflows

      at __tests__/e2e/run-e2e-workflows.test.ts:180:17
          at Array.forEach (<anonymous>)

    console.log
           Browsers: chrome, firefox, safari, edge

      at __tests__/e2e/run-e2e-workflows.test.ts:181:17
          at Array.forEach (<anonymous>)

    console.log
           Devices: desktop, tablet, mobile

      at __tests__/e2e/run-e2e-workflows.test.ts:182:17
          at Array.forEach (<anonymous>)

    console.log
         VIEWER: 28 scenarios across 4 workflows

      at __tests__/e2e/run-e2e-workflows.test.ts:180:17
          at Array.forEach (<anonymous>)

    console.log
           Browsers: chrome, firefox, safari, edge

      at __tests__/e2e/run-e2e-workflows.test.ts:181:17
          at Array.forEach (<anonymous>)

    console.log
           Devices: desktop, tablet, mobile

      at __tests__/e2e/run-e2e-workflows.test.ts:182:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ Permission boundaries thoroughly tested

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:206:15)

    console.log
         Total boundary tests: 128

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:207:15)

    console.log
         unauthorized-access-attempts: 15 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         role-transition-scenarios: 8 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         permission-escalation-prevention: 12 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         cross-component-consistency: 20 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         api-permission-validation: 25 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         ui-permission-filtering: 18 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         form-field-restrictions: 14 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
         navigation-access-control: 16 tests

      at __tests__/e2e/run-e2e-workflows.test.ts:209:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ Cross-browser compatibility thoroughly tested

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:265:15)

    console.log
         Total browser-specific tests: 152

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:266:15)

    console.log
         chrome: 28 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
         firefox: 28 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
         safari: 28 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
         edge: 28 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
         mobile-safari: 20 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
         mobile-chrome: 20 tests across 4 features

      at __tests__/e2e/run-e2e-workflows.test.ts:268:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ Mobile responsive testing thoroughly covered

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:332:15)

    console.log
         Total device-specific tests: 95

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:333:15)

    console.log
         iPhone-SE: 15 tests at 375x667

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
         iPhone-12: 15 tests at 390x844

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
         iPad-Air: 12 tests at 768x1024

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
         Galaxy-S21: 15 tests at 360x800

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
         Desktop-1080p: 20 tests at 1920x1080

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
         Desktop-4K: 18 tests at 3840x2160

      at __tests__/e2e/run-e2e-workflows.test.ts:335:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ Responsive breakpoint testing comprehensive

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:376:15)

    console.log
         Total breakpoint tests: 37

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:377:15)

    console.log
         mobile-breakpoint (< 768px): 12 tests, 2 transitions

      at __tests__/e2e/run-e2e-workflows.test.ts:379:17
          at Array.forEach (<anonymous>)

    console.log
         tablet-breakpoint (768px - 1023px): 10 tests, 2 transitions

      at __tests__/e2e/run-e2e-workflows.test.ts:379:17
          at Array.forEach (<anonymous>)

    console.log
         desktop-breakpoint (>= 1024px): 15 tests, 2 transitions

      at __tests__/e2e/run-e2e-workflows.test.ts:379:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ All cross-component integrations tested

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:401:15)

    console.log
         Tested integrations: 8

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:402:15)

    console.log
         ‚úì navigation-to-forms

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì api-to-ui-consistency

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì permission-context-propagation

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì error-boundary-integration

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì cache-invalidation-workflows

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì session-management-integration

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì audit-logging-integration

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì real-time-permission-updates

      at __tests__/e2e/run-e2e-workflows.test.ts:404:17
          at Array.forEach (<anonymous>)

    console.log
      ‚úÖ Performance requirements met

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:453:15)

    console.log
         Average permission check: 15ms

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:454:15)

    console.log
         Cache hit ratio: 92.0%

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:455:15)

    console.log
         Peak memory usage: 280MB

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:456:15)

    console.log
      ‚úÖ All security scenarios tested

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:481:15)

    console.log
         Security tests: 10

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:482:15)

    console.log
         ‚úì sql-injection-prevention

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì xss-protection

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì csrf-token-validation

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì session-hijacking-prevention

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì privilege-escalation-prevention

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì unauthorized-api-access

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì input-validation

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì output-sanitization

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì rate-limiting

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
         ‚úì audit-trail-integrity

      at __tests__/e2e/run-e2e-workflows.test.ts:484:17
          at Array.forEach (<anonymous>)

    console.log
      Cleaning up E2E workflow test environment...

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:28:13)

    console.log
      Test environment cleanup complete

      at Object.<anonymous> (__tests__/e2e/run-e2e-workflows.test.ts:32:15)

FAIL e2e __tests__/e2e/permission-workflows.test.tsx
  ‚óè Test suite failed to run

    Cannot find module '../helpers/permission-test-utils' from '__tests__/e2e/permission-workflows.test.tsx'

       9 | import { SessionProvider } from 'next-auth/react'
      10 | import { PermissionProvider } from '../../app/components/providers/PermissionProvider'
    > 11 | import { createMockSession } from '../helpers/permission-test-utils'
         | ^
      12 | import { UserRole } from '../../app/lib/types'
      13 | import React from 'react'
      14 | import Link from 'next/link'

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/e2e/permission-workflows.test.tsx:11:1)

FAIL e2e __tests__/e2e/form-interaction-workflows.test.tsx
  ‚óè Test suite failed to run

    Configuration error:

    Could not locate module @/app/components/providers/PermissionProvider mapped as:
    /Users/teroleinonen/software projects/cms-admin/app/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^@\/(.*)$/": "/Users/teroleinonen/software projects/cms-admin/app/$1"
      },
      "resolver": undefined
    }

       8 | import { render, screen, fireEvent, waitFor } from '@testing-library/react'
       9 | import { SessionProvider } from 'next-auth/react'
    > 10 | import { PermissionProvider } from '@/app/components/providers/PermissionProvider'
         | ^
      11 | import { createMockSession } from '@/__tests__/helpers/permission-test-utils'
      12 | import { UserRole } from '@/app/lib/types'
      13 | import React from 'react'

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:1117:17)
      at Object.<anonymous> (__tests__/e2e/form-interaction-workflows.test.tsx:10:1)

FAIL e2e __tests__/e2e/navigation-permission-workflows.test.tsx
  ‚óè Test suite failed to run

    Configuration error:

    Could not locate module @/app/components/providers/PermissionProvider mapped as:
    /Users/teroleinonen/software projects/cms-admin/app/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^@\/(.*)$/": "/Users/teroleinonen/software projects/cms-admin/app/$1"
      },
      "resolver": undefined
    }

       8 | import { render, screen, fireEvent, waitFor } from '@testing-library/react'
       9 | import { SessionProvider } from 'next-auth/react'
    > 10 | import { PermissionProvider } from '@/app/components/providers/PermissionProvider'
         | ^
      11 | import { createMockSession } from '@/__tests__/helpers/permission-test-utils'
      12 | import { UserRole } from '@/app/lib/types'
      13 | import React from 'react'

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:1117:17)
      at Object.<anonymous> (__tests__/e2e/navigation-permission-workflows.test.tsx:10:1)

FAIL e2e __tests__/e2e/cross-browser-mobile-workflows.test.tsx
  ‚óè Test suite failed to run

    Cannot find module '../helpers/permission-test-utils' from '__tests__/e2e/cross-browser-mobile-workflows.test.tsx'

       9 | import { SessionProvider } from 'next-auth/react'
      10 | import { PermissionProvider } from '../../app/components/providers/PermissionProvider'
    > 11 | import { createMockSession } from '../helpers/permission-test-utils'
         | ^
      12 | import { UserRole } from '../../app/lib/types'
      13 | import React from 'react'
      14 |

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at Object.<anonymous> (__tests__/e2e/cross-browser-mobile-workflows.test.tsx:11:1)

FAIL e2e __tests__/e2e/api-permission-workflows.test.ts
  ‚óè Test suite failed to run

    Configuration error:

    Could not locate module @/__tests__/helpers/permission-test-utils mapped as:
    /Users/teroleinonen/software projects/cms-admin/app/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^@\/(.*)$/": "/Users/teroleinonen/software projects/cms-admin/app/$1"
      },
      "resolver": undefined
    }

       7 |
       8 | import { NextRequest } from 'next/server'
    >  9 | import { createMockSession } from '@/__tests__/helpers/permission-test-utils'
         | ^
      10 | import { UserRole } from '@/app/lib/types'
      11 |
      12 | // Mock API handlers for testing

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:1117:17)
      at Object.<anonymous> (__tests__/e2e/api-permission-workflows.test.ts:9:1)

FAIL integration __tests__/integration/specialized-guards-integration.test.tsx (5.869 s)
  ‚óè Specialized Guards Integration ‚Ä∫ Complex Permission Scenarios ‚Ä∫ handles nested guard components correctly

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      52 |       mockUsePermissions.mockReturnValue(adminPermissions as any)
      53 |
    > 54 |       render(
         |             ^
      55 |         <AdminOnly>
      56 |           <div data-testid="admin-content">
      57 |             <OwnerOrAdmin resourceOwnerId="other-user">

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:54:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Complex Permission Scenarios ‚Ä∫ blocks access when any guard fails in nested structure

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      75 |       mockUsePermissions.mockReturnValue(editorPermissions as any)
      76 |
    > 77 |       render(
         |             ^
      78 |         <AdminOnly fallback={<div data-testid="admin-blocked">Admin required</div>}>
      79 |           <div data-testid="admin-content">
      80 |             <OwnerOrAdmin resourceOwnerId="other-user">

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:77:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Complex Permission Scenarios ‚Ä∫ handles owner access with feature flags

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      94 |       mockUsePermissions.mockReturnValue(editorPermissions as any)
      95 |
    > 96 |       render(
         |             ^
      97 |         <OwnerOrAdmin resourceOwnerId="owner-user">
      98 |           <FeatureFlag 
      99 |             feature="owner-features" 

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:96:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Complex Permission Scenarios ‚Ä∫ blocks when feature flag fails even with ownership

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      114 |       mockUsePermissions.mockReturnValue(editorPermissions as any)
      115 |
    > 116 |       render(
          |             ^
      117 |         <OwnerOrAdmin resourceOwnerId="owner-user">
      118 |           <FeatureFlag 
      119 |             feature="disabled-feature" 

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:116:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Role Hierarchy Integration ‚Ä∫ admin can access all content regardless of ownership

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      136 |       mockUsePermissions.mockReturnValue(adminPermissions as any)
      137 |
    > 138 |       render(
          |             ^
      139 |         <div>
      140 |           <AdminOnly>
      141 |             <div data-testid="admin-only">Admin Only Content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:138:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Role Hierarchy Integration ‚Ä∫ editor has limited access based on ownership and features

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      163 |       mockUsePermissions.mockReturnValue(editorPermissions as any)
      164 |
    > 165 |       render(
          |             ^
      166 |         <div>
      167 |           <AdminOnly fallback={<div data-testid="admin-blocked">No admin access</div>}>
      168 |             <div data-testid="admin-only">Admin Only Content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:165:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Role Hierarchy Integration ‚Ä∫ viewer has most limited access

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      199 |       mockUsePermissions.mockReturnValue(viewerPermissions as any)
      200 |
    > 201 |       render(
          |             ^
      202 |         <div>
      203 |           <AdminOnly fallback={<div data-testid="admin-blocked">No admin access</div>}>
      204 |             <div data-testid="admin-only">Admin Only Content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:201:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Error Handling Integration ‚Ä∫ handles authentication errors gracefully across all guards

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      244 |       } as any)
      245 |
    > 246 |       render(
          |             ^
      247 |         <div>
      248 |           <AdminOnly showError>
      249 |             <div data-testid="admin-content">Admin Content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:246:13)

  ‚óè Specialized Guards Integration ‚Ä∫ Error Handling Integration ‚Ä∫ handles loading states consistently

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      279 |       } as any)
      280 |
    > 281 |       render(
          |             ^
      282 |         <div>
      283 |           <AdminOnly>
      284 |             <div data-testid="admin-content">Admin Content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/specialized-guards-integration.test.tsx:281:13)

FAIL integration __tests__/integration/permission-system.test.ts (5.799 s)
  ‚óè Console

    console.error
      Error creating security event: TypeError: Cannot read properties of undefined (reading 'auditLog')
          at SecurityEventDB.create (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-db.ts:202:33)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/integration/permission-system.test.ts:216:45)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at SecurityEventDB.create (app/lib/permission-db.ts:218:15)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:216:45)

    console.error
      Error recording role change: TypeError: Cannot read properties of undefined (reading 'auditLog')
          at RoleChangeHistoryDB.recordChange (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-db.ts:392:33)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/integration/permission-system.test.ts:254:50)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at RoleChangeHistoryDB.recordChange (app/lib/permission-db.ts:408:15)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:254:50)

    console.error
      Error getting user role history: TypeError: Cannot read properties of undefined (reading 'auditLog')
          at RoleChangeHistoryDB.getUserHistory (/Users/teroleinonen/software projects/cms-admin/app/lib/permission-db.ts:418:32)
          at Object.<anonymous> (/Users/teroleinonen/software projects/cms-admin/__tests__/integration/permission-system.test.ts:292:49)
          at Promise.finally.completed (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
          at _callCircusTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
          at _runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
          at /Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
          at run (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
          at jestAdapter (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-circus/build/runner.js:101:19)
          at runTestInternal (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:275:16)
          at runTest (/Users/teroleinonen/software projects/cms-admin/node_modules/jest-runner/build/index.js:343:7)

      340 |     createApiErrorResponse: jest.fn().mockImplementation((error, status = 400) => ({
      341 |       status,
    > 342 |       json: () => Promise.resolve({ success: false, error }),
          |     ^
      343 |     })),
      344 |   }
      345 | })

      at console.error (__tests__/helpers/test-helpers.ts:342:5)
      at RoleChangeHistoryDB.getUserHistory (app/lib/permission-db.ts:456:15)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:292:49)

  ‚óè Permission System Integration ‚Ä∫ Permission Service with Database Cache ‚Ä∫ should check permissions and cache results in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"where": {"userId_resource_action_scope": {"action": "create", "resource": "products", "scope": null, "userId": "editor-123"}}}

    Number of calls: 0

       96 |       
       97 |       // Should have tried to get from database cache
    >  98 |       expect(mockPrisma.permissionCache.findUnique).toHaveBeenCalledWith({
          |                                                     ^
       99 |         where: {
      100 |           userId_resource_action_scope: {
      101 |             userId: 'editor-123',

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:98:53)

  ‚óè Permission System Integration ‚Ä∫ Permission Service with Database Cache ‚Ä∫ should use cached results from database

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      127 |       const result = await permissionService.hasPermission(user, permission);
      128 |
    > 129 |       expect(result).toBe(false);
          |                      ^
      130 |       
      131 |       // Should not have computed permission (used cache)
      132 |       expect(mockPrisma.permissionCache.upsert).not.toHaveBeenCalled();

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:129:22)

  ‚óè Permission System Integration ‚Ä∫ Permission Service with Database Cache ‚Ä∫ should handle expired cache entries

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      157 |       
      158 |       // Should have deleted expired entry
    > 159 |       expect(mockPrisma.permissionCache.delete).toHaveBeenCalled();
          |                                                 ^
      160 |       
      161 |       // Should have computed and cached new result
      162 |       expect(mockPrisma.permissionCache.upsert).toHaveBeenCalled();

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:159:49)

  ‚óè Permission System Integration ‚Ä∫ Cache Invalidation Integration ‚Ä∫ should invalidate cache when user role changes

    TypeError: cacheInvalidationService.onUserRoleChange is not a function

      174 |       const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      175 |
    > 176 |       await cacheInvalidationService.onUserRoleChange(userId, UserRole.VIEWER, UserRole.EDITOR);
          |                                      ^
      177 |
      178 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
      179 |         where: { userId }

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:176:38)

  ‚óè Permission System Integration ‚Ä∫ Cache Invalidation Integration ‚Ä∫ should invalidate resource cache when permissions are updated

    TypeError: cacheInvalidationService.onPermissionUpdate is not a function

      194 |       const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
      195 |
    > 196 |       await cacheInvalidationService.onPermissionUpdate(resource);
          |                                      ^
      197 |
      198 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
      199 |         where: { resource }

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:196:38)

  ‚óè Permission System Integration ‚Ä∫ Security Event Integration ‚Ä∫ should create security events for permission violations

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      200 |   }): Promise<string> {
      201 |     try {
    > 202 |       const auditLog = await db.auditLog.create({
          |                                 ^
      203 |         data: {
      204 |           userId: event.userId || 'system',
      205 |           action: `SECURITY_EVENT_${event.type}`,

      at SecurityEventDB.create (app/lib/permission-db.ts:202:33)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:216:45)

  ‚óè Permission System Integration ‚Ä∫ Role Change History Integration ‚Ä∫ should record role changes with proper audit trail

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      390 |   ): Promise<string> {
      391 |     try {
    > 392 |       const auditLog = await db.auditLog.create({
          |                                 ^
      393 |         data: {
      394 |           userId: changedBy || 'system',
      395 |           action: 'ROLE_CHANGE',

      at RoleChangeHistoryDB.recordChange (app/lib/permission-db.ts:392:33)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:254:50)

  ‚óè Permission System Integration ‚Ä∫ Role Change History Integration ‚Ä∫ should retrieve user role change history

    TypeError: Cannot read properties of undefined (reading 'auditLog')

      416 |   static async getUserHistory(userId: string, limit: number = 50) {
      417 |     try {
    > 418 |       const history = await db.auditLog.findMany({
          |                                ^
      419 |         where: {
      420 |           action: 'ROLE_CHANGE',
      421 |           details: {

      at RoleChangeHistoryDB.getUserHistory (app/lib/permission-db.ts:418:32)
      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:292:49)

  ‚óè Permission System Integration ‚Ä∫ Database Cache Performance ‚Ä∫ should provide cache statistics

    expect(received).toEqual(expected) // deep equality

    - Expected  - 16
    + Received  +  3

      Object {
    -   "expiredEntries": 25,
    -   "totalEntries": 150,
    -   "userCounts": Array [
    -     Object {
    -       "count": 50,
    -       "userId": "user-1",
    -     },
    -     Object {
    -       "count": 30,
    -       "userId": "user-2",
    -     },
    -     Object {
    -       "count": 20,
    -       "userId": "user-3",
    -     },
    -   ],
    +   "expiredEntries": 0,
    +   "totalEntries": 0,
    +   "userCounts": Array [],
      }

      319 |       const stats = await dbCache.getStats();
      320 |
    > 321 |       expect(stats).toEqual({
          |                     ^
      322 |         totalEntries: 150,
      323 |         expiredEntries: 25,
      324 |         userCounts: [

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:321:21)

  ‚óè Permission System Integration ‚Ä∫ Database Cache Performance ‚Ä∫ should clean up expired entries

    expect(received).toBe(expected) // Object.is equality

    Expected: 15
    Received: 0

      335 |       const removedCount = await dbCache.cleanupExpired();
      336 |
    > 337 |       expect(removedCount).toBe(15);
          |                            ^
      338 |       expect(mockPrisma.permissionCache.deleteMany).toHaveBeenCalledWith({
      339 |         where: {
      340 |           expiresAt: {

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:337:28)

  ‚óè Permission System Integration ‚Ä∫ End-to-End Permission Flow ‚Ä∫ should handle complete permission check with caching and audit

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      361 |
      362 |       // Verify cache was checked and updated
    > 363 |       expect(mockPrisma.permissionCache.findUnique).toHaveBeenCalled();
          |                                                     ^
      364 |       expect(mockPrisma.permissionCache.upsert).toHaveBeenCalled();
      365 |
      366 |       // Simulate a role change

      at Object.<anonymous> (__tests__/integration/permission-system.test.ts:363:53)

FAIL integration __tests__/integration/permission-error-handling.test.tsx (8.056 s)
  ‚óè Permission Error Handling Integration ‚Ä∫ RoleGuard with Error Boundary ‚Ä∫ shows unauthorized fallback when access is denied

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      64 |   describe('RoleGuard with Error Boundary', () => {
      65 |     it('shows unauthorized fallback when access is denied', () => {
    > 66 |       render(
         |             ^
      67 |         <TestWrapper>
      68 |           <RoleGuard requiredRole="ADMIN">
      69 |             <div>Protected content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:66:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ RoleGuard with Error Boundary ‚Ä∫ shows loading state during permission checks

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      85 |       })
      86 |
    > 87 |       render(
         |             ^
      88 |         <TestWrapper>
      89 |           <RoleGuard requiredRole="ADMIN">
      90 |             <div>Protected content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:87:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ RoleGuard with Error Boundary ‚Ä∫ shows detailed error information when enabled

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

       98 |
       99 |     it('shows detailed error information when enabled', () => {
    > 100 |       render(
          |             ^
      101 |         <TestWrapper>
      102 |           <RoleGuard 
      103 |             requiredRole="ADMIN" 

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:100:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ RoleGuard with Error Boundary ‚Ä∫ provides action buttons for navigation

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      114 |
      115 |     it('provides action buttons for navigation', () => {
    > 116 |       render(
          |             ^
      117 |         <TestWrapper>
      118 |           <RoleGuard requiredRole="ADMIN">
      119 |             <div>Protected content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:116:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ PermissionGate with Error Boundary ‚Ä∫ shows permission denied fallback for insufficient permissions

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      129 |   describe('PermissionGate with Error Boundary', () => {
      130 |     it('shows permission denied fallback for insufficient permissions', () => {
    > 131 |       render(
          |             ^
      132 |         <TestWrapper>
      133 |           <PermissionGate resource="products" action="create">
      134 |             <div>Create product form</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:131:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ PermissionGate with Error Boundary ‚Ä∫ shows authentication required for unauthenticated users

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      150 |       })
      151 |
    > 152 |       render(
          |             ^
      153 |         <TestWrapper>
      154 |           <PermissionGate resource="products" action="read">
      155 |             <div>Product list</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:152:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ ConditionalRender with Error Boundary ‚Ä∫ shows fallback when condition is not met

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      167 |       const condition = jest.fn(() => false)
      168 |
    > 169 |       render(
          |             ^
      170 |         <TestWrapper>
      171 |           <ConditionalRender condition={condition}>
      172 |             <div>Conditional content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:169:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ ConditionalRender with Error Boundary ‚Ä∫ renders content when condition is met

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      182 |       const condition = jest.fn(() => true)
      183 |
    > 184 |       render(
          |             ^
      185 |         <TestWrapper>
      186 |           <ConditionalRender condition={condition}>
      187 |             <div>Conditional content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:184:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ Error Boundary Integration ‚Ä∫ catches errors thrown by child components

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      200 |       }
      201 |
    > 202 |       render(
          |             ^
      203 |         <TestWrapper>
      204 |           <RoleGuard requiredRole="VIEWER" enableErrorBoundary={true}>
      205 |             <ErrorComponent />

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:202:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ Error Boundary Integration ‚Ä∫ can be disabled to allow errors to bubble up

    expect(received).toThrow(expected)

    Expected substring: "Test error"
    Received message:   "document is not defined"

          219 |       // This should throw since error boundary is disabled
          220 |       expect(() => {
        > 221 |         render(
              |               ^
          222 |           <TestWrapper>
          223 |             <RoleGuard requiredRole="VIEWER" enableErrorBoundary={false}>
          224 |               <ErrorComponent />

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at __tests__/integration/permission-error-handling.test.tsx:221:15
      at Object.<anonymous> (node_modules/expect/build/index.js:1824:9)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:2235:93)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:228:10)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:228:10)

  ‚óè Permission Error Handling Integration ‚Ä∫ Loading State Integration ‚Ä∫ shows context-appropriate loading messages

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      239 |       })
      240 |
    > 241 |       render(
          |             ^
      242 |         <TestWrapper>
      243 |           <PermissionGate 
      244 |             resource="products" 

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:241:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ Loading State Integration ‚Ä∫ handles loading timeouts

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      265 |       })
      266 |
    > 267 |       render(
          |             ^
      268 |         <TestWrapper>
      269 |           <PermissionGate 
      270 |             resource="products" 

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:267:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ Accessibility Integration ‚Ä∫ maintains proper ARIA attributes across components

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      290 |   describe('Accessibility Integration', () => {
      291 |     it('maintains proper ARIA attributes across components', () => {
    > 292 |       render(
          |             ^
      293 |         <TestWrapper>
      294 |           <RoleGuard requiredRole="ADMIN">
      295 |             <div>Protected content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:292:13)

  ‚óè Permission Error Handling Integration ‚Ä∫ Accessibility Integration ‚Ä∫ provides proper loading state accessibility

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      315 |       })
      316 |
    > 317 |       render(
          |             ^
      318 |         <TestWrapper>
      319 |           <RoleGuard requiredRole="ADMIN">
      320 |             <div>Protected content</div>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (__tests__/integration/permission-error-handling.test.tsx:317:13)

FAIL integration __tests__/integration/authentication-flow-integration.test.ts (6.06 s)
  ‚óè Authentication Flow Integration Tests ‚Ä∫ Login Flow Integration ‚Ä∫ should handle complete login flow with session creation and audit logging

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      51 |     ApiTestSetup.initializeAll();
      52 |     auditService = new AuditService(prisma);
    > 53 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      54 |   });
      55 |
      56 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/authentication-flow-integration.test.ts:53:33)

  ‚óè Authentication Flow Integration Tests ‚Ä∫ Login Flow Integration ‚Ä∫ should handle failed login attempts with security monitoring

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      51 |     ApiTestSetup.initializeAll();
      52 |     auditService = new AuditService(prisma);
    > 53 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      54 |   });
      55 |
      56 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/authentication-flow-integration.test.ts:53:33)

  ‚óè Authentication Flow Integration Tests ‚Ä∫ Session Management Integration ‚Ä∫ should handle session validation and renewal

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      51 |     ApiTestSetup.initializeAll();
      52 |     auditService = new AuditService(prisma);
    > 53 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      54 |   });
      55 |
      56 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/authentication-flow-integration.test.ts:53:33)

  ‚óè Authentication Flow Integration Tests ‚Ä∫ Session Management Integration ‚Ä∫ should handle logout with session cleanup

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      51 |     ApiTestSetup.initializeAll();
      52 |     auditService = new AuditService(prisma);
    > 53 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      54 |   });
      55 |
      56 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/authentication-flow-integration.test.ts:53:33)

FAIL integration __tests__/integration/middleware-integration.test.ts
  ‚óè Console

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/123",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.551Z",
        "requestId": "req_1763408036551_f62s6rj5a",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:225:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/security/events",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.582Z",
        "requestId": "req_1763408036582_cyr0xbdh2",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:225:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/backup/status/456",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.583Z",
        "requestId": "req_1763408036583_vsfotkkez",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:225:26)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.591Z",
        "requestId": "req_1763408036588_sfpddsyur",
        "method": "POST"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:251:24)

    console.warn
      IP 127.0.0.1 auto-blocked due to repeated rate limit violations

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at rateLimit (app/lib/rate-limit.ts:134:15)
      at middleware (middleware.ts:149:42)
      at __tests__/integration/middleware-integration.test.ts:281:43
          at Array.map (<anonymous>)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:281:18)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/0",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.604Z",
        "requestId": "req_1763408036601_8azbej7dk",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 0)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/1",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.623Z",
        "requestId": "req_1763408036603_3ku6b331d",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 1)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/2",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.629Z",
        "requestId": "req_1763408036604_cw6x7ut8u",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 2)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/3",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.629Z",
        "requestId": "req_1763408036604_xwmokix76",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 3)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/4",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.629Z",
        "requestId": "req_1763408036604_h4mzx9162",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 4)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/5",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.629Z",
        "requestId": "req_1763408036604_6si9jpon8",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 5)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/6",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.630Z",
        "requestId": "req_1763408036604_rcqs4x9o4",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 6)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/7",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.631Z",
        "requestId": "req_1763408036604_k5btbwue8",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 7)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/8",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.631Z",
        "requestId": "req_1763408036604_fhskkjv3l",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 8)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/api/admin/users/9",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.631Z",
        "requestId": "req_1763408036604_kbc83w90a",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
          at async Promise.all (index 9)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:280:25)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.636Z",
        "requestId": "req_1763408036635_oxff23g4f",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:298:24)

    console.warn
      [SECURITY] RATE_LIMITED: {
        "userId": "anonymous",
        "userRole": "none",
        "pathname": "/admin/users",
        "result": "RATE_LIMITED",
        "reason": "rate_limit_exceeded_300s",
        "ipAddress": "unknown",
        "userAgent": "unknown",
        "timestamp": "2025-11-17T19:33:56.640Z",
        "requestId": "req_1763408036639_kq5a7bd9b",
        "method": "GET"
      }

      347 | // Mock environment variables
      348 | process.env.NEXTAUTH_SECRET = 'test-secret'
    > 349 | process.env.NODE_ENV = 'test'
          |     ^
      350 |
      351 | // Mock ResizeObserver for HeadlessUI components
      352 | global.ResizeObserver = jest.fn().mockImplementation(() => ({

      at console.warn (__tests__/helpers/test-helpers.ts:349:5)
      at logSecurityEvent (middleware.ts:72:15)
      at middleware (middleware.ts:152:11)
      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:311:24)

  ‚óè Middleware Integration Tests ‚Ä∫ API Route Protection ‚Ä∫ should protect admin API routes from unauthorized users

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      55 |       const response = await middleware(request)
      56 |       
    > 57 |       expect(response.status).toBe(401)
         |                               ^
      58 |       
      59 |       const body = await response.json()
      60 |       expect(body.error.code).toBe('UNAUTHORIZED')

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:57:31)

  ‚óè Middleware Integration Tests ‚Ä∫ API Route Protection ‚Ä∫ should protect admin API routes from insufficient permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      69 |       const response = await middleware(request)
      70 |       
    > 71 |       expect(response.status).toBe(403)
         |                               ^
      72 |       
      73 |       const body = await response.json()
      74 |       expect(body.error.code).toBe('FORBIDDEN')

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:71:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Web Route Protection ‚Ä∫ should redirect unauthorized users to login

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      117 |       const response = await middleware(request)
      118 |       
    > 119 |       expect(response.status).toBe(307) // Redirect
          |                               ^
      120 |       expect(response.headers.get('location')).toContain('/auth/login')
      121 |       expect(response.headers.get('location')).toContain('callbackUrl=%2Fadmin%2Fproducts')
      122 |     })

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:119:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Web Route Protection ‚Ä∫ should redirect users with insufficient permissions

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      129 |       const response = await middleware(request)
      130 |       
    > 131 |       expect(response.status).toBe(307) // Redirect
          |                               ^
      132 |       expect(response.headers.get('location')).toContain('error=forbidden')
      133 |     })
      134 |

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:131:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Security Logging Integration ‚Ä∫ should log all access attempts with proper context

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] SUCCESS:", StringMatching /"userId":\s*"user-1"/

    Number of calls: 0

      157 |       await middleware(request)
      158 |       
    > 159 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      160 |         '[ACCESS_LOG] SUCCESS:',
      161 |         expect.stringMatching(/"userId":\s*"user-1"/)
      162 |       )

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:159:29)

  ‚óè Middleware Integration Tests ‚Ä∫ Security Logging Integration ‚Ä∫ should log security violations with detailed information

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[ACCESS_LOG] FORBIDDEN:", StringMatching /"result":\s*"FORBIDDEN"/

    Number of calls: 0

      180 |       await middleware(request)
      181 |       
    > 182 |       expect(consoleLogSpy).toHaveBeenCalledWith(
          |                             ^
      183 |         '[ACCESS_LOG] FORBIDDEN:',
      184 |         expect.stringMatching(/"result":\s*"FORBIDDEN"/)
      185 |       )

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:182:29)

  ‚óè Middleware Integration Tests ‚Ä∫ Error Handling Integration ‚Ä∫ should handle authentication errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 200

      238 |       const response = await middleware(request)
      239 |       
    > 240 |       expect(response.status).toBe(307) // Redirect to login
          |                               ^
      241 |       expect(consoleErrorSpy).toHaveBeenCalledWith(
      242 |         'Failed to get token:',
      243 |         expect.any(Error)

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:240:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Error Handling Integration ‚Ä∫ should provide helpful error messages in API responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 429

      251 |       const response = await middleware(request)
      252 |       
    > 253 |       expect(response.status).toBe(401)
          |                               ^
      254 |       
      255 |       const body = await response.json()
      256 |       expect(body).toEqual({

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:253:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Performance and Edge Cases ‚Ä∫ should handle malformed tokens gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      298 |       const response = await middleware(request)
      299 |       
    > 300 |       expect(response.status).toBe(307) // Should redirect due to insufficient permissions
          |                               ^
      301 |     })
      302 |
      303 |     it('should handle empty or null user IDs', async () => {

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:300:31)

  ‚óè Middleware Integration Tests ‚Ä∫ Performance and Edge Cases ‚Ä∫ should handle empty or null user IDs

    expect(received).toBe(expected) // Object.is equality

    Expected: 307
    Received: 429

      311 |       const response = await middleware(request)
      312 |       
    > 313 |       expect(response.status).toBe(307) // Should redirect due to invalid user
          |                               ^
      314 |     })
      315 |   })
      316 | })

      at Object.<anonymous> (__tests__/integration/middleware-integration.test.ts:313:31)

FAIL integration __tests__/integration/audit-logging-integration.test.ts
  ‚óè Audit Logging Integration Tests ‚Ä∫ Basic Audit Logging ‚Ä∫ should create comprehensive audit logs for user actions

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Basic Audit Logging ‚Ä∫ should log failed operations with error details

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Security Event Logging ‚Ä∫ should create security events for permission violations

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Security Event Logging ‚Ä∫ should log role escalation attempts

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Audit Log Querying and Analysis ‚Ä∫ should retrieve audit logs with filtering and pagination

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Audit Log Querying and Analysis ‚Ä∫ should generate audit statistics and reports

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Compliance and Reporting ‚Ä∫ should generate compliance reports with detailed audit trails

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Compliance and Reporting ‚Ä∫ should export audit logs in different formats

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Log Retention and Cleanup ‚Ä∫ should clean up old audit logs based on retention policy

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

  ‚óè Audit Logging Integration Tests ‚Ä∫ Log Retention and Cleanup ‚Ä∫ should validate audit log integrity

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      67 |     ApiTestSetup.initializeAll();
      68 |     auditService = new AuditService(prisma);
    > 69 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      70 |   });
      71 |
      72 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/audit-logging-integration.test.ts:69:33)

FAIL integration __tests__/integration/api-integration-comprehensive.test.ts
  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Database Integration - User Management API ‚Ä∫ should handle GET request with database integration and audit logging

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Database Integration - User Management API ‚Ä∫ should handle POST request with database transaction and audit logging

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Database Integration - User Management API ‚Ä∫ should deny access for insufficient permissions and log security event

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Authentication Flow Integration ‚Ä∫ should handle complete authentication flow with session management

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Authentication Flow Integration ‚Ä∫ should handle expired token and log security event

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Authentication Flow Integration ‚Ä∫ should handle invalid token and create security alert

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Audit Logging Integration ‚Ä∫ should create comprehensive audit logs for CRUD operations

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Audit Logging Integration ‚Ä∫ should log permission check failures with detailed context

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Audit Logging Integration ‚Ä∫ should aggregate audit logs for security analysis

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Audit Logging Integration ‚Ä∫ should handle audit log retention and cleanup

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Permission Cache Integration ‚Ä∫ should use database permission cache for performance

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Permission Cache Integration ‚Ä∫ should invalidate cache on role changes

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Security Event Integration ‚Ä∫ should create security events for suspicious activities

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Security Event Integration ‚Ä∫ should handle concurrent requests and maintain data integrity

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Error Handling and Recovery ‚Ä∫ should handle database connection failures gracefully

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

  ‚óè API Integration Tests - Comprehensive ‚Ä∫ Error Handling and Recovery ‚Ä∫ should maintain audit trail even during partial failures

    TypeError: api_permission_test_utils_1.TestUserFactory.createUserSet is not a function

      80 |     auditService = new AuditService(prisma);
      81 |     permissionService = new EnhancedPermissionService();
    > 82 |     testUsers = TestUserFactory.createUserSet();
         |                                 ^
      83 |   });
      84 |
      85 |   beforeEach(() => {

      at Object.<anonymous> (__tests__/integration/api-integration-comprehensive.test.ts:82:33)

PASS unit-components __tests__/unit/ui/Input.test.tsx
PASS unit-components __tests__/unit/ui/Button.test.tsx
PASS unit-components __tests__/unit/ui/Badge.test.tsx
